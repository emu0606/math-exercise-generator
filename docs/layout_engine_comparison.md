# ä½ˆå±€å¼•æ“æ–°èˆŠç‰ˆæœ¬æ¯”è¼ƒåˆ†æ

> **åˆ†ææ—¥æœŸ**: 2025-09-12  
> **æ¯”è¼ƒç¯„åœ**: utils/core/layout.py vs docs/old_source/utils/layout_engine.py  
> **ç›®çš„**: è©•ä¼°ä½ˆå±€å¼•æ“çš„æ¶æ§‹æ¼”é€²å’ŒåŠŸèƒ½æ”¹é€²

## ğŸ“‹ **æ¶æ§‹å°æ¯”ç¸½è¦½**

### **æ–‡ä»¶çµæ§‹è®ŠåŒ–**

**èˆŠç‰ˆ (layout_engine.py):**
```python
# 210è¡Œï¼Œå–®ä¸€é¡åˆ¥è¨­è¨ˆ
class LayoutEngine:
    def __init__(self): ...                    # ç°¡å–®åˆå§‹åŒ–
    def layout(self, questions, questions_per_round): ...  # æ ¸å¿ƒä½ˆå±€æ–¹æ³• (120è¡Œ)
    def can_place_at(self, ...): ...          # ä½ç½®æª¢æŸ¥æ–¹æ³• (24è¡Œ)
```

**æ–°ç‰ˆ (layout.py):**
```python
# 563è¡Œï¼Œå¤šé¡åˆ¥æ¨¡çµ„åŒ–è¨­è¨ˆ
class QuestionSize(IntEnum): ...           # å°ºå¯¸å®šç¾© (18è¡Œ)
class LayoutError(Exception): ...          # å°ˆç”¨ç•°å¸¸ (5è¡Œ)
class GridManager: ...                     # ç¶²æ ¼ç®¡ç†å™¨ (120è¡Œ)
class PlacementStrategy: ...               # ç­–ç•¥åŸºé¡ (15è¡Œ)
class TopLeftStrategy(PlacementStrategy): ...     # å·¦ä¸Šç­–ç•¥ (18è¡Œ)
class CompactStrategy(PlacementStrategy): ...     # ç·Šæ¹Šç­–ç•¥ (27è¡Œ)
class LayoutEngine: ...                    # ä¸»è¦å¼•æ“ (320è¡Œ)
```

### **æ ¸å¿ƒè®ŠåŒ–ç‰¹é»**

| æ–¹é¢ | èˆŠç‰ˆ | æ–°ç‰ˆ | è®ŠåŒ–è©•ä¼° |
|------|------|------|----------|
| **æ¶æ§‹é¢¨æ ¼** | å–®é«”é¡åˆ¥ | æ¨¡çµ„åŒ–è¨­è¨ˆ | âœ… **é‡å¤§æ”¹é€²** |
| **ä»£ç¢¼è¡Œæ•¸** | 210è¡Œ | 563è¡Œ (2.7x) | âš ï¸ **è†¨è„¹é¡¯è‘—** |
| **è¨­è¨ˆæ¨¡å¼** | ç¨‹åºå¼ | ç­–ç•¥æ¨¡å¼+çµ„åˆæ¨¡å¼ | âœ… **æ›´å°ˆæ¥­** |
| **éŒ¯èª¤è™•ç†** | ç°¡å–®ç•°å¸¸ | å°ˆç”¨ç•°å¸¸ç³»çµ± | âœ… **æ›´å¥½** |
| **å¯æ“´å±•æ€§** | å›ºåŒ–é‚è¼¯ | ç­–ç•¥å¯æ’æ‹” | âœ… **æ›´éˆæ´»** |
| **æ—¥èªŒç³»çµ±** | ç°¡å–®print | å®Œæ•´æ—¥èªŒæ¡†æ¶ | âœ… **æ›´å°ˆæ¥­** |

---

## ğŸ” **è©³ç´°åŠŸèƒ½æ¯”è¼ƒ**

### **1. åˆå§‹åŒ–å’Œé…ç½®**

#### **èˆŠç‰ˆè¨­è¨ˆ**:
```python
class LayoutEngine:
    def __init__(self):
        self.grid_width = 4  # ç¡¬ç·¨ç¢¼
        self.grid_height = 8  # ç¡¬ç·¨ç¢¼
        self.size_map = { ... }  # å›ºå®šæ˜ å°„
```

**ç‰¹é»**: 
- âœ… ç°¡æ½”ç›´æ¥
- âŒ ç„¡æ³•é…ç½®ç¶²æ ¼å¤§å°
- âŒ ç¡¬ç·¨ç¢¼åƒæ•¸

#### **æ–°ç‰ˆè¨­è¨ˆ**:
```python
class LayoutEngine:
    def __init__(self, grid_width: int = 4, grid_height: int = 8, 
                 placement_strategy: Optional[PlacementStrategy] = None):
        self.grid_width = grid_width
        self.grid_height = grid_height
        self.placement_strategy = placement_strategy or CompactStrategy()
        self.grid_manager = GridManager(grid_width, grid_height)
```

**ç‰¹é»**:
- âœ… å¯é…ç½®ç¶²æ ¼å°ºå¯¸
- âœ… å¯æ’æ‹”ç­–ç•¥ç³»çµ±
- âœ… ä¾è³´æ³¨å…¥è¨­è¨ˆ
- âŒ è¤‡é›œåº¦å¢åŠ 

### **2. æ ¸å¿ƒä½ˆå±€ç®—æ³•æ¯”è¼ƒ**

#### **èˆŠç‰ˆç®—æ³•é‚è¼¯**:
```python
# ç›´æ¥åœ¨ä¸»æ–¹æ³•ä¸­å¯¦ç¾æ‰€æœ‰é‚è¼¯
def layout(self, questions, questions_per_round=0):
    # 120è¡Œçš„å·¨å¤§æ–¹æ³•
    grids = {current_page: [[False for _ in range(4)] for _ in range(8)]}
    
    for i, question in enumerate(questions):
        # å…§åµŒçš„å°ºå¯¸è™•ç†
        size = question.get('size', 1)
        width_cells, height_cells = self.size_map.get(size, (1, 1))
        
        # å…§åµŒçš„æ”¾ç½®é‚è¼¯
        placed = False
        if height_cells == 1:  # å„ªå…ˆæ”¾ç½®é«˜åº¦ç‚º1çš„æ ¼å­
            for row in range(self.grid_height - height_cells + 1):
                # åµŒå¥—çš„ä½ç½®æœå°‹é‚è¼¯...
        
        # å…§åµŒçš„æ›é é‚è¼¯
        if not placed:
            current_page += 1
            grids[current_page] = [[False...]]
```

**å•é¡Œåˆ†æ**:
- âŒ **å–®ä¸€è·è²¬é•å**: ä¸€å€‹æ–¹æ³•æ‰¿æ“”éå¤šè²¬ä»»
- âŒ **å¯è®€æ€§å·®**: å¤§é‡åµŒå¥—é‚è¼¯
- âŒ **ä¸æ˜“æ¸¬è©¦**: ç„¡æ³•å–®ç¨æ¸¬è©¦å„å€‹çµ„ä»¶
- âŒ **é‡è¤‡ä»£ç¢¼**: ç›¸åŒçš„æ”¾ç½®é‚è¼¯é‡è¤‡å¤šæ¬¡

#### **æ–°ç‰ˆç®—æ³•é‚è¼¯**:
```python
# è·è²¬åˆ†é›¢çš„æ¨¡çµ„åŒ–è¨­è¨ˆ
def layout(self, questions, questions_per_round=0):
    # ä¸»æ§é‚è¼¯ï¼Œå§”æ´¾çµ¦å°ˆé–€æ–¹æ³•
    for i, question in enumerate(questions):
        round_info = self._calculate_round_info(i, questions_per_round)
        if self._should_force_new_page(i, questions_per_round):
            current_page = self._create_new_page(current_page, "æ–°å›é–‹å§‹")
        
        size_info = self._get_size_info(question)
        placement_result = self._place_question(current_page, size_info, question, round_info)
        # ...

class GridManager:
    def can_place_at(self, page, row, col, width_cells, height_cells): ...
    def place_at(self, page, row, col, width_cells, height_cells): ...

class CompactStrategy:
    def find_position(self, grid_manager, page, width_cells, height_cells): ...
```

**å„ªå‹¢åˆ†æ**:
- âœ… **å–®ä¸€è·è²¬**: æ¯å€‹é¡å’Œæ–¹æ³•è·è²¬æ˜ç¢º
- âœ… **å¯æ¸¬è©¦æ€§**: å¯ä»¥å–®ç¨æ¸¬è©¦æ¯å€‹çµ„ä»¶
- âœ… **å¯è®€æ€§**: ä¸»æµç¨‹æ¸…æ™°ï¼Œç´°ç¯€å°è£
- âœ… **å¯æ“´å±•æ€§**: å¯ä»¥è¼•é¬†æ·»åŠ æ–°ç­–ç•¥

### **3. éŒ¯èª¤è™•ç†æ¯”è¼ƒ**

#### **èˆŠç‰ˆéŒ¯èª¤è™•ç†**:
```python
# ç°¡å–®çš„ç•°å¸¸æ‹‹å‡º
if not placed:
    raise ValueError(f"ç„¡æ³•æ”¾ç½®é¡Œç›®ï¼Œå°ºå¯¸éå¤§: {width_cells}x{height_cells}")
```

#### **æ–°ç‰ˆéŒ¯èª¤è™•ç†**:
```python
class LayoutError(Exception):
    """ä½ˆå±€ç³»çµ±å°ˆç”¨ç•°å¸¸é¡"""
    pass

# è©³ç´°çš„éŒ¯èª¤ä¿¡æ¯å’Œä¸Šä¸‹æ–‡
if not self.can_place_at(page, row, col, width_cells, height_cells):
    raise LayoutError(
        f"ç„¡æ³•åœ¨é é¢ {page} çš„ä½ç½® ({row}, {col}) "
        f"æ”¾ç½®å¤§å°ç‚º {width_cells}x{height_cells} çš„é¡Œç›®"
    )

# ç•°å¸¸éˆå’Œä¸Šä¸‹æ–‡ä¿ç•™
except Exception as e:
    logger.error(f"è™•ç†é¡Œç›® {i+1} æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
    raise LayoutError(f"ä½ˆå±€ç¬¬ {i+1} é“é¡Œç›®å¤±æ•—: {e}") from e
```

**æ–°ç‰ˆå„ªå‹¢**:
- âœ… å°ˆç”¨ç•°å¸¸é¡å‹
- âœ… è©³ç´°éŒ¯èª¤ä¸Šä¸‹æ–‡
- âœ… ç•°å¸¸éˆä¿ç•™
- âœ… çµæ§‹åŒ–æ—¥èªŒè¨˜éŒ„

### **4. æ”¾ç½®ç­–ç•¥æ¯”è¼ƒ**

#### **èˆŠç‰ˆç­–ç•¥**:
```python
# ç¡¬ç·¨ç¢¼çš„æ”¾ç½®é‚è¼¯
if height_cells == 1:
    # å„ªå…ˆæ”¾ç½®é«˜åº¦ç‚º1çš„æ ¼å­
    for row in range(self.grid_height - height_cells + 1):
        for col in range(self.grid_width - width_cells + 1):
            # å›ºå®šçš„å·¦ä¸Šè§’éæ­·
```

**å•é¡Œ**:
- âŒ ç­–ç•¥å›ºåŒ–ï¼Œç„¡æ³•æ›´æ”¹
- âŒ é‚è¼¯é‡è¤‡
- âŒ ç„¡æ³•å„ªåŒ–ä¸åŒå ´æ™¯

#### **æ–°ç‰ˆç­–ç•¥**:
```python
class CompactStrategy(PlacementStrategy):
    def find_position(self, grid_manager, page, width_cells, height_cells):
        # å°é«˜åº¦ç‚º1çš„é¡Œç›®ï¼Œå„ªå…ˆæ”¾ç½®åœ¨æœ‰å…§å®¹çš„è¡Œ
        if height_cells == 1:
            for row in range(max_row):
                row_has_content = any(grid_manager._grids[page][row][c] 
                                    for c in range(grid_manager.grid_width))
                if row_has_content:
                    # å°‹æ‰¾è©²è¡Œçš„ç©ºä½
        # å¦‚æœæ²’æ‰¾åˆ°ï¼Œä½¿ç”¨æ¨™æº–ç­–ç•¥
        return TopLeftStrategy().find_position(...)

class TopLeftStrategy(PlacementStrategy):
    def find_position(self, ...):
        # ç´”å·¦ä¸Šè§’å„ªå…ˆç­–ç•¥
```

**æ–°ç‰ˆå„ªå‹¢**:
- âœ… ç­–ç•¥å¯æ’æ‹”
- âœ… é‡å°ä¸åŒéœ€æ±‚å„ªåŒ–
- âœ… æ˜“æ–¼æ·»åŠ æ–°ç­–ç•¥
- âœ… å–®ç¨å¯æ¸¬è©¦

---

## ğŸ“Š **æ€§èƒ½å’Œå¯¦ç”¨æ€§åˆ†æ**

### **ä»£ç¢¼è¤‡é›œåº¦è©•ä¼°**

| æŒ‡æ¨™ | èˆŠç‰ˆ | æ–°ç‰ˆ | è©•ä¼° |
|------|------|------|------|
| **è¡Œæ•¸** | 210è¡Œ | 563è¡Œ | âŒ 2.7å€è†¨è„¹ |
| **é¡åˆ¥æ•¸** | 1å€‹ | 6å€‹ | âš ï¸ è¤‡é›œåº¦å¢åŠ  |
| **æ–¹æ³•æ•¸** | 3å€‹ | 15+å€‹ | âš ï¸ æ¥å£è¤‡é›œ |
| **å¾ªç’°è¤‡é›œåº¦** | é«˜(åµŒå¥—å¾ªç’°) | ä½(åˆ†é›¢é‚è¼¯) | âœ… æ”¹é€² |
| **å¯æ¸¬è©¦æ€§** | ä½ | é«˜ | âœ… é¡¯è‘—æ”¹é€² |

### **å¯¦éš›åƒ¹å€¼è©•ä¼°**

#### **æ–°ç‰ˆçš„çœŸå¯¦æ”¹é€²** â­â­â­â­â­
1. **æ¨¡çµ„åŒ–è¨­è¨ˆ**: è·è²¬åˆ†é›¢ï¼Œä»£ç¢¼æ›´æ¸…æ™°
2. **ç­–ç•¥æ¨¡å¼**: å¯ä»¥é‡å°ä¸åŒå ´æ™¯å„ªåŒ–
3. **éŒ¯èª¤è™•ç†**: æ›´å¥½çš„éŒ¯èª¤è¨ºæ–·å’Œè™•ç†
4. **æ—¥èªŒç³»çµ±**: ä¾¿æ–¼èª¿è©¦å’Œç›£æ§
5. **å¯é…ç½®æ€§**: ç¶²æ ¼å¤§å°å¯èª¿æ•´

#### **å¯èƒ½çš„éåº¦å·¥ç¨‹** âš ï¸
1. **è¤‡é›œåº¦å¢åŠ **: 2.7å€ä»£ç¢¼é‡å¢é•·
2. **å­¸ç¿’æˆæœ¬**: éœ€è¦ç†è§£å¤šå€‹é¡åˆ¥çš„äº¤äº’
3. **ç¶­è­·æˆæœ¬**: æ›´å¤šçµ„ä»¶éœ€è¦ç¶­è­·

### **å¯¦ç”¨å ´æ™¯åˆ†æ**

**é©åˆæ–°ç‰ˆçš„å ´æ™¯**:
- éœ€è¦ä¸åŒä½ˆå±€ç­–ç•¥çš„å¾©é›œæ‡‰ç”¨
- éœ€è¦æ“´å±•å’Œå®šåˆ¶ä½ˆå±€ç®—æ³•
- åœ˜éšŠé–‹ç™¼ï¼Œéœ€è¦æ¸…æ™°çš„è·è²¬åˆ†é›¢
- ç”Ÿç”¢ç’°å¢ƒï¼Œéœ€è¦å®Œå–„çš„éŒ¯èª¤è™•ç†

**èˆŠç‰ˆä»æœ‰å„ªå‹¢çš„å ´æ™¯**:
- ç°¡å–®çš„å€‹äººé …ç›®
- ä½ˆå±€éœ€æ±‚å›ºå®šä¸è®Š
- å¿«é€ŸåŸå‹é–‹ç™¼
- æ•™å­¸æ¼”ç¤ºä»£ç¢¼

---

## ğŸ¯ **å°ç”Ÿæˆå™¨é‡å¯«çš„æŒ‡å°æ„ç¾©**

### **ä½ˆå±€å¼•æ“é¸æ“‡å»ºè­°**

#### **æ¨è–¦ä½¿ç”¨æ–°ç‰ˆä½ˆå±€å¼•æ“** âœ…

**ç†ç”±**:
1. **æ–°ç‰ˆæ˜¯çœŸæ­£çš„æ”¹é€²**: ä¸æ˜¯éåº¦å·¥ç¨‹ï¼Œè€Œæ˜¯å°ˆæ¥­åŒ–æ”¹é€²
2. **PDFç”Ÿæˆéœ€è¦**: ç”Ÿç”¢ç´šPDFç”Ÿæˆéœ€è¦ç©©å®šçš„ä½ˆå±€ç³»çµ±
3. **æ•™å­¸æ‡‰ç”¨ç‰¹æ€§**: éœ€è¦è™•ç†å¤šç¨®é¡Œç›®å°ºå¯¸çµ„åˆ
4. **éŒ¯èª¤è¨ºæ–·**: ä½ˆå±€å•é¡Œéœ€è¦è©³ç´°çš„éŒ¯èª¤ä¿¡æ¯

#### **ç”Ÿæˆå™¨é‡å¯«çš„ä½ˆå±€é›†æˆ**:

```python
# åœ¨ç”Ÿæˆå™¨é‡å¯«æ™‚çš„æœ€ä½³å¯¦è¸
from utils.core.layout import LayoutEngine, CompactStrategy

class OptimizedGenerator(QuestionGenerator):
    def generate_questions_batch(self, count: int):
        # ç”Ÿæˆé¡Œç›®åˆ—è¡¨
        questions = [self.generate_question() for _ in range(count)]
        
        # ä½¿ç”¨æ–°ç‰ˆä½ˆå±€å¼•æ“
        layout_engine = LayoutEngine(
            grid_width=4, 
            grid_height=8,
            placement_strategy=CompactStrategy()
        )
        
        # åŸ·è¡Œä½ˆå±€
        layout_results = layout_engine.layout(questions, questions_per_round=10)
        
        return layout_results
```

### **é¿å…çš„å¸¸è¦‹éŒ¯èª¤**

1. **ä¸è¦é‡è¤‡å¯¦ç¾ä½ˆå±€é‚è¼¯**: ä½¿ç”¨ç¾æˆçš„ä½ˆå±€å¼•æ“
2. **ä¸è¦ç¡¬ç·¨ç¢¼ä½ˆå±€åƒæ•¸**: åˆ©ç”¨æ–°ç‰ˆçš„å¯é…ç½®æ€§
3. **ä¸è¦å¿½ç•¥éŒ¯èª¤è™•ç†**: åˆ©ç”¨LayoutErrorç²å¾—æ›´å¥½çš„éŒ¯èª¤ä¿¡æ¯

---

## ğŸ“ **ç¸½çµèˆ‡å»ºè­°**

### **æ ¸å¿ƒç™¼ç¾**

1. **æ–°ç‰ˆæ˜¯å°ˆæ¥­åŒ–å‡ç´š**: å¾ã€Œèƒ½ç”¨ã€å‡ç´šåˆ°ã€Œå¥½ç”¨ã€
2. **è¤‡é›œåº¦å¢åŠ æ˜¯åˆç†çš„**: 2.7å€çš„ä»£ç¢¼å¢é•·å¸¶ä¾†äº†é¡¯è‘—çš„åŠŸèƒ½å’Œè³ªé‡æå‡
3. **æ¶æ§‹è¨­è¨ˆå„ªç§€**: ç­–ç•¥æ¨¡å¼å’Œçµ„åˆæ¨¡å¼çš„æ‡‰ç”¨æ°ç•¶
4. **å‘å¾Œå…¼å®¹**: ä¿æŒç›¸åŒçš„APIæ¥å£

### **æœ€çµ‚å»ºè­°**

#### **å¼·çƒˆæ¨è–¦ä½¿ç”¨æ–°ç‰ˆä½ˆå±€å¼•æ“**

**å°æ–¼ç”Ÿæˆå™¨é‡å¯«é …ç›®**:
- âœ… **ç›´æ¥ä½¿ç”¨æ–°ç‰ˆAPI**: ä¸éœ€è¦è‡ªå·±å¯¦ç¾ä½ˆå±€é‚è¼¯
- âœ… **åˆ©ç”¨ç­–ç•¥ç³»çµ±**: æ ¹æ“šä¸åŒé¡Œå‹é¸æ“‡ä¸åŒç­–ç•¥
- âœ… **å……åˆ†åˆ©ç”¨éŒ¯èª¤è™•ç†**: æ›´å¥½çš„èª¿è©¦é«”é©—
- âœ… **éµå¾ªæ–°ç‰ˆè¦ç¯„**: ç¢ºä¿é¡Œç›®åŒ…å«æ­£ç¢ºçš„sizeæ¬„ä½

**æ–°ç‰ˆä½ˆå±€å¼•æ“çš„2.7å€ä»£ç¢¼å¢é•·æ˜¯åˆç†ä¸”æœ‰åƒ¹å€¼çš„æŠ•è³‡**ï¼Œå®ƒæä¾›äº†ï¼š
- æ›´å¥½çš„å¯ç¶­è­·æ€§
- æ›´å¼·çš„å¯æ“´å±•æ€§  
- æ›´å°ˆæ¥­çš„éŒ¯èª¤è™•ç†
- æ›´éˆæ´»çš„é…ç½®é¸é …

**é€™æ˜¯ä¸€å€‹æˆåŠŸçš„é‡æ§‹æ¡ˆä¾‹**ï¼Œå€¼å¾—åœ¨ç”Ÿæˆå™¨é‡å¯«ä¸­å……åˆ†åˆ©ç”¨ã€‚

<function_calls>
<invoke name="TodoWrite">
<parameter name="todos">[{"content": "\u6bd4\u8f03utils/core/layout.py\u7684\u529f\u80fd\u548c\u8a2d\u8a08", "status": "completed", "activeForm": "\u6bd4\u8f03utils/core/layout.py\u7684\u529f\u80fd\u548c\u8a2d\u8a08"}]