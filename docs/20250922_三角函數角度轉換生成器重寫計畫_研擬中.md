# 三角函數角度轉換生成器重寫計畫

> **目標**: 基於舊版實現進行現代化重寫，保持數學邏輯正確性，移除過度工程化
> **日期**: 2025-09-22
> **狀態**: 🔄 研擬中
> **方向**: 舊版現代化策略

## 🎯 **重寫目標**

### **核心理念**
採用「保留數學精髓，現代化架構」策略，避免新版本的過度工程化問題，確保數學邏輯的正確性和教學價值。

### **目標成果**
- ✅ 保持舊版本經過驗證的數學邏輯
- ✅ 採用新架構的統一標準（配置、日誌、元數據）
- ✅ 符合典範開發準則（簡潔實用）
- ✅ 移除過度抽象化和不良實踐

---

## 📊 **版本分析對比**

### **舊版本優勢保留**

#### **✅ 數學邏輯健全**
- **象限轉換正確**：`_convert_to_first_quadrant()` 處理各象限符號變化準確
- **餘角公式應用**：`_convert_to_narrow_angle()` 使用標準數學關係
- **週期性處理**：正確處理 360° 週期性和負角度
- **特殊情況處理**：tan 函數在 90° 奇數倍的未定義情況

#### **✅ 教學設計合理**
- **三種題型比例**：第一象限轉換(70%)、公式問答(10%)、窄角轉換(20%)
- **角度範圍選擇**：-80° 到 260°，避開 90° 的倍數
- **公式題庫**：預定義的三角函數關係公式
- **解釋步驟**：詳細的數學推導過程

#### **✅ 架構簡潔**
- **配置模式**：使用 `options.get()` 而非複雜驗證
- **邏輯分工**：清晰的方法職責劃分
- **代碼可讀性**：沒有不必要的抽象層

### **新版本問題分析**

#### **❌ 過度工程化**
```python
# 問題：為簡單字串創建枚舉
class TrigFunction(str, Enum):
    SIN = "sin"
    COS = "cos"
    TAN = "tan"
    COT = "cot"

# 問題：3個模式需要枚舉？
class ConversionMode(str, Enum):
    # 過度抽象化
```

#### **❌ 不良實踐**
```python
from sympy import *  # 污染命名空間
from pydantic import BaseModel, Field, validator  # 過度驗證
```

#### **❌ 數學風險**
- 重新實現的數學邏輯可能引入錯誤
- 舊版本邏輯已經過實際使用驗證

---

## 🔧 **重寫實施策略**

### **Phase 1: 架構現代化**

#### **1.1 導入和基礎設定**
```python
# ✅ 採用標準導入
import random
from typing import Dict, Any, List, Tuple

# ✅ 使用新架構核心工具
from utils import get_logger
from generators.base import QuestionGenerator, QuestionSize, register_generator

# ✅ 統一註冊機制
@register_generator
class TrigAngleConversionGenerator(QuestionGenerator):
```

#### **1.2 配置系統統一**
```python
def __init__(self, options: Dict[str, Any] = None):
    super().__init__(options)
    self.logger = get_logger(self.__class__.__name__)

    # ✅ 保持簡潔的配置模式
    options = options or {}
    self.difficulty = options.get("difficulty", "MEDIUM")

    # ✅ 保留舊版本的合理設計
    self.functions = ["sin", "cos", "tan"]
    self.base_angles = [angle for angle in range(-80, 261, 10) if angle % 90 != 0]
    self.mode_weights = [70, 10, 20]  # 經過教學驗證的比例
```

### **Phase 2: 核心邏輯保留**

#### **2.1 完整移植數學方法**
- ✅ `_convert_to_first_quadrant()` - 象限轉換邏輯
- ✅ `_convert_to_narrow_angle()` - 餘角轉換邏輯
- ✅ `_generate_explanation()` - 解釋生成邏輯
- ✅ `_generate_narrow_angle_explanation()` - 窄角解釋邏輯

#### **2.2 三種題型方法保留**
- ✅ `_generate_formula_question()` - 公式問答題
- ✅ `_generate_original_question()` - 第一象限轉換題
- ✅ `_generate_narrow_angle_question()` - 窄角轉換題

#### **2.3 公式題庫保留**
```python
# ✅ 保留經過驗證的公式題庫
FORMULA_QUESTIONS = {
    "sin": [
        {"question": "\\sin(180^\\circ-\\theta) = ", "answer": "\\sin(\\theta)"},
        # ... 其他公式
    ],
    # ... 其他函數
}
```

### **Phase 3: 現代化改善**

#### **3.1 元數據處理統一**
```python
def _get_standard_metadata(self) -> Dict[str, Any]:
    """統一的元數據處理，與其他生成器保持一致"""
    return {
        "size": self.get_question_size(),
        "difficulty": self.difficulty,
        "category": self.get_category(),
        "subcategory": self.get_subcategory(),
        "grade": "G10S2",  # 高一下學期
        # 預留圖形相關欄位
        "figure_data_question": None,
        "figure_data_explanation": None,
        "figure_position": "right",
        "explanation_figure_position": "right"
    }
```

#### **3.2 錯誤處理機制**
```python
def generate_question(self) -> Dict[str, Any]:
    """加入現代化的錯誤處理和日誌"""
    self.logger.info("開始生成三角函數角度轉換題目")

    try:
        # 保留舊版本的題型選擇邏輯
        mode = random.choices(
            ["original", "formula", "narrow_angle"],
            weights=self.mode_weights
        )[0]

        # ... 原有邏輯

    except Exception as e:
        self.logger.warning(f"生成題目失敗: {str(e)}")
        return self._get_fallback_question()
```

#### **3.3 註解標準化**
- 移除「華麗大招」等不符合規範的標籤
- 採用「為什麼這樣做」的註解風格
- 保留有價值的數學邏輯說明

### **Phase 3.5: UI配置支援整合** (新增 - 30分鐘)

#### **3.5.1 配置描述定義**
```python
@classmethod
def get_config_schema(cls):
    """提供UI配置描述，支援教學彈性調整"""
    return {
        "mode_weights": {
            "type": "group",
            "label": "題型比例分配",
            "description": "調整三種題型的出現頻率，總和會自動正規化為100%",
            "items": {
                "original": {
                    "type": "number",
                    "min": 0,
                    "max": 100,
                    "default": 70,
                    "label": "第一象限轉換(%)",
                    "description": "將任意角度轉換為0°-90°範圍"
                },
                "formula": {
                    "type": "number",
                    "min": 0,
                    "max": 100,
                    "default": 10,
                    "label": "公式問答(%)",
                    "description": "基本三角函數關係公式題"
                },
                "narrow_angle": {
                    "type": "number",
                    "min": 0,
                    "max": 100,
                    "default": 20,
                    "label": "窄角轉換(%)",
                    "description": "進一步轉換為0°-45°範圍"
                }
            }
        },
        "angle_range": {
            "type": "select",
            "options": ["basic", "extended", "negative"],
            "default": "basic",
            "label": "角度範圍",
            "description": "basic(-80°~260°) / extended(-180°~540°) / negative(包含更多負角)"
        }
    }
```

#### **3.5.2 配置處理邏輯**
```python
def __init__(self, options: Dict[str, Any] = None):
    super().__init__(options)
    self.logger = get_logger(self.__class__.__name__)
    options = options or {}

    # 固定函數類型（基於教學標準，不開放配置）
    self.functions = ["sin", "cos", "tan"]

    # 可配置的題型權重處理
    mode_config = options.get("mode_weights", {})
    original = mode_config.get("original", 70)
    formula = mode_config.get("formula", 10)
    narrow_angle = mode_config.get("narrow_angle", 20)

    # 權重正規化確保總和為100
    total = original + formula + narrow_angle
    if total > 0:
        self.mode_weights = [
            int(original * 100 / total),
            int(formula * 100 / total),
            int(narrow_angle * 100 / total)
        ]
    else:
        self.mode_weights = [70, 10, 20]  # 預設值

    # 可配置的角度範圍
    angle_range = options.get("angle_range", "basic")
    if angle_range == "extended":
        # 擴展範圍：-180° 到 540°
        self.base_angles = list(range(-180, 541, 10))
    elif angle_range == "negative":
        # 負角範圍：-270° 到 360°
        self.base_angles = list(range(-270, 361, 10))
    else:  # basic
        # 基礎範圍：-80° 到 260°（舊版本設定）
        self.base_angles = list(range(-80, 261, 10))

    # 移除90度倍數（避免tan函數未定義）
    self.base_angles = [angle for angle in self.base_angles if angle % 90 != 0]

    # 記錄最終配置
    self.logger.info(f"角度轉換生成器配置 - 權重: {self.mode_weights}, 角度範圍: {angle_range}")
```

#### **3.5.3 向後兼容確保**
```python
# 確保無配置時使用預設值
self.difficulty = options.get("difficulty", "MEDIUM")  # 保留舊參數兼容

# 配置驗證和錯誤處理
if angle_range not in ["basic", "extended", "negative"]:
    self.logger.warning(f"無效的角度範圍: {angle_range}，使用預設值basic")
    angle_range = "basic"
```

---

## ⚠️ **風險評估與對策**

### **數學邏輯風險**
**風險**: 移植過程中可能引入數學錯誤
**對策**:
- 逐方法對比測試
- 保留原有的測試角度集合
- 驗證各象限的符號處理

### **功能完整性風險**
**風險**: 可能遺漏舊版本的功能細節
**對策**:
- 完整功能對照檢查表
- 保留所有三種題型模式
- 維持相同的解釋詳細程度

### **架構兼容性風險**
**風險**: 新架構要求可能與舊邏輯衝突
**對策**:
- 最小化架構變更
- 保持接口一致性
- 漸進式重構

---

## 📋 **實施檢查清單**

### **Phase 1: 架構準備 ✅**
- [ ] 設定標準導入和註冊
- [ ] 統一配置管理
- [ ] 加入日誌系統
- [ ] 建立元數據處理

### **Phase 2: 核心邏輯移植 ✅**
- [ ] `_convert_to_first_quadrant()` 邏輯驗證
- [ ] `_convert_to_narrow_angle()` 邏輯驗證
- [ ] 三種題型生成方法移植
- [ ] 公式題庫完整移植
- [ ] 解釋生成邏輯保留

### **Phase 3: 現代化改善 ✅**
- [ ] 註解標準化處理
- [ ] 錯誤處理機制
- [ ] LaTeX格式優化
- [ ] 統一接口方法

### **Phase 3.5: UI配置支援整合 ✅**
- [ ] 配置描述方法 `get_config_schema()` 實現
- [ ] 題型權重配置處理和正規化
- [ ] 角度範圍配置邏輯
- [ ] 配置驗證和錯誤處理
- [ ] 向後兼容性確保

### **Phase 4: 測試驗證 ✅**
- [ ] 各象限角度轉換測試
- [ ] 三種題型生成測試
- [ ] 符號處理正確性驗證
- [ ] 解釋邏輯完整性檢查
- [ ] 配置功能測試（題型比例、角度範圍）
- [ ] 向後兼容性測試（無配置模式）

---

## 🎯 **成功標準**

### **功能標準**
- ✅ 保持三種題型及其比例 (70%/10%/20%)
- ✅ 各象限角度轉換邏輯正確
- ✅ 窄角轉換和餘角公式應用正確
- ✅ 解釋步驟詳細且數學正確

### **代碼品質標準**
- ✅ 符合典範開發準則（簡潔實用）
- ✅ 註解符合規範標準
- ✅ 架構與其他生成器一致
- ✅ 無過度工程化設計

### **測試標準**
- ✅ 所有測試角度正確處理
- ✅ 錯誤情況有適當處理
- ✅ 性能表現良好
- ✅ 與現有系統完美整合

---

## 📅 **實施時程**

**預估時間**: 3-3.5小時
**實施方式**: 清空覆寫現有文件

### **時程安排**
1. **Phase 1 (30分鐘)**: 架構設定和配置系統
2. **Phase 2 (90分鐘)**: 核心邏輯移植和驗證
3. **Phase 3 (30分鐘)**: 現代化改善和註解標準化
4. **Phase 4 (30分鐘)**: 測試驗證和最終檢查

---

## 📝 **備註**

### **設計哲學**
採用「該用基礎招式的時候用基礎招式」原則，避免為簡單問題創造複雜解決方案。三角函數角度轉換是基礎數學概念，應該用直觀、可驗證的方法實現。

### **維護考量**
重寫後的代碼應該讓數學教師能夠理解和修改，避免過度的技術抽象化。數學邏輯的正確性比代碼的技術先進性更重要。

### **教學價值**
保持舊版本經過實際教學驗證的設計決策，如題型比例、角度範圍選擇等，這些都是基於教學經驗的寶貴設計。

---

**狀態**: 🔄 計畫完成，等待實施確認
**下一步**: 確認計畫後開始清空覆寫實施