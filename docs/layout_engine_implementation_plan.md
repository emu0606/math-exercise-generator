# é˜²åƒå·®ä½ˆå±€å¼•æ“å¯¦æ–½è¨ˆç•«

> **å°ˆæ¡ˆ**: æ•¸å­¸æ¸¬é©—ç”Ÿæˆå™¨ä½ˆå±€å¼•æ“å„ªåŒ–
> **è¨ˆç•«ç‰ˆæœ¬**: v1.0
> **å»ºç«‹æ™‚é–“**: 2025-09-14
> **è¨ˆç•«é¡å‹**: æœ€å°ä¾µå…¥å¼ä¿®å¾©æ–¹æ¡ˆ

---

## ğŸ“‹ **å°ˆæ¡ˆæ¦‚è¿°**

### **æ ¸å¿ƒç›®æ¨™**
å¯¦ç¾åŒä¸€è¡Œå…§æ‰€æœ‰é¡Œç›®å¿…é ˆæœ‰ç›¸åŒé«˜åº¦çš„ä½ˆå±€æ©Ÿåˆ¶ï¼Œå¾¹åº•è§£æ±ºè¦–è¦ºåƒå·®å•é¡Œã€‚

### **æŠ€è¡“æ–¹æ¡ˆ**
æ¡ç”¨**æ–¹æ¡ˆAï¼šè¡Œé«˜åº¦é–å®šæ©Ÿåˆ¶** + **æœ€å°ä¾µå…¥å¼ä¿®å¾©**ï¼ŒåŸºæ–¼å·²é©—è­‰çš„æ¸¬è©¦ç‰ˆå¼•æ“é‚è¼¯ã€‚

### **é æœŸæ•ˆæœ**
- **è¦–è¦ºå“è³ª**: 100%æ¶ˆé™¤æ··åˆé«˜åº¦å•é¡Œ
- **ç©ºé–“åˆ©ç”¨ç‡**: ä¿æŒ81.2%ä»¥ä¸Šåˆ©ç”¨ç‡
- **ç³»çµ±ç©©å®šæ€§**: æœ€å°æ”¹å‹•é¢¨éšªï¼Œæœ€å¤§åŒ–å‘å¾Œç›¸å®¹

---

## ğŸ¯ **å¯¦æ–½ç­–ç•¥ç¸½è¦½**

### **æ ¸å¿ƒç™¼ç¾**
1. **é æ’åºæ¡†æ¶å®Œå–„**: `question_distributor.py` å·²å…·å‚™å®Œæ•´æ’åºåŸºç¤
2. **Bugå®šä½æº–ç¢º**: `layout.py` å•é¡Œé›†ä¸­åœ¨ `_get_existing_question_height()` æ–¹æ³•
3. **æ¸¬è©¦ç‰ˆé‚è¼¯é©—è­‰**: å…­ç¨®æ¸¬è©¦æ¡ˆä¾‹100%é€šéï¼Œé‚è¼¯å¯é 

### **æœ€å°æ”¹å‹•åŸå‰‡**
- åªä¿®å¾©é—œéµBugï¼Œä¸æ”¹è®Šæ•´é«”æ¶æ§‹
- ä¿æŒç¾æœ‰ä»‹é¢å’Œå·¥ä½œæµç¨‹ä¸è®Š
- åŸºæ–¼æ¸¬è©¦ç‰ˆé©—è­‰çš„ç´”æ·¨é‚è¼¯

---

## ğŸ“… **è©³ç´°å¯¦æ–½æ™‚ç¨‹**

### **Phase 1: é æ’åºå„ªåŒ–** *(Day 1 ä¸Šåˆï¼Œ4å°æ™‚)*

#### **ç›®æ¨™**: å®Œå–„ question_distributor.py çš„é æ’åºæ©Ÿåˆ¶

#### **ä»»å‹™æ¸…å–®**:
- [ ] **ä»»å‹™1.1**: æ–°å¢ `sort_by_height_then_size()` æ–¹æ³•
  - **ä½ç½®**: `utils/orchestration/question_distributor.py:436`
  - **åŠŸèƒ½**: å¯¦ç¾"é«˜åº¦å„ªå…ˆï¼Œå°ºå¯¸æ¬¡è¦"çš„è¤‡åˆæ’åº
  - **ä¼°æ™‚**: 1å°æ™‚

- [ ] **ä»»å‹™1.2**: ä¿®æ”¹å›åˆå…§æ’åºé‚è¼¯
  - **ä½ç½®**: `utils/orchestration/question_distributor.py:503`
  - **ä¿®æ”¹**: æ•´åˆæ–°æ’åºæ–¹æ³•åˆ°é…ç½®æ§åˆ¶
  - **ä¼°æ™‚**: 1å°æ™‚

- [ ] **ä»»å‹™1.3**: æ¸¬è©¦é æ’åºåŠŸèƒ½
  - **æ–¹æ³•**: å–®ç¨æ¸¬è©¦æ’åºçµæœ
  - **é©—è­‰**: ç¢ºä¿height=1é¡Œç›®å„ªå…ˆè™•ç†
  - **ä¼°æ™‚**: 2å°æ™‚

#### **é—œéµç¨‹å¼ç¢¼**:
```python
@staticmethod
def sort_by_height_then_size(questions: List[Dict[str, Any]], ascending: bool = True) -> List[Dict[str, Any]]:
    """æŒ‰é«˜åº¦å„ªå…ˆã€å°ºå¯¸æ¬¡è¦æ’åºï¼ˆæ–¹æ¡ˆAé æ’åºé‚è¼¯ï¼‰"""
    def get_height_and_size(question: Dict[str, Any]) -> Tuple[int, int]:
        size = question.get('size', 1)
        size_value = size.value if hasattr(size, 'value') else size

        # å°ºå¯¸åˆ°é«˜åº¦æ˜ å°„
        size_map = {1: 1, 2: 1, 3: 2, 4: 2, 5: 2, 6: 2}
        height = size_map.get(size_value, 1)

        return (height, size_value)

    return sorted(questions, key=get_height_and_size, reverse=not ascending)
```

---

### **Phase 2: ä½ˆå±€å¼•æ“ä¿®å¾©** *(Day 1 ä¸‹åˆï¼Œ4å°æ™‚)*

#### **ç›®æ¨™**: ä¿®å¾© layout.py ä¸­çš„é—œéµBug

#### **ä»»å‹™æ¸…å–®**:
- [ ] **ä»»å‹™2.1**: æ“´å±• GridManager ç‹€æ…‹è¿½è¹¤
  - **ä½ç½®**: `utils/core/layout.py:56-70`
  - **æ–°å¢**: `row_locked_heights` é™£åˆ—è¿½è¹¤
  - **ä¼°æ™‚**: 1å°æ™‚

- [ ] **ä»»å‹™2.2**: ä¿®å¾© `_get_existing_question_height()` æ–¹æ³•
  - **ä½ç½®**: `utils/core/layout.py:280-311`
  - **ç­–ç•¥**: ä½¿ç”¨è¡Œé–å®šç‹€æ…‹è€ŒééŒ¯èª¤çš„æƒæé‚è¼¯
  - **ä¼°æ™‚**: 1.5å°æ™‚

- [ ] **ä»»å‹™2.3**: æ›´æ–°æ”¾ç½®é‚è¼¯
  - **ä½ç½®**: `utils/core/layout.py:115-141`
  - **åŠŸèƒ½**: åœ¨æ”¾ç½®æ™‚æ›´æ–°è¡Œé–å®šç‹€æ…‹
  - **ä¼°æ™‚**: 1å°æ™‚

- [ ] **ä»»å‹™2.4**: å–®å…ƒæ¸¬è©¦é©—è­‰
  - **å…§å®¹**: æ¸¬è©¦è¡Œé«˜åº¦é–å®šæ©Ÿåˆ¶
  - **ä¼°æ™‚**: 0.5å°æ™‚

#### **é—œéµä¿®å¾©é‚è¼¯**:
```python
class GridManager:
    def __init__(self, grid_width: int = 4, grid_height: int = 8):
        # ç¾æœ‰ç¨‹å¼ç¢¼...
        # æ–°å¢ï¼šè¡Œé«˜åº¦é–å®šç‹€æ…‹è¿½è¹¤
        self.row_locked_heights = [-1] * grid_height  # -1è¡¨ç¤ºæœªé–å®š

    def place_at(self, page: int, row: int, col: int, width_cells: int, height_cells: int) -> None:
        # ç¾æœ‰æ”¾ç½®é‚è¼¯...
        # æ–°å¢ï¼šæ›´æ–°è¡Œé–å®šç‹€æ…‹
        for r in range(row, row + height_cells):
            if r < len(self.row_locked_heights):
                self.row_locked_heights[r] = height_cells

def _get_existing_question_height(self, grid_manager: GridManager,
                                page: int, row: int, col: int) -> int:
    """ä¿®å¾©ç‰ˆï¼šç›´æ¥å¾è¡Œé–å®šç‹€æ…‹ç²å–é«˜åº¦"""
    if not hasattr(grid_manager, 'row_locked_heights'):
        return 0  # å‘å¾Œç›¸å®¹

    if 0 <= row < len(grid_manager.row_locked_heights):
        locked_height = grid_manager.row_locked_heights[row]
        return locked_height if locked_height != -1 else 0

    return 0
```

---

### **Phase 3: æ•´åˆæ¸¬è©¦èˆ‡é©—è­‰** *(Day 2 ä¸Šåˆï¼Œ4å°æ™‚)*

#### **ç›®æ¨™**: ç¢ºä¿ä¿®å¾©å¾Œç³»çµ±ç©©å®šé‹è¡Œ

#### **ä»»å‹™æ¸…å–®**:
- [ ] **ä»»å‹™3.1**: å–®å…ƒæ¸¬è©¦åŸ·è¡Œ
  - **ç¯„åœ**: ä½ˆå±€å¼•æ“æ ¸å¿ƒåŠŸèƒ½
  - **æŒ‡ä»¤**: `py -m pytest tests/test_utils/test_geometry/ -v`
  - **ä¼°æ™‚**: 1å°æ™‚

- [ ] **ä»»å‹™3.2**: æ•´åˆæ¸¬è©¦
  - **æ–¹æ³•**: å®Œæ•´PDFç”Ÿæˆæµç¨‹æ¸¬è©¦
  - **å·¥å…·**: ä½¿ç”¨å…­ç¨®æ¸¬è©¦æ¡ˆä¾‹æ•¸æ“š
  - **ä¼°æ™‚**: 2å°æ™‚

- [ ] **ä»»å‹™3.3**: å°æ¯”é©—è­‰
  - **åŸºæº–**: èˆ‡æ¸¬è©¦ç‰ˆå¼•æ“çµæœæ¯”è¼ƒ
  - **é‡é»**: é©—è­‰é˜²åƒå·®æ•ˆæœ
  - **ä¼°æ™‚**: 1å°æ™‚

#### **æ¸¬è©¦æª¢æŸ¥æ¸…å–®**:
- [ ] åŸºç¤åŠŸèƒ½ï¼šæ‡‰ç”¨ç¨‹å¼æ­£å¸¸å•Ÿå‹•
- [ ] é¡Œç›®ç”Ÿæˆï¼šå„ç¨®å°ºå¯¸é¡Œç›®æ­£å¸¸ç”Ÿæˆ
- [ ] ä½ˆå±€æ•ˆæœï¼šç„¡æ··åˆé«˜åº¦ç¾è±¡
- [ ] å›åˆåˆ¶ï¼šå¤šå›åˆåŠŸèƒ½æ­£å¸¸
- [ ] PDFè¼¸å‡ºï¼šæœ€çµ‚ç”¢å“å“è³ªè‰¯å¥½

---

### **Phase 4: ç”Ÿç”¢éƒ¨ç½²æº–å‚™** *(Day 2 ä¸‹åˆï¼Œ2-4å°æ™‚)*

#### **ç›®æ¨™**: æº–å‚™ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²

#### **ä»»å‹™æ¸…å–®**:
- [ ] **ä»»å‹™4.1**: é…ç½®å„ªåŒ–
  - **ä½ç½®**: ç¢ºä¿ `preserve_layout_aesthetics = True`
  - **é©—è­‰**: é»˜èªå•Ÿç”¨æ–°æ’åºé‚è¼¯
  - **ä¼°æ™‚**: 0.5å°æ™‚

- [ ] **ä»»å‹™4.2**: æ—¥èªŒå®Œå–„
  - **å…§å®¹**: æ·»åŠ æ’åºå’Œé–å®šç‹€æ…‹æ—¥èªŒ
  - **ç›®çš„**: ä¾¿æ–¼ç”Ÿç”¢ç›£æ§å’Œèª¿è©¦
  - **ä¼°æ™‚**: 1å°æ™‚

- [ ] **ä»»å‹™4.3**: æ–‡æª”æ›´æ–°
  - **ç¯„åœ**: æ›´æ–°ç›¸é—œæŠ€è¡“æ–‡æª”
  - **å…§å®¹**: è¨˜éŒ„ä¿®å¾©å…§å®¹å’Œä½¿ç”¨æ–¹å¼
  - **ä¼°æ™‚**: 1å°æ™‚

- [ ] **ä»»å‹™4.4**: å›æ»¾æº–å‚™
  - **å‚™ä»½**: ç¢ºä¿ä¿®æ”¹å‰ä»£ç¢¼å‚™ä»½
  - **æ–¹æ¡ˆ**: æº–å‚™å¿«é€Ÿå›æ»¾æ­¥é©Ÿ
  - **ä¼°æ™‚**: 0.5å°æ™‚

---

## ğŸ“Š **é¢¨éšªç®¡ç†è¨ˆç•«**

### **é«˜é¢¨éšªé»è­˜åˆ¥**
| é¢¨éšªé …ç›® | é¢¨éšªç­‰ç´š | å½±éŸ¿ç¯„åœ | ç·©è§£ç­–ç•¥ |
|---------|---------|---------|---------|
| GridManagerç‹€æ…‹è¡çª | ğŸŸ¡ ä¸­ | ä½ˆå±€è¨ˆç®— | å‘å¾Œç›¸å®¹æ€§æª¢æŸ¥ |
| é æ’åºç ´å£å›åˆçµæ§‹ | ğŸŸ¢ ä½ | é¡Œç›®é †åº | å›åˆå…§æ’åºé™åˆ¶ |
| æ€§èƒ½å›æ­¸ | ğŸŸ¢ ä½ | éŸ¿æ‡‰æ™‚é–“ | æ’åºç®—æ³•ç°¡å–®é«˜æ•ˆ |
| ç›¸å®¹æ€§å•é¡Œ | ğŸŸ¡ ä¸­ | ç¾æœ‰åŠŸèƒ½ | æ¼¸é€²å¼å•Ÿç”¨ |

### **å›æ»¾æ©Ÿåˆ¶**
1. **è‡ªå‹•å‚™ä»½**: ä¿®æ”¹å‰è‡ªå‹•å‚™ä»½é—œéµæª”æ¡ˆ
2. **å¿«é€Ÿå›æ»¾**: æº–å‚™ä¸€éµæ¢å¾©è…³æœ¬
3. **ç›£æ§æŒ‡æ¨™**: è¨­å®šé—œéµæ€§èƒ½ç›£æ§
4. **å›æ»¾è§¸ç™¼**: å®šç¾©æ˜ç¢ºçš„å›æ»¾æ¢ä»¶

### **æ¸¬è©¦é˜²è­·**
- **å¤šå±¤æ¬¡æ¸¬è©¦**: å–®å…ƒâ†’æ•´åˆâ†’ç«¯å°ç«¯
- **é‚Šç•Œæ¸¬è©¦**: æ¥µç«¯æƒ…æ³å’Œé‚Šç•Œæ¢ä»¶
- **å›æ­¸æ¸¬è©¦**: ç¢ºä¿ç¾æœ‰åŠŸèƒ½ä¸å—å½±éŸ¿
- **å°æ¯”é©—è­‰**: èˆ‡æ¸¬è©¦ç‰ˆçµæœæ¯”å°

---

## ğŸ¯ **æˆåŠŸæ¨™æº–å®šç¾©**

### **åŠŸèƒ½æ€§ç›®æ¨™**
- [ ] **é˜²åƒå·®æ•ˆæœ**: 100%æ¶ˆé™¤åŒè¡Œæ··åˆé«˜åº¦
- [ ] **ç©ºé–“åˆ©ç”¨ç‡**: ä¿æŒâ‰¥80%åˆ©ç”¨ç‡
- [ ] **åŠŸèƒ½å®Œæ•´æ€§**: æ‰€æœ‰ç¾æœ‰åŠŸèƒ½æ­£å¸¸é‹ä½œ
- [ ] **æ€§èƒ½æ°´æº–**: éŸ¿æ‡‰æ™‚é–“ä¸è¶…éåŸºæº–110%

### **æŠ€è¡“æ€§ç›®æ¨™**
- [ ] **ä»£ç¢¼å“è³ª**: é€šéæ‰€æœ‰ç¾æœ‰å–®å…ƒæ¸¬è©¦
- [ ] **å‘å¾Œç›¸å®¹**: ä¸ç ´å£ç¾æœ‰APIä»‹é¢
- [ ] **ç©©å®šæ€§**: é€£çºŒé‹è¡Œç„¡å´©æ½°
- [ ] **å¯ç¶­è­·æ€§**: ä»£ç¢¼æ¸…æ™°æ˜“æ‡‚

### **æ¥­å‹™ç›®æ¨™**
- [ ] **ç”¨æˆ¶é«”é©—**: è¦–è¦ºå“è³ªæ˜é¡¯æå‡
- [ ] **ç³»çµ±å¯é æ€§**: ç„¡åŠŸèƒ½å›æ­¸
- [ ] **éƒ¨ç½²é¢¨éšª**: é›¶åœæ©Ÿæ™‚é–“éƒ¨ç½²

---

## ğŸ“š **æŠ€è¡“åƒè€ƒè³‡æ–™**

### **é—œéµæª”æ¡ˆåˆ—è¡¨**
- `utils/orchestration/question_distributor.py` - é æ’åºé‚è¼¯
- `utils/core/layout.py` - ä½ˆå±€å¼•æ“æ ¸å¿ƒ
- `clean_layout_test.py` - æ¸¬è©¦ç‰ˆåƒè€ƒå¯¦ç¾
- `docs/é˜²åƒå·®ä½ˆå±€æ©Ÿåˆ¶è¨­è¨ˆæ–¹æ¡ˆ.md` - è¨­è¨ˆç†è«–åŸºç¤

### **æ¸¬è©¦è³‡æ–™**
- `test_clean_*.html` - å…­ç¨®é©—è­‰æ¸¬è©¦æ¡ˆä¾‹
- é‚Šç•Œæ¸¬è©¦ï¼š32æ ¼ç²¾ç¢ºå¡«æ»¿
- æ¥µç«¯æ¸¬è©¦ï¼šSMALLåˆ°EXTRAæ··åˆ
- é †åºæ¸¬è©¦ï¼šé æ’åºvsç„¡æ’åºå°æ¯”

### **ç›¸é—œæ–‡æª”**
- [æ–¹æ¡ˆAç†è«–è¨­è¨ˆ](docs/é˜²åƒå·®ä½ˆå±€æ©Ÿåˆ¶è¨­è¨ˆæ–¹æ¡ˆ.md)
- [æ¸¬è©¦ç‰ˆå¯¦ç¾åˆ†æ](clean_layout_test.py)
- [ç¾æœ‰æ¶æ§‹åˆ†æ](docs/layout_engine_comparison.md)

---

## ğŸš€ **éƒ¨ç½²æª¢æŸ¥æ¸…å–®**

### **éƒ¨ç½²å‰ç¢ºèª**
- [ ] æ‰€æœ‰ä»»å‹™å®Œæˆä¸¦æ¸¬è©¦é€šé
- [ ] ä»£ç¢¼å¯©æŸ¥å®Œæˆ
- [ ] å‚™ä»½æ©Ÿåˆ¶å°±ä½
- [ ] ç›£æ§æŒ‡æ¨™è¨­å®šå®Œæˆ
- [ ] å›æ»¾æ­¥é©Ÿæ–‡æª”åŒ–

### **éƒ¨ç½²æ­¥é©Ÿ**
1. **å‚™ä»½ç•¶å‰ç‰ˆæœ¬**
2. **éƒ¨ç½²æ–°ä»£ç¢¼**
3. **åŸ·è¡Œé©—è­‰æ¸¬è©¦**
4. **ç›£æ§é—œéµæŒ‡æ¨™**
5. **ç¢ºèªåŠŸèƒ½æ­£å¸¸**

### **éƒ¨ç½²å¾Œé©—è­‰**
- [ ] åŸºæœ¬åŠŸèƒ½æ¸¬è©¦
- [ ] æ€§èƒ½æŒ‡æ¨™æª¢æŸ¥
- [ ] è¦–è¦ºæ•ˆæœç¢ºèª
- [ ] ç”¨æˆ¶åé¥‹æ”¶é›†

---

## ğŸ“ **è¯çµ¡è³‡è¨Šèˆ‡æ”¯æ´**

### **å°ˆæ¡ˆè² è²¬äºº**
- **é–‹ç™¼**: Claude Code AI Assistant
- **æŠ€è¡“å¯©æŸ¥**: å¾…æŒ‡å®š
- **æ¸¬è©¦**: å¾…æŒ‡å®š

### **ç·Šæ€¥è¯çµ¡**
- **å›æ»¾æ±ºç­–**: å°ˆæ¡ˆè² è²¬äºº
- **æŠ€è¡“æ”¯æ´**: é–‹ç™¼åœ˜éšŠ
- **æ¥­å‹™å½±éŸ¿è©•ä¼°**: ç”¢å“åœ˜éšŠ

---

**è¨ˆç•«ç‹€æ…‹**: âœ… æº–å‚™å°±ç·’ï¼Œéœå¾…åŸ·è¡ŒæŒ‡ä»¤
**é è¨ˆå®Œæˆæ™‚é–“**: 1.5-2å€‹å·¥ä½œæ—¥
**é¢¨éšªç­‰ç´š**: ğŸŸ¢ ä½é¢¨éšªï¼Œé«˜ç¢ºå®šæ€§æˆåŠŸç‡