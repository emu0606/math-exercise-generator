# 防參差佈局引擎實施計畫

> **專案**: 數學測驗生成器佈局引擎優化
> **計畫版本**: v1.0
> **建立時間**: 2025-09-14
> **計畫類型**: 最小侵入式修復方案

---

## 📋 **專案概述**

### **核心目標**
實現同一行內所有題目必須有相同高度的佈局機制，徹底解決視覺參差問題。

### **技術方案**
採用**方案A：行高度鎖定機制** + **最小侵入式修復**，基於已驗證的測試版引擎邏輯。

### **預期效果**
- **視覺品質**: 100%消除混合高度問題
- **空間利用率**: 保持81.2%以上利用率
- **系統穩定性**: 最小改動風險，最大化向後相容

---

## 🎯 **實施策略總覽**

### **核心發現**
1. **預排序框架完善**: `question_distributor.py` 已具備完整排序基礎
2. **Bug定位準確**: `layout.py` 問題集中在 `_get_existing_question_height()` 方法
3. **測試版邏輯驗證**: 六種測試案例100%通過，邏輯可靠

### **最小改動原則**
- 只修復關鍵Bug，不改變整體架構
- 保持現有介面和工作流程不變
- 基於測試版驗證的純淨邏輯

---

## 📅 **詳細實施時程**

### **Phase 1: 預排序優化** *(Day 1 上午，4小時)*

#### **目標**: 完善 question_distributor.py 的預排序機制

#### **任務清單**:
- [ ] **任務1.1**: 新增 `sort_by_height_then_size()` 方法
  - **位置**: `utils/orchestration/question_distributor.py:436`
  - **功能**: 實現"高度優先，尺寸次要"的複合排序
  - **估時**: 1小時

- [ ] **任務1.2**: 修改回合內排序邏輯
  - **位置**: `utils/orchestration/question_distributor.py:503`
  - **修改**: 整合新排序方法到配置控制
  - **估時**: 1小時

- [ ] **任務1.3**: 測試預排序功能
  - **方法**: 單獨測試排序結果
  - **驗證**: 確保height=1題目優先處理
  - **估時**: 2小時

#### **關鍵程式碼**:
```python
@staticmethod
def sort_by_height_then_size(questions: List[Dict[str, Any]], ascending: bool = True) -> List[Dict[str, Any]]:
    """按高度優先、尺寸次要排序（方案A預排序邏輯）"""
    def get_height_and_size(question: Dict[str, Any]) -> Tuple[int, int]:
        size = question.get('size', 1)
        size_value = size.value if hasattr(size, 'value') else size

        # 尺寸到高度映射
        size_map = {1: 1, 2: 1, 3: 2, 4: 2, 5: 2, 6: 2}
        height = size_map.get(size_value, 1)

        return (height, size_value)

    return sorted(questions, key=get_height_and_size, reverse=not ascending)
```

---

### **Phase 2: 佈局引擎修復** *(Day 1 下午，4小時)*

#### **目標**: 修復 layout.py 中的關鍵Bug

#### **任務清單**:
- [ ] **任務2.1**: 擴展 GridManager 狀態追蹤
  - **位置**: `utils/core/layout.py:56-70`
  - **新增**: `row_locked_heights` 陣列追蹤
  - **估時**: 1小時

- [ ] **任務2.2**: 修復 `_get_existing_question_height()` 方法
  - **位置**: `utils/core/layout.py:280-311`
  - **策略**: 使用行鎖定狀態而非錯誤的掃描邏輯
  - **估時**: 1.5小時

- [ ] **任務2.3**: 更新放置邏輯
  - **位置**: `utils/core/layout.py:115-141`
  - **功能**: 在放置時更新行鎖定狀態
  - **估時**: 1小時

- [ ] **任務2.4**: 單元測試驗證
  - **內容**: 測試行高度鎖定機制
  - **估時**: 0.5小時

#### **關鍵修復邏輯**:
```python
class GridManager:
    def __init__(self, grid_width: int = 4, grid_height: int = 8):
        # 現有程式碼...
        # 新增：行高度鎖定狀態追蹤
        self.row_locked_heights = [-1] * grid_height  # -1表示未鎖定

    def place_at(self, page: int, row: int, col: int, width_cells: int, height_cells: int) -> None:
        # 現有放置邏輯...
        # 新增：更新行鎖定狀態
        for r in range(row, row + height_cells):
            if r < len(self.row_locked_heights):
                self.row_locked_heights[r] = height_cells

def _get_existing_question_height(self, grid_manager: GridManager,
                                page: int, row: int, col: int) -> int:
    """修復版：直接從行鎖定狀態獲取高度"""
    if not hasattr(grid_manager, 'row_locked_heights'):
        return 0  # 向後相容

    if 0 <= row < len(grid_manager.row_locked_heights):
        locked_height = grid_manager.row_locked_heights[row]
        return locked_height if locked_height != -1 else 0

    return 0
```

---

### **Phase 3: 整合測試與驗證** *(Day 2 上午，4小時)*

#### **目標**: 確保修復後系統穩定運行

#### **任務清單**:
- [ ] **任務3.1**: 單元測試執行
  - **範圍**: 佈局引擎核心功能
  - **指令**: `py -m pytest tests/test_utils/test_geometry/ -v`
  - **估時**: 1小時

- [ ] **任務3.2**: 整合測試
  - **方法**: 完整PDF生成流程測試
  - **工具**: 使用六種測試案例數據
  - **估時**: 2小時

- [ ] **任務3.3**: 對比驗證
  - **基準**: 與測試版引擎結果比較
  - **重點**: 驗證防參差效果
  - **估時**: 1小時

#### **測試檢查清單**:
- [ ] 基礎功能：應用程式正常啟動
- [ ] 題目生成：各種尺寸題目正常生成
- [ ] 佈局效果：無混合高度現象
- [ ] 回合制：多回合功能正常
- [ ] PDF輸出：最終產品品質良好

---

### **Phase 4: 生產部署準備** *(Day 2 下午，2-4小時)*

#### **目標**: 準備生產環境部署

#### **任務清單**:
- [ ] **任務4.1**: 配置優化
  - **位置**: 確保 `preserve_layout_aesthetics = True`
  - **驗證**: 默認啟用新排序邏輯
  - **估時**: 0.5小時

- [ ] **任務4.2**: 日誌完善
  - **內容**: 添加排序和鎖定狀態日誌
  - **目的**: 便於生產監控和調試
  - **估時**: 1小時

- [ ] **任務4.3**: 文檔更新
  - **範圍**: 更新相關技術文檔
  - **內容**: 記錄修復內容和使用方式
  - **估時**: 1小時

- [ ] **任務4.4**: 回滾準備
  - **備份**: 確保修改前代碼備份
  - **方案**: 準備快速回滾步驟
  - **估時**: 0.5小時

---

## 📊 **風險管理計畫**

### **高風險點識別**
| 風險項目 | 風險等級 | 影響範圍 | 緩解策略 |
|---------|---------|---------|---------|
| GridManager狀態衝突 | 🟡 中 | 佈局計算 | 向後相容性檢查 |
| 預排序破壞回合結構 | 🟢 低 | 題目順序 | 回合內排序限制 |
| 性能回歸 | 🟢 低 | 響應時間 | 排序算法簡單高效 |
| 相容性問題 | 🟡 中 | 現有功能 | 漸進式啟用 |

### **回滾機制**
1. **自動備份**: 修改前自動備份關鍵檔案
2. **快速回滾**: 準備一鍵恢復腳本
3. **監控指標**: 設定關鍵性能監控
4. **回滾觸發**: 定義明確的回滾條件

### **測試防護**
- **多層次測試**: 單元→整合→端對端
- **邊界測試**: 極端情況和邊界條件
- **回歸測試**: 確保現有功能不受影響
- **對比驗證**: 與測試版結果比對

---

## 🎯 **成功標準定義**

### **功能性目標**
- [ ] **防參差效果**: 100%消除同行混合高度
- [ ] **空間利用率**: 保持≥80%利用率
- [ ] **功能完整性**: 所有現有功能正常運作
- [ ] **性能水準**: 響應時間不超過基準110%

### **技術性目標**
- [ ] **代碼品質**: 通過所有現有單元測試
- [ ] **向後相容**: 不破壞現有API介面
- [ ] **穩定性**: 連續運行無崩潰
- [ ] **可維護性**: 代碼清晰易懂

### **業務目標**
- [ ] **用戶體驗**: 視覺品質明顯提升
- [ ] **系統可靠性**: 無功能回歸
- [ ] **部署風險**: 零停機時間部署

---

## 📚 **技術參考資料**

### **關鍵檔案列表**
- `utils/orchestration/question_distributor.py` - 預排序邏輯
- `utils/core/layout.py` - 佈局引擎核心
- `clean_layout_test.py` - 測試版參考實現
- `docs/防參差佈局機制設計方案.md` - 設計理論基礎

### **測試資料**
- `test_clean_*.html` - 六種驗證測試案例
- 邊界測試：32格精確填滿
- 極端測試：SMALL到EXTRA混合
- 順序測試：預排序vs無排序對比

### **相關文檔**
- [方案A理論設計](docs/防參差佈局機制設計方案.md)
- [測試版實現分析](clean_layout_test.py)
- [現有架構分析](docs/layout_engine_comparison.md)

---

## 🚀 **部署檢查清單**

### **部署前確認**
- [ ] 所有任務完成並測試通過
- [ ] 代碼審查完成
- [ ] 備份機制就位
- [ ] 監控指標設定完成
- [ ] 回滾步驟文檔化

### **部署步驟**
1. **備份當前版本**
2. **部署新代碼**
3. **執行驗證測試**
4. **監控關鍵指標**
5. **確認功能正常**

### **部署後驗證**
- [ ] 基本功能測試
- [ ] 性能指標檢查
- [ ] 視覺效果確認
- [ ] 用戶反饋收集

---

## 📞 **聯絡資訊與支援**

### **專案負責人**
- **開發**: Claude Code AI Assistant
- **技術審查**: 待指定
- **測試**: 待指定

### **緊急聯絡**
- **回滾決策**: 專案負責人
- **技術支援**: 開發團隊
- **業務影響評估**: 產品團隊

---

**計畫狀態**: ✅ 準備就緒，靜待執行指令
**預計完成時間**: 1.5-2個工作日
**風險等級**: 🟢 低風險，高確定性成功率