# 生成器檔案結構規範

> **目標**: 統一所有生成器的檔案結構、命名規範、導入順序
> **建立日期**: 2025-09-29
> **更新日期**: 2025-09-30
> **狀態**: 已更新為現代架構標準

## 🌟 **現代生成器架構理念**

### **核心設計原則**
1. **確定性生成**: 使用預篩選避免隨機失敗，保證每次生成都成功
2. **職責分離**: UI層驗證輸入，生成器專注業務邏輯
3. **統一錯誤處理**: 基類提供標準錯誤處理，生成器只需實作核心邏輯
4. **教師友善**: 代碼簡潔易讀，避免過度工程化

### **與傳統架構的差異**
| 項目 | 傳統做法 | 現代做法 |
|------|---------|---------|
| 錯誤處理 | 每個生成器自行處理 | 基類統一處理 |
| 參數驗證 | 生成器內重複驗證 | UI層驗證，生成器信任 |
| 生成策略 | 隨機生成→檢查→重試 | 預篩選有效組合→確定性選擇 |
| 主要方法 | `generate_question()` | `_generate_core_question()` |

## 📋 **標準檔案結構**

### **完整檔案模版**
```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""模組功能描述

詳細說明生成器的用途、適用範圍、技術特點。
包含使用範例和重要注意事項。

Example:
    >>> generator = XxxGenerator()
    >>> question = generator.generate_question()
    >>> print(question['question'])
    題目內容範例
"""

# === 導入區塊 ===
# 1. 標準庫導入
import random
import math
from typing import Dict, Any, Optional, List

# 2. 第三方庫導入
from sympy import sin, cos, latex
import numpy as np

# 3. 專案內部導入
from utils import get_logger
from generators.base import QuestionGenerator, QuestionSize, register_generator

# === 全域變數區塊 ===
logger = get_logger(__name__)

# === 生成器類別定義 ===
@register_generator
class XxxGenerator(QuestionGenerator):
    """生成器類別描述

    詳細的功能說明、參數描述、返回值格式。

    Args:
        options (Dict[str, Any], optional): 配置選項
            param1 (type): 參數1說明
            param2 (type): 參數2說明

    Returns:
        Dict[str, Any]: 完整題目資訊

    Example:
        >>> generator = XxxGenerator()
        >>> question = generator.generate_question()
    """

    # === 類別常數區塊 ===
    CONSTANT_VALUES = {}
    TEMPLATE_DICT = {}

    # === 初始化方法 ===
    def __init__(self, options: Dict[str, Any] = None):
        """初始化生成器"""
        super().__init__(options)
        self.logger = get_logger(self.__class__.__name__)

        # 配置處理邏輯

    # === 配置相關方法 ===
    @classmethod
    def get_config_schema(cls) -> Dict[str, Any]:
        """動態配置UI描述（可選）

        僅當生成器需要UI配置時實作此方法。
        ConfigFactory會處理所有輸入驗證，生成器無需重複驗證。
        """

    # === 核心生成方法 ===
    def _generate_core_question(self) -> Dict[str, Any]:
        """核心生成邏輯，實現具體的題目生成

        注意：基類QuestionGenerator已實作統一的generate_question()
        含完整錯誤處理，生成器只需實作此方法。
        """

    # === 預篩選方法（如需要）===
    def _build_valid_combinations(self) -> None:
        """預先建立所有數學上有效的參數組合

        確定性生成設計：避免隨機失敗，保證每次生成都成功。
        適用於有數學約束條件的生成器。
        """

    def _is_valid(self, params) -> bool:
        """驗證參數組合是否符合數學要求

        用於預篩選階段，而非生成後驗證。
        """

    # === 輔助私有方法 ===
    def _helper_method_1(self) -> Any:
        """輔助方法1"""

    def _helper_method_2(self) -> Any:
        """輔助方法2"""

    # === 後備方法 ===
    def _get_fallback_question(self) -> Dict[str, Any]:
        """後備題目，當核心生成失敗時使用

        提供一個固定的安全題目，確保系統穩定性。
        """

    # === 基類方法實作區塊 ===
    def get_grade(self) -> str:
        """獲取適用年級"""

    def get_category(self) -> str:
        """獲取題目主類別"""

    def get_subcategory(self) -> str:
        """獲取題目子類別"""

    def get_subject(self) -> str:
        """獲取科目"""

    def get_difficulty(self) -> str:
        """獲取難度等級"""

    def get_question_size(self) -> int:
        """獲取題目顯示大小"""

    def get_figure_data_question(self) -> Optional[Dict[str, Any]]:
        """獲取題目圖形數據

        Returns:
            Dict[str, Any] | None: 圖形配置字典，包含：
                - type (str): 圖形類型
                - params (dict): 圖形參數
                - layout_question (dict, optional): 佈局參數
                    - width_ratio (float): 圖形寬度比例 (0.0 ~ 1.0)

        Example:
            return {
                'type': 'function_plot',
                'params': {'expression': 'x**2'},
                'layout_question': {'width_ratio': 0.50}  # 可選
            }
        """

    def get_figure_data_explanation(self) -> Optional[Dict[str, Any]]:
        """獲取解釋圖形數據

        Returns:
            Dict[str, Any] | None: 圖形配置字典，包含：
                - type (str): 圖形類型
                - params (dict): 圖形參數
                - layout_explanation (dict, optional): 佈局參數
                    - width_ratio (float): 圖形寬度比例 (0.0 ~ 1.0)

        Example:
            return {
                'type': 'function_plot',
                'params': {'expression': 'x**2', 'show_details': True},
                'layout_explanation': {'width_ratio': 0.75}  # 可選
            }
        """

    def get_figure_position(self) -> str:
        """獲取題目圖形位置

        Returns:
            str: 有效值 "right" (預設), "left", "bottom", "none"
        """

    def get_explanation_figure_position(self) -> str:
        """獲取解釋圖形位置

        Returns:
            str: 有效值 "right" (預設), "bottom", "none" (不支援 "left")
        """
```

---

## 📦 **導入順序規範**

### **標準導入順序**
1. **標準庫**: Python內建模組
2. **第三方庫**: 外部安裝的套件
3. **專案內部**: 本專案的模組

### **具體範例**
```python
# 1. 標準庫 - 按字母順序
import math
import random
from typing import Dict, Any, Optional, List, Tuple

# 2. 第三方庫 - 按重要性排序
from sympy import sin, cos, tan, pi, latex, simplify
import numpy as np
import matplotlib.pyplot as plt

# 3. 專案內部 - 按相依性排序
from utils import get_logger, global_config
from generators.base import QuestionGenerator, QuestionSize, register_generator
```

### **導入注意事項**
- 避免 `import *` 通配符導入
- 長導入清單使用括號換行
- 相同模組的多個導入合併在一行
- 條件導入放在方法內部

---

## 🏷️ **命名規範**

### **類別命名**
- 使用 `PascalCase`
- 以 `Generator` 結尾
- 描述性名稱，避免縮寫

```python
# ✅ 正確
class LinearEquationGenerator(QuestionGenerator):
class TrigonometricFunctionGenerator(QuestionGenerator):

# ❌ 錯誤
class LEGen(QuestionGenerator):
class trigGenerator(QuestionGenerator):
```

### **方法命名**
- 使用 `snake_case`
- 私有方法以 `_` 開頭
- 動詞開頭，描述功能

```python
# ✅ 正確
def generate_question(self) -> Dict[str, Any]:
def _validate_config(self, options: Dict[str, Any]) -> None:
def _get_fallback_question(self) -> Dict[str, Any]:

# ❌ 錯誤
def genQ(self):
def ValidateConfig(self, options):
def fallback(self):
```

### **變數命名**
- 使用 `snake_case`
- 描述性名稱
- 常數使用 `UPPER_CASE`

```python
# ✅ 正確
max_attempts = 20
question_types = ["linear", "quadratic"]
DEFAULT_DIFFICULTY = "MEDIUM"

# ❌ 錯誤
maxAttempts = 20
qTypes = ["linear", "quadratic"]
default_difficulty = "MEDIUM"
```

---

## 📝 **文檔字串標準**

### **模組文檔字串**
```python
"""生成器功能簡述

詳細描述模組的用途、適用範圍、主要特點。
說明數學邏輯和教學目標。

主要特色：
- 特色1描述
- 特色2描述
- 特色3描述

Example:
    >>> generator = XxxGenerator()
    >>> question = generator.generate_question()
    >>> print(question['question'])
    題目內容範例

技術架構：
    說明採用的技術方案和設計理念。
"""
```

### **類別文檔字串**
```python
class XxxGenerator(QuestionGenerator):
    """生成器類別簡述

    詳細的功能說明，包含數學邏輯和教學目標。

    Args:
        options (Dict[str, Any], optional): 配置選項
            param1 (type): 參數1說明，預設值
            param2 (type): 參數2說明，預設值

    Returns:
        Dict[str, Any]: 完整題目資訊字典
            question (str): 題目LaTeX字串
            answer (str): 答案LaTeX字串
            explanation (str): 解釋LaTeX字串

    Example:
        >>> generator = XxxGenerator()
        >>> question = generator.generate_question()
        >>> print(question['answer'])
        $x = 2$

    Attributes:
        重要屬性說明（如有需要）
    """
```

### **方法文檔字串**
```python
def method_name(self, param: type) -> type:
    """方法功能簡述

    詳細說明方法的作用、數學原理（如適用）。

    Args:
        param (type): 參數說明

    Returns:
        type: 返回值說明

    Raises:
        ExceptionType: 例外情況說明（如適用）

    Example:
        >>> result = generator.method_name(value)
        >>> print(result)
        預期輸出

    Note:
        重要提醒或注意事項（如適用）
    """
```

---

## 🔧 **代碼組織規範**

### **方法順序**
1. **類別常數**: `CONSTANT_VALUES`, `EXPLANATION_TEMPLATES`
2. **初始化方法**: `__init__`
3. **配置相關**: `get_config_schema` (可選)
4. **核心生成**: `_generate_core_question`
5. **預篩選方法**: `_build_valid_combinations`, `_is_valid` (如需要)
6. **輔助私有方法**: 按邏輯分組
7. **後備方法**: `_get_fallback_question`
8. **基類方法實作**: 按照基類定義順序

**注意**:
- 不要實作 `generate_question()`，基類已提供統一實作
- 不要在生成器內驗證 UI 傳入的配置（ConfigFactory 已驗證）
- 避免生成後驗證結果（使用預篩選確保生成前就是有效的）

### **區塊分隔**
```python
# === 區塊標題 ===
# 使用等號分隔不同功能區塊

class XxxGenerator(QuestionGenerator):
    # === 類別常數區塊 ===
    CONSTANTS = {}

    # === 初始化方法 ===
    def __init__(self, options: Dict[str, Any] = None):

    # === 核心生成方法 ===
    def generate_question(self) -> Dict[str, Any]:
```

### **空行規範**
- 類別定義前後各2行空行
- 方法定義前後各1行空行
- 邏輯區塊間用1行空行分隔
- 區塊分隔註解前後各1行空行

---

## ⚠️ **常見錯誤避免**

### **架構錯誤（新增）**
1. **❌ 重新實作 `generate_question()`**: 基類已提供統一實作
2. **❌ 生成器內驗證配置**: UI層（ConfigFactory）已經驗證
3. **❌ 依賴重試機制**: 應使用預篩選確保確定性生成
4. **❌ 生成後驗證結果**: 預篩選階段就應該保證有效

### **結構錯誤**
1. **導入順序混亂**: 第三方庫和標準庫混合
2. **方法順序錯誤**: 基類方法散落在各處
3. **缺少區塊分隔**: 所有方法混在一起
4. **方法命名錯誤**: 使用 `_generate_core_logic()` 而非 `_generate_core_question()`

### **命名錯誤**
1. **縮寫過度**: `gen_q()` 而非 `_generate_core_question()`
2. **駝峰命名混用**: 方法名用 `PascalCase`
3. **常數命名錯誤**: 使用小寫常數

### **文檔錯誤**
1. **缺少類型提示**: 參數和返回值沒有標註類型
2. **文檔字串過簡**: 只有一行說明
3. **範例錯誤**: 程式碼範例無法執行

### **設計錯誤（新增）**
1. **過度驗證**: 在 `__init__()` 中用 `isinstance()` 檢查類型
2. **使用複雜 Pydantic**: 簡單配置用複雜模型驗證
3. **隨機生成+重試**: 未使用預篩選機制導致不穩定

---

## 📊 **檢查清單**

### **現代架構檢查（新增）**
- [ ] 只實作 `_generate_core_question()`，不重新實作 `generate_question()`
- [ ] `__init__()` 使用簡單 `options.get()`，無 isinstance 驗證
- [ ] 有數學約束時使用預篩選機制 `_build_valid_combinations()`
- [ ] 實作 `_get_fallback_question()` 提供安全後備題目
- [ ] 不在生成器內驗證 UI 傳入的配置

### **檔案結構檢查**
- [ ] 檔案頭部包含編碼聲明
- [ ] 模組文檔字串完整
- [ ] 導入順序正確（標準庫→第三方→專案內部）
- [ ] 區塊分隔清楚
- [ ] 方法順序符合規範

### **命名規範檢查**
- [ ] 類別名稱使用 `PascalCase` 並以 `Generator` 結尾
- [ ] 方法名稱使用 `snake_case`
- [ ] 私有方法以 `_` 開頭
- [ ] 常數使用 `UPPER_CASE`
- [ ] 變數名稱有描述性

### **文檔完整性檢查**
- [ ] 所有公開方法有文檔字串
- [ ] 參數和返回值有類型標註
- [ ] 包含實用的程式碼範例
- [ ] 重要注意事項有說明
- [ ] 使用 Google Style docstring 格式

### **代碼品質檢查**
- [ ] 沒有冗餘的導入
- [ ] 方法長度適中（< 50行）
- [ ] 複雜邏輯有註解說明
- [ ] 使用 `get_logger(__name__)` 而非 print
- [ ] LaTeX 使用命令而非 Unicode 符號

---

## 📚 **參考文檔**

- [生成器開發指南.md](生成器開發指南.md) - 完整開發流程和最佳實踐
- [代碼註解規範.md](代碼註解規範.md) - 註解和文檔撰寫標準

**典範生成器參考**:
- `generators/algebra/double_radical_simplification.py` - 預篩選機制範例
- `generators/trigonometry/InverseTrigonometricFunctionGenerator.py` - 簡潔配置範例
- `generators/trigonometry/TrigAngleConversionGenerator.py` - percentage_group 配置範例

---

**結論**: 遵循現代化的檔案結構標準，確保確定性生成、職責分離、統一錯誤處理，提升代碼的可讀性、可維護性和教師友善度。