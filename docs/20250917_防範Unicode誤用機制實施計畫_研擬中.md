# 防範Unicode誤用機制實施計畫

> **日期**: 2025-09-17
> **狀態**: 研擬中
> **優先級**: 中 (系統性改進)
> **影響範圍**: 全項目LaTeX輸出品質
> **觸發原因**: 三角反函數生成器重寫中發現`ANGLE_FORMAT = r'{angle}°'`設計錯誤

## 🚨 問題識別

### **Unicode誤用的系統性風險**
在開發三角反函數生成器時，發現了典型的Unicode符號誤用問題：

```python
# ❌ 危險的設計
ANGLE_FORMAT = r'{angle}°'  # Unicode度數符號，LaTeX中會顯示錯誤

# ✅ 正確的做法
f"${angle}^\\circ$"        # LaTeX環境中的正確度數符號
```

### **核心問題分析**
1. **AI系統容易誤用**: 直觀想到Unicode符號 (°×±√π∞)
2. **開發者慣性錯誤**: 複製貼上Unicode符號，未考慮LaTeX環境
3. **檢查困難**: 開發時很難察覺，只有PDF編譯後才發現
4. **維護成本**: 錯誤累積後需要大量修正工作

### **常見誤用符號清單**

#### **Unicode符號錯誤**
| ❌ Unicode | ✅ LaTeX       | 錯誤後果        |
|-----------|----------------|----------------|
| °         | `^\circ`       | 顯示 "°" 文字  |
| ×         | `\times`       | 顯示 "×" 文字  |
| ±         | `\pm`          | 顯示 "±" 文字  |
| √         | `\sqrt{}`      | 顯示 "√" 文字  |
| π         | `\pi`          | 顯示 "π" 文字  |
| ∞         | `\infty`       | 顯示 "∞" 文字  |

#### **LaTeX轉義錯誤** (新增)
| ❌ 錯誤轉義 | ✅ 正確轉義 | 錯誤後果 |
|------------|------------|---------|
| `^\\\\circ` | `^\\circ` | 度數符號顯示為 "°°" |
| `\\\\sin` | `\\sin` | 函數名顯示為 "ssinsin" |
| `\\\\frac{1}{2}` | `\\frac{1}{2}` | 分數格式錯誤 |
| 單引號內雙反斜線 | LaTeX換行除外保持單反斜線 | PDF顯示可怕效果 |

#### **特殊規則：LaTeX換行保持雙反斜線**
```python
# ✅ 正確：LaTeX換行使用雙反斜線
"\\\\[0.3em]"  # 這是正確的換行格式
```

## 📋 **實施策略**

### **核心原則**
1. **教育優先**: 明確警告Unicode危害，提供清楚的替代方案
2. **工具輔助**: 提供檢查工具但不強制使用
3. **不過度工程化**: 避免複雜的API，讓開發者直接寫LaTeX
4. **實用導向**: 重點解決實際問題，不增加學習負擔

### **三階段實施方案**

#### **階段1: 開發指南建立** (優先級: 高)
- [ ] 在專案文檔中添加 "LaTeX符號使用規範"
- [ ] 建立常用符號對照表
- [ ] 明確警告Unicode符號的危害
- [ ] 提供三角函數專用LaTeX語法參考

#### **階段2: 檢查工具建立** (優先級: 中)
- [ ] 創建 `utils/latex_check.py` 輕量檢查工具
- [ ] 支援單文件檢查功能
- [ ] 提供清楚的問題定位和修正建議
- [ ] 整合到開發工作流程中

#### **階段3: 應用整合** (優先級: 低)
- [ ] 在三角反函數生成器重寫中示範正確用法
- [ ] 可選：添加到CI/CD檢查流程
- [ ] 可選：IDE插件或pre-commit hook

## 🔧 **詳細實施計畫**

### **階段1: 開發指南建立**

#### **1.1 創建LaTeX符號規範文檔**
**位置**: `docs/latex_symbols_guide.md`

**內容結構**:
```markdown
# LaTeX符號使用規範

## ⚠️ 重要警告
絕對不要使用Unicode數學符號！在LaTeX環境中會顯示為錯誤文字。

## 常用符號對照表
[詳細對照表...]

## 三角函數專用語法
[反三角函數標準寫法...]

## 快速檢查方式
python -m utils.latex_check your_file.py
```

#### **1.2 更新主要開發文檔**
**位置**: `CLAUDE.md`

**添加內容**:
```markdown
## 🔧 LaTeX符號使用規範

### 關鍵原則
- 絕對禁止Unicode數學符號 (°×±√π∞)
- 使用正確的LaTeX語法
- 開發完成後執行檢查工具確認

### 快速參考
詳見 docs/latex_symbols_guide.md
```

### **階段2: 檢查工具建立**

#### **2.1 核心檢查工具**
**文件**: `utils/latex_check.py`

**功能設計**:
```python
"""超輕量Unicode檢查工具 - 30行解決問題"""

UNICODE_WARNINGS = {
    '°': '請使用 ^\\circ (度數符號)',
    '×': '請使用 \\times (乘號)',
    '±': '請使用 \\pm (正負號)',
    '√': '請使用 \\sqrt{} (根號)',
    'π': '請使用 \\pi (圓周率)',
    '∞': '請使用 \\infty (無窮大)'
}

# 新增：LaTeX轉義錯誤檢查
LATEX_ESCAPE_PATTERNS = {
    r'\^\\\\circ': '度數符號使用雙反斜線，請改為 ^\\circ',
    r'\\\\\\\\sin': '函數名使用雙反斜線，請改為 \\sin',
    r'\\\\\\\\frac': '分數使用雙反斜線，請改為 \\frac',
    # 排除正確的換行格式
    r'(?<!\\\\)\\\\\\\\(?!\[)': '發現多餘的反斜線轉義'
}

def check_file(filepath):
    """檢查單個文件"""
    # 實施邏輯：逐行掃描，報告問題位置

def main():
    """命令行接口"""
    # 支援: python -m utils.latex_check file.py
```

#### **2.2 工具特色**
- **輕量**: 總共不超過50行代碼
- **直觀**: 清楚報告問題位置和修正建議
- **非侵入**: 只檢查不修改，避免自動修復風險
- **易用**: 單文件檢查，不需要複雜配置

### **階段3: 應用整合**

#### **3.1 在三角反函數生成器中示範**
- [ ] 使用正確的LaTeX語法
- [ ] 添加註解說明選擇原因
- [ ] 作為其他生成器開發的參考模板

#### **3.2 可選的工作流程整合**
```bash
# 開發者可選擇添加到工作流程
python -m utils.latex_check generators/trigonometry/InverseTrigonometricFunctionGenerator.py
```

## 🎯 **成功標準**

### **必要條件**
- [ ] 開發指南包含清楚的Unicode警告和對照表
- [ ] 檢查工具能正確識別所有常見Unicode符號
- [ ] 三角反函數生成器使用正確的LaTeX語法
- [ ] 工具使用簡單，不增加開發負擔

### **品質標準**
- [ ] 文檔清晰易懂，新手能快速學會
- [ ] 檢查工具準確可靠，無誤報
- [ ] 不強制使用，開發者有選擇自由
- [ ] 解決實際問題，不過度工程化

## 📊 **風險評估**

### **實施風險**
- **過度複雜化**: 可能讓簡單問題變複雜
- **使用負擔**: 增加開發者工作量
- **維護成本**: 工具本身需要維護

### **風險控制**
- **保持簡單**: 工具控制在50行以內
- **可選使用**: 不強制整合到開發流程
- **文檔優先**: 重點在教育，工具只是輔助

### **不實施風險**
- **問題累積**: Unicode誤用問題持續出現
- **品質下降**: PDF輸出包含錯誤符號
- **修復成本**: 後期大量修正工作

## 🚀 **實施時程**

### **第一週: 文檔建立**
- Day 1-2: 創建LaTeX符號規範文檔
- Day 3-4: 更新主要開發文檔
- Day 5: 文檔審查和完善

### **第二週: 工具開發**
- Day 1-2: 實作檢查工具核心功能
- Day 3: 測試和功能完善
- Day 4-5: 使用說明和範例

### **第三週: 整合應用**
- Day 1-3: 在三角反函數生成器中示範
- Day 4-5: 測試和文檔更新

## 📚 **參考標準**

### **LaTeX符號標準**
- 基於舊版本InverseTrigonometricFunctionGenerator的正確做法
- 參考標準LaTeX數學環境語法
- 確保PDF編譯正確性

### **工具設計參考**
- 簡單直接，類似lint工具
- 只檢查不修改的安全原則
- 命令行友善的使用方式

---

**計畫狀態**: 研擬中
**核心理念**: 教育 + 工具輔助，避免過度工程化
**預期效果**: 系統性防範Unicode誤用，確保LaTeX輸出品質
**實施原則**: 實用、簡單、不增加開發負擔