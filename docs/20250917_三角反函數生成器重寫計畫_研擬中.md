# 三角反函數生成器典範重寫工作計畫

> **目標**: 建立三角函數生成器開發典範，供其他開發者參考
> **制定日期**: 2025-09-17
> **基於生成器**: InverseTrigonometricFunctionGenerator
> **預期效果**: 從535行 → 180行，建立三角函數生成器標準模板

## 🎯 **重寫目標與原則**

### **核心目標**
1. **建立三角函數典範**: 為三角函數類生成器重寫提供標準模板
2. **修復過度工程化**: 移除535行中的Pydantic過度抽象
3. **角度單位統一**: 移除弧度支援，專注角度運算
4. **教師友善**: 降低學習和維護成本，清晰的數學邏輯
5. **專業輸出**: 確保LaTeX格式正確編譯

### **設計原則** (基於雙重根號成功經驗 + 註解標準理念)
1. **LaTeX模版化**: 正確格式，易於維護
2. **簡潔參數處理**: 移除Pydantic過度工程，使用options.get()
3. **清晰邏輯分離**: 數學邏輯與系統框架分開
4. **穩定異常處理**: 保留新版優勢，確保不崩潰
5. **Sphinx文檔友善**: 提供完整API文檔
6. **有效註解策略**: 防止「代碼說bug話」，自然語言與機器語言互相配合

## 📋 **具體改進項目**

### **A. 新增功能需求**

#### **A1. 年級分類系統** (仿照雙重根號成功實施)
- **需求**: 新增 `grade` 鍵，標註題目適用年級
- **年級定位**: 高一下學期 (G10S2) - 三角反函數適用年級
- **編碼格式**: `G10S2` (簡潔格式，適合系統處理)
- **實施方式**: 在 `_get_standard_metadata()` 中添加
- **參考**: 雙重根號生成器的成功實施經驗

#### **A2. Sphinx友善文檔** (完全仿照雙重根號格式)
- **當前問題**: docstring 不符合Sphinx標準
- **改進方向**: 完全仿照雙重根號生成器的文檔格式
  ```python
  """三角反函數題目生成器

  生成形如 arcsin(a), arccos(b), arctan(c) 的三角反函數計算題目。

  Args:
      options (Dict[str, Any], optional): 生成器配置選項
          max_value (int): 函數輸入值最大範圍，預設10
          max_attempts (int): 最大嘗試次數，預設100
          allow_arcsin (bool): 是否允許arcsin題型，預設True
          allow_arccos (bool): 是否允許arccos題型，預設True
          allow_arctan (bool): 是否允許arctan題型，預設True

  Returns:
      Dict[str, Any]: 包含題目、答案、解釋等完整資訊

  Example:
      >>> generator = InverseTrigonometricFunctionGenerator()
      >>> question = generator.generate_question()
      >>> print(question['question'])
      計算：$\\arcsin(0.5)$
  """
  ```

### **B. 問題修復項目**

#### **B1. 角度單位簡化** (新增重點)
- **問題**: 角度/弧度雙支援增加不必要複雜性
- **用戶需求**: "先不要支援弧度，以角度為主好了"
- **解決方案**: 移除 `AngleUnit` 枚舉，統一使用角度
- **效益**: 降低邏輯複雜度15行，提升維護性

#### **B2. Pydantic過度工程移除** (最重要)
- **問題**: 230行代碼處理6個簡單參數
- **膨脹比例**: 過度工程化，2.8倍代碼膨脹 (190→535行)
- **解決方案**: 改用簡單的 `options.get()` 方式 (仿照雙重根號成功經驗)
- **移除清單**:
  - `InverseTrigParams` 類別 (~100行)
  - `TrigFunction` 枚舉 (~20行)
  - `OutputFormat` 枚舉 (~15行)
  - 所有 `@validator` 裝飾器 (~80行)

#### **B3. 邏輯分散重新整合**
- **問題**: 原本清晰的數學邏輯被分解到多個類別中
- **影響**: 維護困難，理解成本高
- **解決方案**: 恢復舊版本190行的直接數學邏輯
- **參考**: 雙重根號生成器的邏輯清晰性

### **C. LaTeX模版優化**

#### **C1. 現代Python + LaTeX最佳實踐** (基於場景適配原則)
- **核心原則**: 基礎招式處理簡單場景，複雜場景才用高級技術
- **實施策略**: 基於舊版本正確做法 + 現代f字串語法

  ```python
  # ✅ 基礎招式 - f字串處理簡單場景
  def _generate_question(self):
      func_type = random.choice(['sin', 'cos', 'tan'])
      value = self._generate_value(func_type)
      result = self._calculate_result(func_type, value)

      # 直接使用f字串 + 雙反斜線 (現代標準做法)
      question = f"計算：$\\{func_type}^{{-1}}({value})$"
      answer = f"${result}^\\circ$"

      return {
          'question': question,
          'answer': answer,
          'explanation': self._build_explanation(func_type, value, result)
      }

  # ✅ 華麗大招 - 複雜解釋才用模板 (如果需要的話)
  def _build_explanation(self, func_type, value, result):
      # 簡單解釋仍用f字串
      if self._is_simple_case(value):
          return f"因為 $\\{func_type}({result}^\\circ) = {value}$，" \
                 f"所以 $\\{func_type}^{{-1}}({value}) = {result}^\\circ$"

      # 複雜解釋才考慮模板系統
      # return self._use_complex_template(...)
  ```

#### **C2. LaTeX符號標準化** (實用導向)
- **標準化原則**: 防範Unicode誤用，確保正確性
  ```python
  # 在需要的地方定義常數 (不過度抽象)
  def _format_inverse_function(self, func_name):
      return f"\\{func_name}^{{-1}}"  # 直接返回LaTeX字串

  def _format_angle(self, degrees):
      return f"${degrees}^\\circ$"   # 現代f字串 + 雙反斜線
  ```

#### **C3. 技術選擇指南** (場景適配)
- **基礎招式適用場景**:
  - 字串內容固定，只替換數值
  - 變化點少於3個
  - 邏輯簡單直接

- **高級技術適用場景**:
  - 多種格式變化 (>5種)
  - 複雜的條件邏輯
  - 需要被非程式人員編輯的內容

- **實施原則**: **該用基礎招式的時候用基礎招式，該用華麗大招的時候用華麗大招**

## 📅 **實施階段劃分** (基於典範4-Phase結構)

### **Phase 1: 分析與設計** (預估15分鐘)
1. **詳細分析現有問題** (5分鐘)
   - 統計535行中各部分行數分布
   - 分析Pydantic過度抽象的具體位置
   - 確定角度/弧度雙支援的冗餘程度

2. **設計簡化架構** (7分鐘)
   - 設計options.get()參數處理方式 (參考雙重根號)
   - 確定三角函數專用LaTeX符號標準
   - 規劃年級分類系統 (G10S2)

3. **確定API設計** (3分鐘)
   - 設計Sphinx友善的docstring (完全仿照雙重根號格式)
   - 確定方法簽名和返回值
   - 添加詳盡註解計畫

### **Phase 2: 核心重寫** (預估30分鐘)
1. **建立基礎架構** (10分鐘)
   - 類定義和Sphinx友善docstring (完全仿照雙重根號)
   - `__init__` 方法簡化 (移除Pydantic，添加技術選擇說明)
   - 基本方法架構 (重點註解數學邏輯和邊界條件)

2. **實施數學邏輯簡化** (15分鐘)
   - 恢復舊版本190行的直接邏輯 (註解確保定義域/值域正確)
   - 移除所有Pydantic相關代碼 (註解說明工具選擇原因)
   - 實現角度單位統一處理 (註解防止弧度/角度混淆錯誤)

3. **LaTeX模版整合** (5分鐘)
   - 建立三角函數專用LaTeX標準 (註解防範Unicode誤用)
   - 實現模版填充邏輯 (註解說明f字串vs模板的選擇標準)

### **Phase 3: 功能完善** (預估20分鐘)
1. **年級系統整合** (7分鐘)
   - 實現年級分類邏輯 (G10S2)
   - 添加到元數據中
   - 測試分類正確性

2. **異常處理優化** (8分鐘)
   - 保留新版異常處理優勢 (註解說明新版本的價值)
   - 添加預設題目機制
   - 完善日誌系統

3. **典範化完善** (5分鐘)
   - 添加有效註解 (防止「代碼說bug話」，確保數學邏輯正確)
   - 確保代碼可作為其他三角函數生成器的參考
   - 檢查API完整性

### **Phase 4: 測試與驗證** (預估15分鐘)
1. **功能測試** (8分鐘)
   - 測試三種反函數類型正確性
   - 驗證LaTeX格式無誤
   - 檢查角度計算邏輯

2. **典範價值驗證** (4分鐘)
   - 確認代碼可讀性和可複製性
   - 檢查註解有效性 (是否防止「代碼說bug話」)
   - 驗證與雙重根號生成器風格一致性

3. **對比驗證** (3分鐘)
   - 與原版功能對比
   - 確認代碼行數減少 (535→180行, 66%減少)
   - 驗證性能無退化

## ✅ **成功標準定義**

### **量化指標**
- [ ] **代碼行數**: 從535行減少到180行以下 (>66%減少，超越雙重根號60%目標)
- [ ] **類別簡化**: 從6個類別減少到1個核心類別
- [ ] **參數處理**: 從230行Pydantic代碼減少到5行以內
- [ ] **測試通過率**: 100%通過功能和格式測試

### **質性檢查**
- [ ] **LaTeX格式**: 無HTML標籤，正確LaTeX語法
- [ ] **角度統一**: 移除弧度支援，統一角度處理
- [ ] **文檔品質**: Sphinx能正確生成API文檔
- [ ] **教師友善**: 代碼易讀，參數易改
- [ ] **年級分類**: 正確標註適用年級 (G10S2)

### **典範價值**
- [ ] **架構清晰**: 其他三角函數開發者可輕鬆理解
- [ ] **可複製性**: 可作為其他三角函數生成器重寫模板
- [ ] **最佳實踐**: 展示三角函數LaTeX處理正確做法
- [ ] **維護性**: 後續修改和擴展容易
- [ ] **註解有效**: 防止「代碼說bug話」，確保數學邏輯正確性

## 🔍 **風險評估與控制**

### **主要風險**
1. **函數定義域處理**: arcsin/arccos的定義域限制可能比預期複雜
2. **特殊值映射**: 確保特殊角的輸入值和輸出角度映射正確
3. **LaTeX格式**: 避免Unicode符號誤用，確保正確的數學符號顯示

### **風險控制措施**
1. **參考舊版本**: 舊版本190行已證實可行，直接參考其邏輯
2. **分步驗證**: 每個Phase完成後立即測試
3. **與雙重根號對比**: 持續參考已成功的雙重根號生成器經驗

## 📚 **參考資料**

### **最佳實踐參考**
- `DoubleRadicalSimplificationGenerator`: LaTeX模版化和Sphinx文檔標準
- `archived/InverseTrigonometricFunctionGenerator`: 190行簡潔邏輯參考
- 雙重根號典範重寫工作計畫: 成功的重寫方法論
- `docs/20250916_代碼註解標準與規範_已完成.md`: 防止「代碼說bug話」註解標準

### **技術標準**
- Sphinx文檔格式標準 (完全仿照雙重根號)
- LaTeX三角函數符號最佳實踐 (參考防範Unicode誤用機制)
- 有效註解策略: 自然語言與機器語言互相配合
- Python代碼風格指南

### **相關計畫**
- 本計畫將整合 `20250917_防範Unicode誤用機制實施計畫_研擬中.md`
- 在Phase 2實施過程中示範正確的LaTeX符號使用
- 作為防範Unicode誤用的典範實作案例
- 實踐代碼註解標準的有效註解原則

---

## 📝 **計畫更新記錄**

**2025-09-17 更新**:
- **註解策略修正**: 整合「代碼會說bug話」理念
- **註解標準**: 採用自然語言與機器語言互相配合原則
- **重點調整**: 從「詳盡註解」改為「有效註解」
- **新增參考**: 代碼註解標準與規範文檔

**工作計畫制定完成**，基於雙重根號成功經驗 + 註解標準理念，建立三角函數生成器典範。
**重要更新**: 整合Unicode防範機制和有效註解策略，確保LaTeX輸出品質和代碼可理解性。
**關鍵修正**: 採用場景適配原則 - 基礎招式(f字串)處理簡單場景，華麗大招(模板)處理複雜場景。
**技術理念**: 該用基礎招式的時候用基礎招式，該用華麗大招的時候用華麗大招。
**註解理念**: 防止「代碼說bug話」，自然語言與機器語言互相配合。
**準備狀態**: 討論和調整後開始實施。