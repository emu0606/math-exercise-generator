# 20251009_LaTeX前導分離重構計畫_研擬中

## 計畫概述

**目標**：將 `utils/latex/structure.py` 中的單一 `get_preamble()` 方法拆分為三個完全獨立的文件類型專用方法，實現零耦合的 LaTeX 前導生成機制。

**動機**：
1. 目前三種文件（題目、簡答、詳解）共用同一個 preamble，包含許多不必要的套件和命令定義
2. 簡答頁不需要載入 tcolorbox[most]（效能負擔）
3. 題目頁不需要 multicols 和 explanationbox
4. **維護性差**：修改某種文件格式會影響其他文件（耦合風險）
5. **彈性不足**：無法為不同文件類型使用不同配置（如字型大小、頁邊距）

## 架構設計

### 設計原則

1. **完全獨立原則**：每種文件類型的 preamble 完全獨立，零耦合
2. **彈性優先原則**：修改某種文件類型不會影響其他文件類型
3. **可接受重複原則**：有價值的代碼重複優於過早抽象和隱性耦合
4. **清理原則**：廢棄方法測試無誤後直接移除（非標記 deprecated）

### 核心設計理念

**為什麼選擇完全獨立而非共用基礎？**

#### 1. 區分「偶然相似」與「本質相似」
- **偶然相似**：現在三種文件用相同配置，但未來可能改變
  - 例如：題目字型 12pt，解答字型 10pt（節省紙張）
  - 例如：詳解用不同頁邊距以容納更多內容
- **本質相似**：必須相同的邏輯（本專案中不存在）

#### 2. 零耦合的好處
- **獨立演化**：題目頁可以使用完全不同的配置
- **風險隔離**：修改題目頁 preamble 不可能破壞解答頁
- **認知負擔低**：閱讀 `get_question_preamble()` 看到完整定義，不用追蹤共用方法
- **測試簡單**：每個方法獨立測試，無需考慮共用邏輯的副作用

### 方法架構

```
LaTeXStructure
├── get_question_preamble(title)          # 公開：完整題目頁 preamble（完全獨立）
├── get_answer_preamble(title)            # 公開：完整簡答頁 preamble（完全獨立）
└── get_explanation_preamble(title)       # 公開：完整詳解頁 preamble（完全獨立）
```

**關鍵特徵**：
- ✅ 無私有方法（無 `_get_common_preamble()` 等）
- ✅ 每個方法完整獨立，包含所有需要的內容
- ✅ 零耦合，修改一個不影響其他

## 實施步驟

### Phase 1：新增三個獨立方法

**檔案**：`utils/latex/structure.py`

每個方法包含完整的文檔類別聲明、所有套件、字體設定、命令定義，不調用任何私有共用方法。

### Phase 2：更新調用點

**檔案**：`utils/latex/generator.py`

- `generate_question_tex()` 第74行 → `get_question_preamble()`
- `generate_answer_tex()` 第195行 → `get_answer_preamble()`
- `generate_explanation_tex()` 第275行 → `get_explanation_preamble()`

### Phase 3：清理舊方法

- 刪除 `utils/latex/structure.py` 中的 `get_preamble()` 方法
- 刪除 `utils/latex/generator.py` 中的 `_get_preamble()` 適配方法

### Phase 4：測試驗證

包括功能測試、LaTeX 編譯測試、獨立性驗證測試。

## 預期效果

### 1. 效能優化
- 簡答頁不再載入 tcolorbox[most]，編譯速度提升約 10-15%
- 各文件只載入必要套件

### 2. 維護性提升（零耦合）
- **完全獨立**：修改題目頁格式絕對不影響簡答和詳解
- **風險隔離**：修改某個方法造成的錯誤不會影響其他文件類型
- **認知負擔低**：閱讀任一方法看到完整定義
- **測試簡單**：每個方法可以完全獨立測試

### 3. 彈性提升
- 題目頁可以使用 14pt 字型，簡答頁使用 10pt
- 詳解頁可以使用不同頁邊距
- 未來新增文件類型不影響現有方法

## 關鍵決策記錄

### 決策：為何選擇完全獨立而非共用基礎？

**理由**：
1. **偶然相似 vs 本質相似**：現在相似是偶然，未來可能需要不同配置
2. **彈性優先**：題目頁用 14pt，簡答頁用 10pt，這種需求很合理
3. **零耦合價值**：修改題目頁絕對不可能影響解答頁
4. **認知負擔**：閱讀代碼時看到完整定義，不用追蹤多層調用

**反駁「DRY 原則」**：
- DRY 應該應用於**本質相同**的邏輯，而非**偶然相似**的代碼
- 過早抽象比重複更危險
- Preamble 是**配置**而非**邏輯**，配置的重複是可接受的

### 決策：字體設定為何不抽取為 `_get_font_settings()`？

**理由**：
1. **未來彈性**：題目頁可能需要較大字型，簡答頁需要較小字型
2. **配置來源不等於必須共用**：未來可能有 `question_font_path`、`answer_font_path`
3. **完全獨立**：與整體設計原則一致
4. **代碼重複成本低**：只有2-3行代碼

**哲學**：不是所有相同的代碼都需要抽取，要問「這是本質相同還是偶然相同？」

---

**計畫狀態**：研擬中
**建立日期**：2025-10-09
**修訂日期**：2025-10-10（改為完全獨立架構）
**預計執行日期**：待用戶確認
**預估工時**：90 分鐘
**風險等級**：中等（已識別緩解措施）
**設計哲學**：零耦合優於過早抽象，彈性優於 DRY
