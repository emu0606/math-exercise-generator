# 題目格子右邊界超出問題 - 深度分析

> **日期**: 2025-10-19
> **問題**: 題目文字有時會超出格子右邊界
> **狀態**: 研擬中 - 需謹慎辨證

---

## 📍 問題位置

**檔案**: `utils/latex/generator.py`
**方法**: `generate_question_tex()` (第51-181行)
**關鍵代碼**: 第133-169行

---

## 🔍 TikZ Node 寬度機制深度分析

### **關鍵概念辨析**

#### **TikZ node 的 `text width` 屬性**

根據 TikZ 官方文檔：
```latex
\node[text width=4cm, inner sep=0.2cm] {...}
```

**重要事實**：
- `text width` 指定的是**文字內容區域的寬度**
- `inner sep` 是**額外添加**的內邊距
- 節點的**總寬度** = `text width` + 2 × `inner sep`（左右各一個）

**示意圖**：
```
|<-------------- 節點總寬度 -------------->|
|  inner  |<-- text width -->|  inner     |
|  sep    |   文字內容區域    |  sep       |
| (0.2cm) |     (4cm)        | (0.2cm)    |
|---------|------------------|------------|
         總寬度 = 4 + 0.2 + 0.2 = 4.4cm
```

---

## 📊 當前代碼分析

### **情境1: 無圖形的情況**

#### **當前代碼（第143行，第169行）**
```python
# 第143行
content_width = round(w - 2 * 0.1, 3)  # w是格子寬度

# 第169行
content += f"\\node[anchor=north west, text width={content_width}cm, inner sep={node_inner_sep}] at ({{ {x}+{text_x_offset} }}, {{ {y}+{text_y_offset} }}) {{{question_body}}};\n"
```

**變數定義**：
- `w`: 格子寬度（例如 4.5cm）
- `text_x_offset = 0.1`: 節點起始位置距格子左邊緣的偏移
- `node_inner_sep = "0.2cm"`: TikZ node 的內邊距
- `content_width`: 計算出的 text width 值

#### **當前計算邏輯**
```
假設 w = 4.5cm

計算：
content_width = 4.5 - 2 * 0.1 = 4.3cm

節點位置：
- 起始位置: x + 0.1cm (格子左邊 + 0.1cm)
- text width: 4.3cm
- inner sep: 0.2cm (左右各)

節點佔用寬度計算：
- 節點總寬度 = text_width + 2 × inner_sep
             = 4.3 + 2 × 0.2
             = 4.7cm

實際佔用範圍：
- 左邊界: x + 0.1cm
- 右邊界: x + 0.1 + 4.7 = x + 4.8cm
- 格子右邊界: x + 4.5cm

結論：x + 4.8 > x + 4.5
❌ 超出格子右邊界 0.3cm！
```

---

### **情境2: 圖形在右側的情況**

#### **當前代碼（第141行，第155行）**
```python
# 第141行
text_w = round(text_width_ratio * w, 3)  # text_width_ratio = 0.6

# 第155行（文字節點）
content += f"\\node[anchor=north west, text width={text_w}cm, inner sep={node_inner_sep}] at ({{ {x}+{text_x_offset} }}, {{ {y}+{text_y_offset} }}) {{{question_body}}};\n"

# 第156行（圖形節點）
content += f"\\node[anchor=north east, text width={figure_w}cm, inner sep={node_inner_sep}, align=center] at ({{ {x+w} }}, {{ {y}+{figure_y_offset} }}) {{{resized_figure}}};\n"
```

#### **當前計算邏輯**
```
假設 w = 4.5cm, text_width_ratio = 0.6, figure_width_ratio = 0.35

計算：
text_w = 0.6 × 4.5 = 2.7cm
figure_w = 0.35 × 4.5 = 1.575cm

文字節點：
- 起始位置: x + 0.1cm
- 節點總寬度 = 2.7 + 2 × 0.2 = 3.1cm
- 右邊界: x + 0.1 + 3.1 = x + 3.2cm

圖形節點（anchor=north east）：
- 錨點位置: x + 4.5cm (格子右邊界)
- 節點總寬度 = 1.575 + 2 × 0.2 = 1.975cm
- 左邊界: x + 4.5 - 1.975 = x + 2.525cm

檢查重疊：
文字右邊界 (x + 3.2) vs 圖形左邊界 (x + 2.525)
❌ 文字侵入圖形區域！重疊 0.675cm
```

---

## 🎯 問題根源確認

### **核心問題**

1. **content_width 計算錯誤**：
   ```python
   content_width = round(w - 2 * 0.1, 3)
   ```
   只扣除了左右 `text_x_offset`，**沒有考慮 inner sep 會額外增加節點寬度**

2. **text_w 計算未考慮間距**：
   ```python
   text_w = round(text_width_ratio * w, 3)
   ```
   直接用比例計算，**沒有扣除 offset 和 inner sep**

---

## 💡 修復方案推導

### **方案A：扣除所有邊距（推薦）**

#### **無圖形情況**

**目標**：確保節點不超出格子右邊界

```
已知：
- 格子寬度: w
- 起始位置: x + text_x_offset
- 可用寬度: w - text_x_offset
- 節點總寬度: text_width + 2 × inner_sep

條件：
起始位置 + 節點總寬度 ≤ 格子右邊界
(x + text_x_offset) + (text_width + 2 × inner_sep) ≤ x + w

推導：
text_x_offset + text_width + 2 × inner_sep ≤ w
text_width ≤ w - text_x_offset - 2 × inner_sep

設安全餘量 margin = 0.1cm：
text_width ≤ w - text_x_offset - 2 × inner_sep - margin

建議公式：
content_width = w - text_x_offset - 2 × inner_sep_value - margin
              = w - 0.1 - 2 × 0.2 - 0.1
              = w - 0.6
```

**驗證**（w = 4.5cm）：
```
content_width = 4.5 - 0.6 = 3.9cm
節點總寬度 = 3.9 + 2 × 0.2 = 4.3cm
右邊界 = 0.1 + 4.3 = 4.4cm
格子右邊界 = 4.5cm
餘量 = 4.5 - 4.4 = 0.1cm ✅
```

#### **有圖形情況（右側）**

**目標**：文字和圖形合理分配空間，不重疊不超出

```
已知：
- 格子寬度: w
- 文字起始: x + text_x_offset
- 圖形錨點（右對齊）: x + w
- 預期間距: gap (文字和圖形之間)

分配空間：
可用總寬度 = w - text_x_offset
需扣除: 文字 inner_sep (左), 圖形 inner_sep (右), 中間間距

文字區域:
text_node_total = text_width + inner_sep_left

圖形區域:
figure_node_total = figure_width + inner_sep_right

條件：
text_x_offset + text_node_total + gap + figure_node_total ≤ w

簡化（假設左右 inner_sep 相同）：
text_x_offset + (text_width + inner_sep) + gap + (figure_width + inner_sep) ≤ w
text_width + figure_width ≤ w - text_x_offset - 2×inner_sep - gap

建議分配（gap = 0.2cm）：
text_width = text_ratio × (w - text_x_offset - 2×inner_sep - gap)
figure_width = figure_ratio × (w - text_x_offset - 2×inner_sep - gap)

其中 text_ratio + figure_ratio = 1
```

**驗證**（w = 4.5cm, text_ratio = 0.65, figure_ratio = 0.35）：
```
可用寬度 = 4.5 - 0.1 - 2×0.2 - 0.2 = 3.8cm

text_width = 0.65 × 3.8 = 2.47cm
figure_width = 0.35 × 3.8 = 1.33cm

文字節點總寬 = 2.47 + 0.2 = 2.67cm
圖形節點總寬 = 1.33 + 0.2 = 1.53cm

文字範圍: [0.1, 2.77]
間距: [2.77, 2.97]  (0.2cm gap)
圖形範圍: [2.97, 4.5]  (從右對齊算起: 4.5 - 1.53 = 2.97)

檢查: 2.77 + 0.2 = 2.97 ✅ 完美對齊！
總佔用: 0.1 + 2.67 + 0.2 + 1.53 = 4.5 ✅ 剛好填滿！
```

---

### **方案B：調整 inner sep（不推薦）**

將 `inner sep` 設為 0，直接用 padding 方式處理。

**缺點**：
- 破壞 TikZ 標準語義
- 與其他節點樣式不一致
- 維護困難

---

## 📋 修復計畫（方案A）

### **修改項目**

#### **1. 定義常數**
```python
# 第145-149行之前插入
INNER_SEP_VALUE = 0.2  # cm，與 node_inner_sep 保持一致
SAFETY_MARGIN = 0.1    # cm，安全餘量
TEXT_FIGURE_GAP = 0.2  # cm，文字和圖形間距
```

#### **2. 修改無圖形寬度計算**
```python
# 第143行
# 修改前：
content_width = round(w - 2 * 0.1, 3)

# 修改後：
content_width = round(w - text_x_offset - 2 * INNER_SEP_VALUE - SAFETY_MARGIN, 3)
# = w - 0.1 - 2*0.2 - 0.1 = w - 0.6
```

#### **3. 修改有圖形寬度計算**
```python
# 第141-142行
# 修改前：
text_w = round(text_width_ratio * w, 3)
figure_w = round(figure_width_ratio * w, 3)

# 修改後：
available_width = w - text_x_offset - 2 * INNER_SEP_VALUE - TEXT_FIGURE_GAP
text_w = round(text_width_ratio * available_width, 3)
figure_w = round(figure_width_ratio * available_width, 3)
```

#### **4. 調整比例（可選）**
```python
# 第135, 138行
# 考慮調整比例以更好利用空間
if width_cells == 1:
    text_width_ratio = 0.65  # 從 0.6 提高到 0.65
    figure_width_ratio = 0.35
else:
    text_width_ratio = 0.65
    figure_width_ratio = 0.35
```

---

## ⚠️ 注意事項

1. **bottom 位置的圖形**（第162-164行）：
   - 也使用 `content_width`
   - 應同步修改

2. **left 位置的圖形**（第157-160行）：
   - 同樣需要調整計算邏輯
   - 確保文字不會超出右邊界

3. **測試驗證**：
   - 需要測試各種格子大小（Small, Square, Wide, Medium等）
   - 需要測試有無圖形的情況
   - 需要測試圖形在不同位置（left, right, bottom）

---

## 🔬 驗證方法

### **理論驗證**
針對每種情況計算：
1. 節點起始位置
2. 節點總寬度
3. 節點結束位置
4. 是否超出格子右邊界

### **實際測試**
生成測試 PDF，檢查：
1. 文字是否超出格子
2. 文字和圖形是否重疊
3. 版面是否美觀

---

## ✅ 預期效果

修復後：
- ✅ 文字不會超出格子右邊界
- ✅ 文字和圖形不會重疊
- ✅ 保持適當的間距和餘量
- ✅ 支持所有格子大小和圖形位置

---

**狀態**: 待確認修復計畫後執行
**下一步**: 用戶確認計畫後進行代碼修改
