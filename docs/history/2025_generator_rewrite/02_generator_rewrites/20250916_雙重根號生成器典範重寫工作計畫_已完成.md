# 雙重根號生成器典範重寫工作計畫

> **目標**: 建立生成器開發典範，供其他開發者參考
> **制定日期**: 2025-09-16
> **基於生成器**: DoubleRadicalSimplificationGenerator
> **預期效果**: 從463行 → 180行，修復所有格式和邏輯問題

## 🎯 **重寫目標與原則**

### **核心目標**
1. **建立開發典範**: 為其他生成器重寫提供標準模板
2. **修復關鍵問題**: HTML格式、邏輯錯誤、過度工程化
3. **教師友善**: 降低學習和維護成本
4. **專業輸出**: 確保LaTeX格式正確編譯

### **設計原則**
1. **LaTeX模版化**: 正確格式，易於維護
2. **簡潔參數處理**: 移除Pydantic過度工程
3. **清晰邏輯分離**: 數學邏輯與系統框架分開
4. **穩定異常處理**: 保留新版優勢，確保不崩潰
5. **Sphinx文檔友善**: 提供完整API文檔
6. **詳盡註解說明**: 解釋設計理念，作為未來開發參考模板

## 📋 **具體改進項目**

### **A. 新增功能需求**

#### **A1. 年級分類系統**
- **需求**: 新增 `grade` 鍵，標註題目適用年級
- **年級範圍**: 小一上學期 ~ 高三下學期（共24個學期）
- **編碼格式**: `G10S1` (簡潔格式，適合系統處理)
- **UI轉譯**: 未來UI顯示時轉譯為 `"十年級上學期"` (使用者友善)
- **編碼規則**:
  ```python
  GRADE_MAPPING = {
      "小一上": "G1S1", "小一下": "G1S2",
      "小二上": "G2S1", "小二下": "G2S2",
      # ... 以此類推
      "高一上": "G10S1", "高一下": "G10S2",
      "高二上": "G11S1", "高二下": "G11S2",
      "高三上": "G12S1", "高三下": "G12S2"
  }
  ```
- **當前題目**: 十年級上學期 (G10S1)
- **實施方式**: 在 `_get_standard_metadata()` 中添加

#### **A2. Sphinx友善文檔**
- **當前問題**: docstring 不符合Sphinx標準
- **改進方向**:
  - 使用標準的 `Args:`, `Returns:`, `Example:` 格式
  - 添加完整的類和方法說明
  - 確保與Sphinx autodoc兼容
- **參考格式**:
  ```python
  """雙重根式化簡題目生成器

  生成形如 √(c ± d√e) 的雙重根式，要求學生將其化簡為 √a ± √b 的形式。

  Args:
      options (Dict[str, Any], optional): 生成器配置選項
          max_value (int): 根式內數值最大範圍，預設25
          max_attempts (int): 最大嘗試次數，預設100
          allow_addition (bool): 是否允許加法形式，預設True
          allow_subtraction (bool): 是否允許減法形式，預設True

  Returns:
      Dict[str, Any]: 包含題目、答案、解釋等完整資訊

  Example:
      >>> generator = DoubleRadicalSimplificationGenerator()
      >>> question = generator.generate_question()
      >>> print(question['question'])
      化簡：$\\sqrt{7 + 2\\sqrt{10}}$
  """
  ```

### **B. 問題修復項目**

#### **B1. HTML格式修復**
- **問題**: 解釋中使用 `<br>` 標籤
- **影響**: LaTeX環境中顯示為文字而非換行
- **解決方案**: 使用LaTeX標準換行 `\\\\` 或 `\\\\[間距]`

#### **B2. 邏輯錯誤修復**
- **問題**: 答案與解釋結果不一致
- **現象**: 答案顯示 `$- \sqrt{5} + \sqrt{6}$`，解釋得出 `$\sqrt{6} - \sqrt{5}$`
- **根本原因**: 符號處理邏輯錯誤
- **解決方案**: 統一符號判斷邏輯，確保一致性

#### **B3. Pydantic移除**
- **問題**: 67行代碼處理4個簡單參數
- **膨脹比例**: 過度工程化，2.9倍代碼膨脹
- **解決方案**: 改用簡單的 `options.get()` 方式

### **C. LaTeX模版優化**

#### **C1. 模版簡化原則**
- **當前問題**: 用戶反饋「囉嗦繁瑣」
- **改進方向**:
  1. 減少模版層級：從多層嵌套改為平面化
  2. 合併相似步驟：避免過度細分
  3. 突出關鍵邏輯：著重化簡核心步驟
- **簡化目標**: 從8-10個模版步驟 → 4-5個核心步驟

#### **C2. 模版內容優化**
- **參考基準**: 以舊版詳解長度為基準 (已是取捨後的平衡結果)
- **核心步驟設計**:
  1. **設定假設**: 假設化簡結果
  2. **平方比較**: 兩邊平方並比較係數
  3. **求解參數**: 解出a,b值
  4. **驗證結果**: 確認答案正確性
- **格式要求**:
  - 使用正確LaTeX數學環境
  - 適當的間距控制
  - 清晰的步驟標記

#### **C3. 題目答案模版化考量**
- **當前狀況**: 雙重根號題目格式相對固定，暫無模版化必要
- **預留設計**: 為複雜題型預留模版化架構
- **實施標準**:
  ```python
  # 預留模版化接口，但當前不實施
  QUESTION_TEMPLATES = {
      # 未來如有需要可擴展
  }
  ANSWER_TEMPLATES = {
      # 未來如有需要可擴展
  }
  ```

## 📅 **實施階段劃分**

### **Phase 1: 分析與設計** (預估20分鐘)
1. **詳細分析現有問題** (5分鐘)
   - 檢查HTML格式具體位置
   - 分析邏輯錯誤的根本原因
   - 統計Pydantic冗餘代碼行數

2. **設計簡化模版** (10分鐘)
   - 設計4-5個核心步驟模版
   - 確定LaTeX格式規範
   - 規劃年級分類系統

3. **確定API設計** (5分鐘)
   - 設計Sphinx友善的docstring
   - 確定方法簽名和返回值
   - ~~規劃向後兼容性~~ (移除：重寫目的就是改善，無需考慮向後兼容)

### **Phase 2: 核心重寫** (預估35分鐘)
1. **建立基礎架構** (10分鐘)
   - 類定義和Sphinx友善docstring
   - `__init__` 方法簡化 (移除Pydantic，添加設計理念註解)
   - 基本方法架構 (每個方法都要有設計說明註解)

2. **實施LaTeX模版** (15分鐘)
   - 創建簡化的 `EXPLANATION_TEMPLATES` (參考舊版長度平衡)
   - 實現模版填充邏輯 (詳細註解說明模版化的好處)
   - 測試LaTeX格式正確性 (註解說明LaTeX vs HTML的差異)

3. **核心算法遷移** (10分鐘)
   - 從舊版複製核心數學邏輯 (註解說明為什麼選擇舊版)
   - 修復邏輯錯誤 (詳細註解說明錯誤原因和修復方法)
   - 整合異常處理 (註解說明新版異常處理的價值)

### **Phase 3: 功能完善** (預估25分鐘)
1. **年級系統整合** (10分鐘)
   - 實現年級分類邏輯
   - 添加到元數據中
   - 測試分類正確性

2. **異常處理優化** (10分鐘)
   - 保留新版異常處理優勢
   - 添加預設題目機制
   - 完善日誌系統

3. **API完整性檢查** (5分鐘)
   - 確保所有必需字段存在
   - 檢查向後兼容性
   - 驗證返回值格式

### **Phase 4: 測試與驗證** (預估20分鐘)
1. **功能測試** (10分鐘)
   - 測試題目生成正確性
   - 驗證LaTeX格式無誤
   - 檢查邏輯一致性

2. **文檔生成測試** (5分鐘)
   - 測試Sphinx文檔生成
   - 檢查docstring格式
   - 驗證API文檔完整性

3. **對比驗證** (5分鐘)
   - 與原版功能對比
   - 確認代碼行數減少
   - 驗證性能無退化
   - 檢查註解完整性 (每個設計決策都有說明)

## ✅ **成功標準定義**

### **量化指標**
- [ ] **代碼行數**: 從463行減少到180行以下 (>60%減少)
- [ ] **模版步驟**: 從8-10步簡化到4-5步
- [ ] **參數處理**: 從67行Pydantic代碼減少到5行以內
- [ ] **測試通過率**: 100%通過功能和格式測試

### **質性檢查**
- [ ] **LaTeX格式**: 無HTML標籤，正確LaTeX語法
- [ ] **邏輯一致**: 答案與解釋結果完全一致
- [ ] **文檔品質**: Sphinx能正確生成API文檔
- [ ] **教師友善**: 代碼易讀，參數易改
- [ ] **年級分類**: 正確標註適用年級

### **典範價值**
- [ ] **架構清晰**: 其他開發者可輕鬆理解
- [ ] **可複製性**: 可作為其他生成器重寫模板
- [ ] **最佳實踐**: 展示LaTeX模版化正確做法
- [ ] **維護性**: 後續修改和擴展容易
- [ ] **註解完整**: 每個設計決策都有詳細說明，方便學習和參考

## 🔍 **風險評估與控制**

### **主要風險**
1. **模版過度簡化**: 可能丟失教學價值
2. **邏輯複雜度**: 數學算法可能比預期複雜
3. **向後兼容**: 可能影響現有系統整合

### **風險控制措施**
1. **保守簡化**: 優先保留教學完整性
2. **分步驗證**: 每個Phase完成後立即測試
3. **版本對比**: 持續與原版本對比確保功能無失

## 📚 **參考資料**

### **最佳實踐參考**
- `TrigEquationSolverGenerator`: LaTeX模版化標準
- `archived/InverseTrigonometricFunctionGenerator`: 簡潔參數處理
- 新版異常處理框架: 穩定性保證

### **技術標準**
- Sphinx文檔格式標準
- LaTeX數學環境最佳實踐
- Python代碼風格指南

---

**工作計畫制定完成**，準備討論和調整後開始實施。重點關注：模版簡化程度、年級分類詳細設計、Sphinx文檔具體格式。