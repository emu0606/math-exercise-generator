# 20251021 - 版面修改計畫 (4x10 版本)

**文件狀態**: 研擬中
**版本**: 方案 A (4x10)
**目標**: 根據「零猜測」模型，將系統佈局修改為 4x10 網格，並重構高度計算機制。

---

## 1. 核心參數

### 1.1 網格參數
- **網格列數**: 4（保持不變）
- **網格行數**: 10（從 8 改為 10）
- **格子間距**: 0.3 cm（從 0.5 改為 0.3）
- **單元格精確高度**: 2.090 cm（計算得出）

### 1.2 頁面結構高度
- **頁首高度**: 1.5 cm（固定）
- **頁尾高度**: 1.0 cm（固定）
- **可用垂直空間**: 23.6 cm（計算得出）

### 1.3 計算公式
```
頁面高度 = 29.7 cm (A4)
邊距 = 1.8 cm
可用高度 = 29.7 - 2*1.8 - 1.5 - 1.0 = 23.6 cm
總間距高度 = (10-1) * 0.3 = 2.7 cm
單元格高度 = (23.6 - 2.7) / 10 = 2.090 cm
```

---

## 2. 修改步驟詳解

本計畫將修改 3 個核心檔案：`structure.py`, `config.py`, `layout.py`。

### **步驟一：修改 `utils/latex/structure.py` (定義頁面結構)**

**檔案位置**: `utils/latex/structure.py`

#### 1.1 修改題目頁面 `geometry` 設定

**目標**: 添加 `footskip` 參數固定頁尾高度

**當前代碼**（Line 49）:
```python
\usepackage[margin=1.8cm]{geometry}
```

**修改為**:
```python
\usepackage[margin=1.8cm, footskip=1cm]{geometry}
```

#### 1.2 修改題目頁面 `fancyhdr` 頁尾設定

**目標**: 簡化頁尾為八碼日期加頁碼

**當前代碼**（Line 92）:
```python
\fancyfoot[C]{\thepage}
```

**修改為**:
```python
\fancyfoot[C]{\small{\thepage}}
\fancyfoot[R]{\small{20251021}}  % 使用實際生成日期的八碼格式
```

**實作說明**:
- 日期部分需要在 Python 代碼中動態生成
- 使用 `self.current_date` 轉換為 `YYYYMMDD` 格式
- 實際代碼應為：
  ```python
  date_str = self.current_date.replace('-', '')  # "2025-10-21" -> "20251021"
  preamble += r"\fancyfoot[R]{\small{" + date_str + r"}}" + "\n"
  ```

#### 1.3 修改頁首函數 `generate_page_header`

**目標**: 實現「回數 + 日期欄 + 姓名欄 + 漸層線」的頁首

**當前代碼**（Line 456-466）:
```python
def generate_page_header(self, round_num: int) -> str:
    """生成頁首

    Args:
        round_num: 回數

    Returns:
        頁首 LaTeX 內容
    """
    header = r"\noindent 第" + str(round_num) + r"回 \hfill \_\_\_月\_\_\_\_日 \hfill 姓名：\_\_\_\_\_\_\_\_\_" + "\n\n"
    return header
```

**修改為**:
```python
def generate_page_header(self, round_num: int) -> str:
    """生成頁首

    Args:
        round_num: 回數

    Returns:
        頁首 LaTeX 內容（高度固定為 1.5cm）
    """
    # 頁首內容：第 X 回 + 手寫日期欄（右上）+ 姓名欄（左下）
    header_content = (
        r"{\small 第 " + str(round_num) + r" 回 \hfill 日期：\_\_\_\_\_\_\_\_}\\[2pt]" + "\n" +
        r"{\large 姓名：\_\_\_\_\_\_\_\_\_\_\_\_}"
    )

    # 漸層裝飾線
    line_style = r"\tikz[overlay] \shade[left color=gray, right color=white] (0,0) rectangle (\linewidth, 1.2pt);%"

    # 使用 parbox 固定高度為 1.5cm
    header = (
        r"\noindent\parbox[t][1.5cm][c]{\textwidth}{%" + "\n" +
        r"  " + header_content + "\n" +
        r"  \vfill" + "\n" +
        r"  " + line_style + "\n" +
        r"}" + "\n\n"
    )

    return header
```

#### 1.4 修改頁尾函數 `generate_page_footer`

**目標**: 清空頁尾內容（由 `fancyhdr` 接管）

**當前代碼**（Line 468-478）:
```python
def generate_page_footer(self) -> str:
    """生成頁尾

    Returns:
        頁尾 LaTeX 內容
    """
    footer = r"\vfill" + "\n"
    footer += r"\begin{center}" + "\n"
    footer += r"\small{生成日期：" + self.current_date + r"}" + "\n"
    footer += r"\end{center}" + "\n"
    return footer
```

**修改為**:
```python
def generate_page_footer(self) -> str:
    """生成頁尾

    Returns:
        空字串（頁尾已由 fancyhdr 接管）
    """
    return ""  # 返回空字串
```

#### 1.5 同步修改簡答頁和詳解頁 preamble

**需要同步的方法**:
- `get_answer_preamble()`
- `get_explanation_preamble()`

**修改點**:
1. 添加 `footskip=1cm` 到 `geometry` 設定
2. 修改 `\fancyfoot` 設定（同題目頁）

### **步驟二：修改 `utils/latex/config.py` (重構高度計算)**

**檔案位置**: `utils/latex/config.py`

#### 2.1 修改 `__init__` 方法的預設參數

**當前代碼**（Line 18-25）:
```python
def __init__(self,
             page_width: float = 21.0,
             page_height: float = 29.7,
             margin: float = 1.8,
             grid_width: int = 4,
             grid_height: int = 8,  # ← 修改這裡
             gap: float = 0.5,      # ← 修改這裡
             font_path: str = "./assets/fonts/"):
```

**修改為**:
```python
def __init__(self,
             page_width: float = 21.0,
             page_height: float = 29.7,
             margin: float = 1.8,
             grid_width: int = 4,
             grid_height: int = 10,     # 從 8 改為 10
             gap: float = 0.3,          # 從 0.5 改為 0.3
             font_path: str = "./assets/fonts/"):
```

#### 2.2 修改 `__init__` 中的高度計算邏輯

**當前代碼**（Line 46-50）:
```python
# 計算派生屬性
self.usable_width = self.page_width - 2 * self.margin
self.total_gap_width = (self.grid_width - 1) * self.gap
self.unit_width = round((self.usable_width - self.total_gap_width) / self.grid_width, 3)
self.unit_height = round(self.unit_width * 0.618, 3)  # 黃金比例
```

**修改為**:
```python
# 計算派生屬性 - 寬度
self.usable_width = self.page_width - 2 * self.margin
self.total_gap_width = (self.grid_width - 1) * self.gap
self.unit_width = round((self.usable_width - self.total_gap_width) / self.grid_width, 3)

# 新增：定義結構高度常數
self.header_height = 1.5  # 頁首固定高度（cm）
self.footer_height = 1.0  # 頁尾固定高度（cm）

# 新增：計算可用垂直空間
self.usable_height = self.page_height - (2 * self.margin) - self.header_height - self.footer_height

# 修正：基於可用空間計算單元格高度
self.total_gap_height = (self.grid_height - 1) * self.gap
self.unit_height = round((self.usable_height - self.total_gap_height) / self.grid_height, 3)
```

### **步驟三：修改 `utils/core/layout.py` (同步網格尺寸)**

**檔案位置**: `utils/core/layout.py`

#### 3.1 修改 `GridManager` 的預設參數

**當前代碼**（Line 55）:
```python
def __init__(self, grid_width: int = 4, grid_height: int = 8):
```

**修改為**:
```python
def __init__(self, grid_width: int = 4, grid_height: int = 10):
```

#### 3.2 修改 `LayoutEngine` 的預設參數

**需要查找**: `LayoutEngine.__init__` 中的 `grid_height` 預設值

**修改**: 將預設值從 `8` 改為 `10`

---

## 3. 驗證計算

### 3.1 寬度計算（不變）
```
可用寬度 = 21.0 - 2*1.8 = 17.4 cm
總間距寬度 = (4-1) * 0.3 = 0.9 cm
單元格寬度 = (17.4 - 0.9) / 4 = 4.125 cm
```

### 3.2 高度計算（新公式）
```
可用高度 = 29.7 - 2*1.8 - 1.5 - 1.0 = 23.6 cm
總間距高度 = (10-1) * 0.3 = 2.7 cm
單元格高度 = (23.6 - 2.7) / 10 = 2.090 cm
```

### 3.3 視覺比例
```
格子尺寸: 4.125 cm × 2.090 cm
寬高比: 4.125 / 2.090 ≈ 1.97:1
格子間距: 0.3 cm（約 7.3% 格子寬度，14.4% 格子高度）
```

---

## 4. 修改檔案清單

| 檔案 | 修改內容 | 行數範圍 |
|------|---------|---------|
| `utils/latex/structure.py` | 頁首函數、頁尾函數、preamble | Line 49, 92, 456-478 |
| `utils/latex/config.py` | 預設參數、高度計算邏輯 | Line 23-24, 46-50 |
| `utils/core/layout.py` | GridManager、LayoutEngine 預設值 | Line 55, LayoutEngine.__init__ |

---

## 5. 測試驗證

### 5.1 預覽測試
- ✅ 生成 4x10 格子預覽 PDF
- ✅ 確認格子高度 2.090 cm
- ✅ 確認格子間距 0.3 cm 視覺效果
- ✅ 確認頁首高度 1.5 cm
- ✅ 確認頁尾格式正確

### 5.2 實際題目測試
```bash
python main.py
# 生成各種題型，檢查：
# 1. 格子佈局正確
# 2. 頁首頁尾正確
# 3. 日期格式正確（八碼）
# 4. 無內容溢出
```

### 5.3 成功標準
- ✅ 所有頁面格子高度一致為 2.090 cm
- ✅ 格子間距 0.3 cm 不會太逼仄
- ✅ 頁首包含：回數、日期欄、姓名欄、漸層線
- ✅ 頁尾包含：頁碼（居中）、八碼日期（靠右）
- ✅ 題目內容不溢出格子

---

## 6. 風險評估

### 低風險
- ✅ 格子間距從 0.5 改為 0.3，仍有足夠區分度
- ✅ 格子高度增加 9.4%，題目更寬裕
- ✅ 頁首頁尾固定高度，計算明確

### 需要注意
- ⚠️ 間距 0.3 cm 視覺上是否太密集（需預覽確認）
- ⚠️ 確認所有三個 preamble 方法都同步修改
- ⚠️ 確認日期格式轉換正確（`YYYY-MM-DD` → `YYYYMMDD`）

---

## 7. 總結

此計畫詳細定義了實現 4x10 佈局所需的所有程式碼修改：
1. **網格**: 從 4×8 改為 4×10
2. **間距**: 從 0.5 cm 改為 0.3 cm
3. **格子高度**: 從 1.910 cm 增加到 2.090 cm（+9.4%）
4. **頁首**: 增加手寫日期欄，固定高度 1.5 cm
5. **頁尾**: 簡化為八碼日期 + 頁碼

所有操作均基於確定的數值和邏輯，無任何模糊空間。
