# 對數內插生成器配置擴充計畫

> **建立時間**: 2025-10-17
> **狀態**: 研擬中
> **目標**: 增加「顯示對數值標籤」配置選項，提升題目挑戰性

---

## 📋 需求分析

### **用戶需求**
在對數內插法題目的數線配圖中，增加配置選項控制是否顯示數線上方的對數值標籤，以增加題目挑戰性。

### **核心邏輯**
1. **題目階段的 `top_middle`**（中間對數值）：
   - **正向題型**（求對數）：顯示 `"?"` - 這是問題本身，必須顯示
   - **反向題型**（求真數）：顯示 `"{log_x}"` - 這是題目條件，必須顯示

2. **題目階段的 `top_left` 和 `top_right`**（端點對數值）：
   - 受新配置 `show_log_values` 控制
   - `True`: 顯示對數值（預設，降低難度）
   - `False`: 隱藏對數值（增加挑戰性）

3. **詳解階段**：
   - 無論配置如何，**所有對數值都必須完整顯示**
   - 確保學生能看到完整的解題過程

---

## ✅ 技術可行性確認

### **圖形生成器空字串支援** ✓
- 檔案：`figures/predefined/number_line.py`
- 第193-203行：`\node` 指令直接使用參數值
- LaTeX `\node` 可接受空字串，渲染為無文字節點
- **結論**：完全支援空字串，無需額外處理

### **既有架構支援** ✓
- 已有 `get_config_schema()` 方法（第462-477行）
- 已有雙圖形機制：`use_question_mark` 參數區分題目/詳解
- **結論**：架構完善，修改影響範圍小

---

## 🔧 實施方案

### **修改位置清單**

#### **1. 配置讀取**
**檔案**: `LogarithmInterpolationGenerator.py`
**位置**: 第108-109行（`__init__` 方法）

**修改內容**：
```python
# 配置讀取
options = options or {}
self.question_type = options.get('question_type', 'mixed')
self.show_log_values = options.get('show_log_values', True)  # 新增
```

---

#### **2. 圖形資料生成邏輯**
**檔案**: `LogarithmInterpolationGenerator.py`
**位置**: 第271-279行（`_generate_figure_data` 方法）

**原始代碼**：
```python
# 上方標籤（對數值）
if is_forward:
    top_left = f"{log_lower:.4f}"
    top_middle = "?" if use_question_mark else f"{log_x}"
    top_right = f"{log_upper:.4f}"
else:
    top_left = f"{log_lower:.4f}"
    top_middle = f"{log_x}"
    top_right = f"{log_upper:.4f}"
```

**修改後代碼**：
```python
# 上方標籤（對數值）
# 詳解階段必定全顯示，題目階段考慮配置
if not use_question_mark:
    # 詳解圖形：完整顯示所有對數值
    top_left = f"{log_lower:.4f}"
    top_middle = f"{log_x}"
    top_right = f"{log_upper:.4f}"
else:
    # 題目圖形：端點受配置控制，中間值視題型決定
    if is_forward:
        # 正向題型（求對數）：中間顯示問號
        top_left = f"{log_lower:.4f}" if self.show_log_values else ""
        top_middle = "?"  # 問題本身，必須顯示
        top_right = f"{log_upper:.4f}" if self.show_log_values else ""
    else:
        # 反向題型（求真數）：中間顯示已知對數值
        top_left = f"{log_lower:.4f}" if self.show_log_values else ""
        top_middle = f"{log_x}"  # 題目條件，必須顯示
        top_right = f"{log_upper:.4f}" if self.show_log_values else ""
```

---

#### **3. UI 配置項目定義**
**檔案**: `LogarithmInterpolationGenerator.py`
**位置**: 第469-477行（`get_config_schema` 方法）

**原始代碼**：
```python
return {
    "question_type": {
        "type": "select",
        "label": "題型選擇",
        "default": "mixed",
        "options": ["求對數", "求真數", "mixed"],
        "description": "求對數:給真數求對數\n求真數: 給對數求真數\nmixed: 混合模式"
    }
}
```

**修改後代碼**：
```python
return {
    "question_type": {
        "type": "select",
        "label": "題型選擇",
        "default": "mixed",
        "options": ["求對數", "求真數", "mixed"],
        "description": "求對數:給真數求對數\n求真數: 給對數求真數\nmixed: 混合模式"
    },
    "show_log_values": {
        "type": "checkbox",
        "label": "顯示端點對數值",
        "default": True,
        "description": "數線上方是否顯示兩端對數值\n關閉可增加題目挑戰性"
    }
}
```

---

## 🧪 測試驗證方案

### **測試情境**

#### **情境1：正向題型 + 顯示對數值（預設）**
- 配置：`{'question_type': 'forward', 'show_log_values': True}`
- 預期題目圖：
  - `top_left` = `"0.3010"` ✓
  - `top_middle` = `"?"` ✓
  - `top_right` = `"0.4771"` ✓
- 預期詳解圖：全顯示 ✓

#### **情境2：正向題型 + 隱藏對數值**
- 配置：`{'question_type': 'forward', 'show_log_values': False}`
- 預期題目圖：
  - `top_left` = `""` ✓
  - `top_middle` = `"?"` ✓（問題本身）
  - `top_right` = `""` ✓
- 預期詳解圖：全顯示 ✓

#### **情境3：反向題型 + 顯示對數值**
- 配置：`{'question_type': 'backward', 'show_log_values': True}`
- 預期題目圖：
  - `top_left` = `"0.3010"` ✓
  - `top_middle` = `"0.39"` ✓（題目條件）
  - `top_right` = `"0.4771"` ✓
- 預期詳解圖：全顯示 ✓

#### **情境4：反向題型 + 隱藏對數值**
- 配置：`{'question_type': 'backward', 'show_log_values': False}`
- 預期題目圖：
  - `top_left` = `""` ✓
  - `top_middle` = `"0.39"` ✓（題目條件）
  - `top_right` = `""` ✓
- 預期詳解圖：全顯示 ✓

### **執行命令**
```bash
# 1. 基礎導入測試
py -c "from generators.exponential_logarithm import LogarithmInterpolationGenerator; print('✅ 模組導入正常')"

# 2. 配置讀取測試
py -c "from generators.exponential_logarithm import LogarithmInterpolationGenerator; gen = LogarithmInterpolationGenerator({'show_log_values': False}); print('✅ 配置讀取正常:', gen.show_log_values)"

# 3. 題目生成測試（需手動檢查PDF輸出）
python main.py
# 操作步驟：
# - 選擇「指數與對數 > 對數概算練習」
# - 勾選/取消「顯示端點對數值」
# - 生成PDF並檢查圖形標籤
```

---

## 📊 影響範圍評估

### **代碼修改範圍**
- **修改檔案數量**: 1 個（`LogarithmInterpolationGenerator.py`）
- **修改位置數量**: 3 處
- **新增代碼行數**: 約 10 行
- **修改既有邏輯**: 1 處（第271-279行）

### **風險評估**
- **破壞性風險**: ⭐ 極低
  - 僅修改內部邏輯，不改變外部接口
  - 預設值為 `True`，保持向後兼容

- **測試複雜度**: ⭐⭐ 中等
  - 需要手動生成PDF檢查視覺效果
  - 需要測試正向/反向題型組合

- **回滾方案**: ✓ 簡單
  - Git 單一 commit 可回滾
  - 配置項刪除不影響既有題目

---

## 📝 實施檢查清單

### **修改前準備**
- [ ] 確認 Git 狀態乾淨（`git status`）
- [ ] 確認當前在 `main` 分支
- [ ] 備份當前版本（mental note）

### **代碼修改**
- [ ] 修改位置1：配置讀取（第108-109行）
- [ ] 修改位置2：圖形資料生成邏輯（第271-279行）
- [ ] 修改位置3：UI 配置項目定義（第469-477行）

### **測試驗證**
- [ ] 執行基礎導入測試
- [ ] 執行配置讀取測試
- [ ] 啟動 UI，確認新配置選項顯示
- [ ] 測試情境1：正向 + 顯示
- [ ] 測試情境2：正向 + 隱藏
- [ ] 測試情境3：反向 + 顯示
- [ ] 測試情境4：反向 + 隱藏

### **文檔更新**
- [ ] 更新模組 docstring（如需要）
- [ ] 更新 `_generate_figure_data` 方法註解
- [ ] 檢查 Sphinx 文檔格式

---

## 🎯 成功標準

### **功能正確性**
- ✅ 配置選項在 UI 中正確顯示
- ✅ 勾選時顯示端點對數值
- ✅ 取消勾選時隱藏端點對數值
- ✅ 題目條件值（`top_middle`）始終正確顯示
- ✅ 詳解圖形始終完整顯示所有對數值

### **代碼品質**
- ✅ 代碼邏輯清晰，註解完整
- ✅ 符合專案開發準則（CLAUDE.md）
- ✅ 無多餘的過度工程化設計
- ✅ 保持檔案行數合理（< 500行）

### **教師友善性**
- ✅ 配置選項名稱直觀易懂
- ✅ 說明文字清楚描述功能
- ✅ 預設值保持原有行為（向後兼容）

---

## 📌 注意事項

### **關鍵設計理念**
1. **題目條件必須顯示**：`top_middle` 無論配置如何，在題目階段都要顯示（問號或已知值）
2. **詳解完整展示**：詳解圖形必須顯示所有對數值，幫助學生理解
3. **向後兼容**：預設值 `True` 保持原有行為

### **LaTeX 渲染確認**
- 空字串 `""` 傳入 `\node` 指令不會報錯
- 已在 `number_line.py` 第193-203行確認支援

### **UI 配置類型**
- 使用 `checkbox` 類型（布林值）
- 與既有的 `select` 類型配置並存

---

## 🚀 執行時機

**等待用戶明確授權**：
- 需要用戶說出「開始實施」、「開始修改」、「執行計畫」等授權詞語
- 計畫確認後才能使用 Edit/Write 工具

---

**計畫制定完成，等待授權執行。**
