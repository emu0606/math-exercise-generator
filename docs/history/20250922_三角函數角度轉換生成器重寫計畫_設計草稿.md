# 三角函數角度轉換生成器重寫計畫（設計草稿）

> ⚠️ **重要聲明**: 這是設計思路草稿文檔，記錄了設計過程中的討論、修正和版本對比過程
>
> **❌ 不要依照此文檔執行實施** - 此文檔包含大量修正歷史和設計過程記錄，不適合作為實施指導
>
> **✅ 請參考最新的工作計畫** - 請使用 `20250926_三角函數角度轉換生成器重寫工作計畫.md` 作為實施指導

---

**原設計資訊**:
> **目標**: 基於舊版實現進行現代化重寫，保持數學邏輯正確性，移除過度工程化
> **草稿日期**: 2025-09-22
> **狀態**: 🗃️ 已封存為設計記錄
> **方向**: 舊版現代化策略（已整合至正式工作計畫）

## 🎯 **重寫目標**

### **核心理念**
採用「保留數學精髓，現代化架構」策略，避免新版本的過度工程化問題，確保數學邏輯的正確性和教學價值。

### **目標成果**
- ✅ 保持舊版本經過驗證的數學邏輯
- ✅ 採用新架構的統一標準（配置、日誌、元數據）
- ✅ 符合典範開發準則（簡潔實用）
- ✅ 移除過度抽象化和不良實踐

---

## 📊 **版本分析對比**

### **舊版本優勢保留**

#### **✅ 數學邏輯健全**
- **象限轉換正確**：`_convert_to_first_quadrant()` 處理各象限符號變化準確
- **餘角公式應用**：`_convert_to_narrow_angle()` 使用標準數學關係
- **週期性處理**：正確處理 360° 週期性和負角度
- **特殊情況處理**：tan 函數在 90° 奇數倍的未定義情況

#### **✅ 教學設計合理**
- **三種題型比例**：第一象限轉換(70%)、公式問答(10%)、窄角轉換(20%)
- **角度範圍選擇**：-80° 到 260°，避開 90° 的倍數
- **公式題庫**：預定義的三角函數關係公式
- **解釋步驟**：詳細的數學推導過程

#### **✅ 架構簡潔**
- **配置模式**：使用 `options.get()` 而非複雜驗證
- **邏輯分工**：清晰的方法職責劃分
- **代碼可讀性**：沒有不必要的抽象層

### **新版本問題分析**

#### **❌ 過度工程化**
```python
# 問題：為簡單字串創建枚舉
class TrigFunction(str, Enum):
    SIN = "sin"
    COS = "cos"
    TAN = "tan"
    COT = "cot"

# 問題：3個模式需要枚舉？
class ConversionMode(str, Enum):
    # 過度抽象化
```

#### **❌ 不良實踐**
```python
from sympy import *  # 污染命名空間
from pydantic import BaseModel, Field, validator  # 過度驗證
```

#### **❌ 數學風險**
- 重新實現的數學邏輯可能引入錯誤
- 舊版本邏輯已經過實際使用驗證

---

## 🔧 **重寫實施策略**

### **Phase 1: 架構現代化**

#### **1.1 導入和基礎設定**
```python
# ✅ 採用標準導入
import random
from typing import Dict, Any, List, Tuple

# ✅ 使用新架構核心工具
from utils import get_logger
from generators.base import QuestionGenerator, QuestionSize, register_generator

# ✅ 統一註冊機制
@register_generator
class TrigAngleConversionGenerator(QuestionGenerator):
```

#### **1.2 配置系統統一**
```python
def __init__(self, options: Dict[str, Any] = None):
    super().__init__(options)
    self.logger = get_logger(self.__class__.__name__)

    # ✅ 保持簡潔的配置模式
    options = options or {}
    self.difficulty = options.get("difficulty", "MEDIUM")

    # ✅ 保留舊版本的合理設計
    self.functions = ["sin", "cos", "tan"]
    self.base_angles = [angle for angle in range(-80, 261, 10) if angle % 90 != 0]
    self.mode_weights = [70, 10, 20]  # 經過教學驗證的比例
```

### **Phase 2: 核心邏輯保留**

#### **2.1 完整移植數學方法**
- ✅ `_convert_to_first_quadrant()` - 象限轉換邏輯
- ✅ `_convert_to_narrow_angle()` - 餘角轉換邏輯
- ✅ `_generate_explanation()` - 解釋生成邏輯
- ✅ `_generate_narrow_angle_explanation()` - 窄角解釋邏輯

#### **2.2 三種題型方法保留**
- ✅ `_generate_formula_question()` - 公式問答題
- ✅ `_generate_original_question()` - 第一象限轉換題
- ✅ `_generate_narrow_angle_question()` - 窄角轉換題

#### **2.3 公式題庫保留**
```python
# ✅ 保留經過驗證的公式題庫
FORMULA_QUESTIONS = {
    "sin": [
        {"question": "\\sin(180^\\circ-\\theta) = ", "answer": "\\sin(\\theta)"},
        # ... 其他公式
    ],
    # ... 其他函數
}
```

### **Phase 3: 現代化改善**

#### **3.1 元數據處理統一**
```python
def _get_standard_metadata(self) -> Dict[str, Any]:
    """統一的元數據處理，與其他生成器保持一致"""
    return {
        "size": self.get_question_size(),
        "difficulty": self.difficulty,
        "category": self.get_category(),
        "subcategory": self.get_subcategory(),
        "grade": "G10S2",  # 高一下學期
        # 預留圖形相關欄位
        "figure_data_question": None,
        "figure_data_explanation": None,
        "figure_position": "right",
        "explanation_figure_position": "right"
    }
```

#### **3.2 錯誤處理機制**
```python
def generate_question(self) -> Dict[str, Any]:
    """加入現代化的錯誤處理和日誌"""
    self.logger.info("開始生成三角函數角度轉換題目")

    try:
        # 保留舊版本的題型選擇邏輯
        mode = random.choices(
            ["original", "formula", "narrow_angle"],
            weights=self.mode_weights
        )[0]

        # ... 原有邏輯

    except Exception as e:
        self.logger.warning(f"生成題目失敗: {str(e)}")
        return self._get_fallback_question()
```

#### **3.3 註解標準化** ⚠️ **已修正配合UI導向設計**
- 移除「華麗大招」等不符合規範的標籤
- 採用「為什麼這樣做」的註解風格，強調UI導向思維
- 保留有價值的數學邏輯說明
- **重要修正**: 所有註解反映「信任UI控件驗證」的設計理念

### **Phase 3.5: UI配置支援整合** (新增 - 30分鐘)

#### **3.5.1 配置描述定義** ⚠️ **已修正配合percentage_group控件**
```python
@classmethod
def get_config_schema(cls):
    """提供UI配置描述，支援教學彈性調整"""
    return {
        "mode_weights": {
            "type": "percentage_group",  # 修正：配合實際實現的控件類型
            "label": "題型比例分配",
            "description": "調整三種題型的出現頻率，總和自動保持為100%",
            "items": {
                "original": {
                    "label": "第一象限轉換",  # 簡化：移除type/min/max，只保留必要欄位
                    "default": 70
                },
                "formula": {
                    "label": "公式問答",
                    "default": 10
                },
                "narrow_angle": {
                    "label": "窄角轉換",
                    "default": 20
                }
            }
        },
        "angle_range": {
            "type": "select",
            "options": ["basic", "extended", "negative"],
            "default": "basic",
            "label": "角度範圍",
            "description": "basic(-80°~260°) / extended(-180°~540°) / negative(包含更多負角)"
        }
    }
```

#### **3.5.2 配置處理邏輯** ⚠️ **已簡化配合percentage_group控件**
```python
def __init__(self, options: Dict[str, Any] = None):
    super().__init__(options)
    self.logger = get_logger(self.__class__.__name__)
    options = options or {}

    # 固定函數類型（基於教學標準，不開放配置）
    self.functions = ["sin", "cos", "tan"]

    # 簡化的題型權重處理：percentage_group已確保總和=100%
    mode_config = options.get("mode_weights", {})
    if mode_config:
        # UI控件已驗證總和=100%，直接使用無需正規化
        self.mode_weights = [
            mode_config.get("original", 70),
            mode_config.get("formula", 10),
            mode_config.get("narrow_angle", 20)
        ]
        self.logger.info(f"使用自定義題型權重: {self.mode_weights}")
    else:
        # 無配置時使用預設值
        self.mode_weights = [70, 10, 20]

    # 可配置的角度範圍
    angle_range = options.get("angle_range", "basic")
    if angle_range == "extended":
        # 擴展範圍：-180° 到 540°
        self.base_angles = list(range(-180, 541, 10))
    elif angle_range == "negative":
        # 負角範圍：-270° 到 360°
        self.base_angles = list(range(-270, 361, 10))
    else:  # basic
        # 基礎範圍：-80° 到 260°（舊版本設定）
        self.base_angles = list(range(-80, 261, 10))

    # 移除90度倍數（避免tan函數未定義）
    self.base_angles = [angle for angle in self.base_angles if angle % 90 != 0]

    # 記錄最終配置：區分自定義和預設配置來源
    if mode_config:
        self.logger.info(f"角度轉換生成器配置 - 權重(UI自定義): {self.mode_weights}, 角度範圍: {angle_range}")
    else:
        self.logger.info(f"角度轉換生成器配置 - 權重(預設): {self.mode_weights}, 角度範圍: {angle_range}")
```

#### **3.5.3 向後兼容確保** ⚠️ **已簡化驗證邏輯**
```python
# 確保無配置時使用預設值
self.difficulty = options.get("difficulty", "MEDIUM")  # 保留舊參數兼容

# 簡化的配置驗證：UI控件已確保有效性，減少重複驗證
if angle_range not in ["basic", "extended", "negative"]:
    self.logger.warning(f"無效的角度範圍: {angle_range}，使用預設值basic")
    angle_range = "basic"

# 移除percentage_group的額外驗證：UI已確保數值有效性和總和=100%
```

---

## ⚠️ **風險評估與對策**

### **數學邏輯風險**
**風險**: 移植過程中可能引入數學錯誤
**對策**:
- 逐方法對比測試
- 保留原有的測試角度集合
- 驗證各象限的符號處理

### **功能完整性風險**
**風險**: 可能遺漏舊版本的功能細節
**對策**:
- 完整功能對照檢查表
- 保留所有三種題型模式
- 維持相同的解釋詳細程度

### **架構兼容性風險**
**風險**: 新架構要求可能與舊邏輯衝突
**對策**:
- 最小化架構變更
- 保持接口一致性
- 漸進式重構

---

## 📋 **實施檢查清單**

### **Phase 1: 架構準備 ✅**
- [ ] 設定標準導入和註冊
- [ ] 統一配置管理
- [ ] 加入日誌系統
- [ ] 建立元數據處理

### **Phase 2: 核心邏輯移植 ✅**
- [ ] `_convert_to_first_quadrant()` 邏輯驗證
- [ ] `_convert_to_narrow_angle()` 邏輯驗證
- [ ] 三種題型生成方法移植
- [ ] 公式題庫完整移植
- [ ] 解釋生成邏輯保留

### **Phase 3: 現代化改善 ✅**
- [ ] 註解標準化處理（強調UI導向思維）
- [ ] 錯誤處理機制（簡化驗證邏輯）
- [ ] LaTeX格式優化
- [ ] 統一接口方法
- [ ] **重要**: 確保所有註解反映「信任UI控件」設計理念

### **Phase 3.5: UI配置支援整合 ✅**
- [ ] 配置描述方法 `get_config_schema()` 實現（使用percentage_group類型）
- [ ] 題型權重配置處理（簡化，直接使用UI值）
- [ ] 角度範圍配置邏輯
- [ ] 配置驗證和錯誤處理（移除重複驗證）
- [ ] 向後兼容性確保
- [ ] **重要**: 日誌訊息明確區分配置來源（UI自定義/預設）

### **Phase 4: 測試驗證 ✅**
- [ ] 各象限角度轉換測試
- [ ] 三種題型生成測試
- [ ] 符號處理正確性驗證
- [ ] 解釋邏輯完整性檢查
- [ ] 配置功能測試（題型比例、角度範圍）
- [ ] 向後兼容性測試（無配置模式）

---

## 🎯 **成功標準**

### **功能標準**
- ✅ 保持三種題型及其比例 (70%/10%/20%)
- ✅ 各象限角度轉換邏輯正確
- ✅ 窄角轉換和餘角公式應用正確
- ✅ 解釋步驟詳細且數學正確

### **代碼品質標準**
- ✅ 符合典範開發準則（簡潔實用）
- ✅ 註解符合規範標準
- ✅ 架構與其他生成器一致
- ✅ 無過度工程化設計

### **測試標準**
- ✅ 所有測試角度正確處理
- ✅ 錯誤情況有適當處理
- ✅ 性能表現良好
- ✅ 與現有系統完美整合

---

## 📅 **實施時程**

**預估時間**: 3-3.5小時
**實施方式**: 清空覆寫現有文件

### **時程安排**
1. **Phase 1 (30分鐘)**: 架構設定和配置系統
2. **Phase 2 (90分鐘)**: 核心邏輯移植和驗證
3. **Phase 3 (30分鐘)**: 現代化改善和註解標準化
4. **Phase 4 (30分鐘)**: 測試驗證和最終檢查

---

## 📝 **備註**

### **設計哲學**
採用「該用基礎招式的時候用基礎招式」原則，避免為簡單問題創造複雜解決方案。三角函數角度轉換是基礎數學概念，應該用直觀、可驗證的方法實現。

### **維護考量**
重寫後的代碼應該讓數學教師能夠理解和修改，避免過度的技術抽象化。數學邏輯的正確性比代碼的技術先進性更重要。

### **教學價值**
保持舊版本經過實際教學驗證的設計決策，如題型比例、角度範圍選擇等，這些都是基於教學經驗的寶貴設計。

---

---

## ⚠️ **配合percentage_group控件的重要修正** (2025-09-26)

### **已修正的高優先級問題**

#### **✅ 修正1: get_config_schema()格式**
- **問題**: 原計畫使用 `"type": "group"` 和複雜的number控件
- **修正**: 改為 `"type": "percentage_group"` 配合實際實現
- **影響**: 簡化schema結構，移除不必要的min/max/type定義

#### **✅ 修正2: 配置處理邏輯簡化**
- **問題**: 原有複雜的正規化計算邏輯
- **修正**: 直接使用UI傳入值，因為percentage_group已確保總和=100%
- **影響**: 移除約15行複雜計算代碼，提升可讀性

### **已修正的中優先級問題**

#### **✅ 修正3: 移除重複驗證**
- **問題**: 計畫中包含UI和生成器的雙重驗證
- **修正**: 信任UI控件的驗證結果，避免重複檢查
- **影響**: 精簡錯誤處理邏輯，減少不必要的代碼

#### **✅ 修正4: 簡化錯誤處理**
- **問題**: 針對percentage_group數值範圍的複雜錯誤處理
- **修正**: 只保留必要的角度範圍驗證，移除數值驗證
- **影響**: 降低代碼複雜度，符合"基礎招式"原則

### **已修正的高優先級問題（重新分級）**

#### **✅ 修正5: 註解範例修正**
- **問題**: 原註解描述複雜正規化邏輯，會誤導實施方向
- **修正**: 註解強調「信任UI控件驗證」的設計理念
- **影響**: 確保實施者朝UI導向思維發展，避免重複驗證

#### **✅ 修正6: 日誌訊息調整**
- **問題**: 原日誌描述正規化過程，暗示需要複雜處理
- **修正**: 日誌明確區分「UI自定義」和「預設」配置來源
- **影響**: 避免實施者誤以為需要複雜的數值處理邏輯

### **具體修正範例**

#### **註解風格修正**
```python
# ❌ 原計畫註解（會誤導實施方向）
# 權重正規化確保總和為100
total = original + formula + narrow_angle
if total > 0:
    self.mode_weights = [int(original * 100 / total), ...]

# ✅ 修正後註解（UI導向思維）
# UI控件已確保總和=100%，直接使用配置值避免重複處理
if mode_config:
    self.mode_weights = [mode_config.get("original", 70), ...]
```

#### **日誌訊息修正**
```python
# ❌ 原計畫日誌（暗示複雜處理）
self.logger.info(f"權重正規化完成: {self.mode_weights}")

# ✅ 修正後日誌（明確配置來源）
self.logger.info(f"角度轉換生成器配置 - 權重(UI自定義): {self.mode_weights}")
```

### **修正對照表**

| 項目 | 原計畫 | 修正後 | 理由 |
|------|--------|---------|------|
| Schema類型 | `"type": "group"` | `"type": "percentage_group"` | 配合實際控件實現 |
| 項目定義 | 包含type/min/max | 只有label/default | percentage_group格式要求 |
| 權重處理 | 複雜正規化計算 | 直接使用UI值 | UI已確保總和=100% |
| 驗證邏輯 | 多層驗證 | 簡化驗證 | 避免重複檢查 |
| 註解範例 | 描述正規化邏輯 | 強調信任UI驗證 | 避免實施者走錯方向 |
| 日誌描述 | 記錄正規化過程 | 區分配置來源 | 明確UI導向設計理念 |

**狀態**: 🎉 **計畫修正完成，已配合percentage_group控件實現**
**下一步**: 確認修正後開始清空覆寫實施