# 二次函數極值生成器 - 詳解格式優化討論

> **日期**: 2025-10-19
> **問題**: 詳解格式閱讀不舒服，考慮使用模板簡化
> **狀態**: 研擬中

---

## 📋 當前詳解格式問題

### **問題1：題目在詳解中重複出現**
```
【詳解】
$y = -x^2 + 12x - 26$  ← 這行是多餘的，題目已經有了

**步驟1：配方找頂點**
...
```
**問題**：題目已經在上方顯示，詳解第一行再重複一次沒有必要

---

### **問題2：步驟標記使用 Markdown 粗體**
```
**步驟1：配方找頂點**
**步驟2：判斷頂點位置**
**步驟3：計算端點值**
**結論：**
```
**問題**：
- Markdown 粗體在 LaTeX PDF 中可能渲染不一致
- 不夠醒目，不如使用 LaTeX 原生格式

---

### **問題3：空行過多**
```
頂點為 $(6, 10)$

**步驟2：判斷頂點位置**  ← 太多空行
因為 $4 \leq 6 \leq 9$，頂點在區間內

開口向下，頂點為最大值 $10$  ← 又一個空行

**步驟3：計算端點值**
```
**問題**：空行過多導致版面鬆散，不緊湊

---

### **問題4：端點計算沒有展示過程**
```
$y(4) = 6$
$y(9) = 1$
```
**問題**：直接給出結果，沒有代入計算過程，學生無法學習

---

### **問題5：配方過程不完整**
```
**步驟1：配方找頂點**
$y = -1(x - 6)^2 + 10$  ← 直接給出結果
頂點為 $(6, 10)$
```
**問題**：
- 沒有展示配方的中間步驟
- 對於 $a \neq 1$ 的情況，應該展示提取公因數的過程

---

## 💡 改進方案

### **方案A：使用模板（推薦）**

#### **全域極值模板**
```python
GLOBAL_EXTREMUM_TEMPLATE = """配方法：
$$y = {function}$$
$$= {step1}$$  # 提取公因數（如果 a ≠ 1）
$$= {vertex_form}$$

因為 $a = {a}$ {comparison} $0$，開口{direction}，
所以當 $x = {h}$ 時，$y$ 有{extremum_type} ${k}$"""
```

**優點**：
- ✅ 結構清晰，一目了然
- ✅ 使用 `$$` 獨立成行，更醒目
- ✅ 邏輯流暢，易於閱讀
- ✅ 代碼簡潔，易於維護

---

#### **區間極值模板**

**情境1：頂點在區間內**
```python
INTERVAL_INSIDE_TEMPLATE = """配方法：
$$y = {function}$$
$$= {vertex_form}$$
頂點為 $({h}, {k})$

判斷：因為 ${x1} \\leq {h} \\leq {x2}$，頂點在區間內
開口{direction}，頂點為{vertex_extremum}值 ${k}$

計算端點：
$$y({x1}) = {a} \\times ({x1})^2 {b_sign} {b_abs} \\times ({x1}) {c_sign} {c_abs} = {y1}$$
$$y({x2}) = {a} \\times ({x2})^2 {b_sign} {b_abs} \\times ({x2}) {c_sign} {c_abs} = {y2}$$

因此，最大值為 ${y_max}$，最小值為 ${y_min}$"""
```

**情境2：頂點不在區間內**
```python
INTERVAL_OUTSIDE_TEMPLATE = """配方法：
$$y = {function}$$
$$= {vertex_form}$$
頂點為 $({h}, {k})$

判斷：頂點 $x = {h}$ 不在區間 $[{x1}, {x2}]$ 內

計算端點：
$$y({x1}) = {a} \\times ({x1})^2 {b_sign} {b_abs} \\times ({x1}) {c_sign} {c_abs} = {y1}$$
$$y({x2}) = {a} \\times ({x2})^2 {b_sign} {b_abs} \\times ({x2}) {c_sign} {c_abs} = {y2}$$

比較端點值：${y1}$ 和 ${y2}$
因此，最大值為 ${y_max}$，最小值為 ${y_min}$"""
```

---

### **方案B：改進當前格式（次選）**

保持當前結構，但改進細節：

#### **改進點1：移除題目重複**
```python
# 不要在詳解開頭重複題目
explanation_lines = [
    # f"${function_expr}$",  ← 刪除這行
    # "",                     ← 刪除空行
    "**步驟1：配方找頂點**",
    ...
]
```

#### **改進點2：使用 LaTeX 格式**
```python
# 從 Markdown 粗體改為 LaTeX 粗體
"**步驟1：配方找頂點**"  # ❌ Markdown
"\\textbf{步驟1：配方找頂點}" # ✅ LaTeX

# 或使用 section 樣式
"\\underline{步驟1：配方找頂點}" # ✅ 下劃線
```

#### **改進點3：展示計算過程**
```python
# 端點計算展示過程
explanation_lines.append(f"$$y({x1}) = {a} \\times ({x1})^2 + ({b}) \\times ({x1}) + {c} = {y1}$$")
```

#### **改進點4：減少空行**
```python
# 緊湊的格式
explanation_lines = [
    "配方法：",
    f"$$y = {vertex_form}$$",
    f"頂點為 $({h}, {k})$",
    "",  # 只在大段落間加一個空行
    "判斷頂點位置：",
    ...
]
```

---

## 📊 兩種方案對比

| 項目 | 方案A（模板） | 方案B（改進格式） |
|------|--------------|-----------------|
| **代碼行數** | ~30行 | ~50行 |
| **可讀性** | ⭐⭐⭐⭐⭐ 極佳 | ⭐⭐⭐ 中等 |
| **維護性** | ⭐⭐⭐⭐⭐ 極易 | ⭐⭐⭐ 中等 |
| **彈性** | ⭐⭐⭐ 中等 | ⭐⭐⭐⭐ 較高 |
| **一致性** | ⭐⭐⭐⭐⭐ 完美 | ⭐⭐⭐ 需注意 |
| **LaTeX美觀** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |

---

## 🎯 推薦方案：方案A（模板）

### **理由**

1. **符合專案準則**：CLAUDE.md 提到「該用華麗大招的時候用華麗大招」
   - 複雜多變格式 → 使用模板系統 ✅
   - 5種變化（全域/區間內/區間外/開口向上/向下） → 模板適用 ✅

2. **與典範一致**：雙重根號生成器使用模板
   ```python
   EXPLANATION_TEMPLATES = {
       "addition": [...],
       "subtraction": [...]
   }
   ```

3. **LaTeX 最佳實踐**：
   - 使用 `$$` 獨立成行的數學式
   - 避免 Markdown 混合
   - 版面更專業

4. **教學效果更好**：
   - 結構一致，學生易於理解
   - 步驟清晰，邏輯流暢
   - 計算過程完整

---

## 📝 實施細節（方案A）

### **模板定義**
```python
# 類別常數
EXPLANATION_TEMPLATES = {
    'global': """配方法：
$$y = {function}$$
{factoring_step}$$= {vertex_form}$$

因為 $a = {a}$ {comparison} $0$，開口{direction}，
所以當 $x = {h}$ 時，$y$ 有{extremum_type} ${k}$""",

    'interval_inside': """配方法：
$$y = {function}$$
$$= {vertex_form}$$
頂點為 $({h}, {k})$

判斷：因為 ${x1} \\leq {h} \\leq {x2}$，頂點在區間內
開口{direction}，頂點為{vertex_extremum}值 ${k}$

計算端點：
$$y({x1}) = {calc_x1} = {y1}$$
$$y({x2}) = {calc_x2} = {y2}$$

因此，最大值為 ${y_max}$，最小值為 ${y_min}$""",

    'interval_outside': """配方法：
$$y = {function}$$
$$= {vertex_form}$$
頂點為 $({h}, {k})$

判斷：頂點 $x = {h}$ 不在區間 $[{x1}, {x2}]$ 內

計算端點：
$$y({x1}) = {calc_x1} = {y1}$$
$$y({x2}) = {calc_x2} = {y2}$$

比較：${y1}$ 和 ${y2}$
因此，最大值為 ${y_max}$，最小值為 ${y_min}$"""
}
```

### **使用方式**
```python
def _build_global_explanation(self, a, b, c, h, k, extremum_type):
    """使用模板生成全域極值詳解"""
    template = self.EXPLANATION_TEMPLATES['global']

    # 準備參數
    params = {
        'function': self._format_quadratic_function(a, b, c),
        'factoring_step': self._get_factoring_step(a, b, c) if a != 1 else "",
        'vertex_form': f"{a}(x - {h})^2 {self._format_signed(k)}",
        'a': a,
        'comparison': '>' if a > 0 else '<',
        'direction': '向上' if a > 0 else '向下',
        'extremum_type': extremum_type,
        'h': h,
        'k': k
    }

    return template.format(**params)
```

---

## ⚠️ 注意事項

1. **符號處理**：需要正確處理正負號
2. **LaTeX 轉義**：模板中的 LaTeX 命令需要正確轉義
3. **計算展示**：端點計算需要展示完整過程
4. **中文排版**：LaTeX 中文與數學式的間距

---

## ✅ 預期效果

使用模板後的詳解範例：

```
配方法：
$$y = 2x^2 - 28x + 101$$
$$= 2(x - 7)^2 + 3$$
頂點為 $(7, 3)$

判斷：因為 $3 \leq 7 \leq 9$，頂點在區間內
開口向上，頂點為最小值 $3$

計算端點：
$$y(3) = 2 \times 3^2 - 28 \times 3 + 101 = 35$$
$$y(9) = 2 \times 9^2 - 28 \times 9 + 101 = 11$$

因此，最大值為 $35$，最小值為 $3$
```

**優點**：
- ✅ 版面清爽，結構清晰
- ✅ 邏輯流暢，易於理解
- ✅ 計算完整，學習效果好
- ✅ LaTeX 專業，美觀一致

---

**結論**：推薦使用方案A（模板），理由充分，效果更好。
