# 配圖佈局參數系統設計方案

- **計畫編號**: 20251021-Figure-Layout-Parameter-System
- **建立日期**: 2025-10-21
- **狀態**: 研擬中
- **優先級**: P0（核心功能增強）

## 1. 目標與背景

### 1.1 當前問題
1. **詳解頁面 bottom 位置圖形過大**：固定使用 `0.9\linewidth`，無法針對不同題型調整
2. **缺乏彈性參數機制**：生成器無法自訂圖形顯示寬度，只能修改全域預設值

### 1.2 設計目標
1. **建立彈性的 layout 參數系統**：未來生成器可傳遞參數控制圖形顯示寬度
2. **調整詳解 bottom 預設值**：從 `0.9` 改為 `0.65`，解決當前圖形過大問題
3. **完全向後兼容**：不修改任何現有生成器，確保所有其他行為不變
4. **統一比例機制**：題目和詳解都使用比例參數，LaTeX Generator 負責單位轉換

## 2. 當前系統分析

### 2.1 題目頁面當前行為（`utils/latex/generator.py:148-178`）

**比例定義**（Line 149-154）:
```python
if width_cells == 1:  # Small 或 Square
    text_width_ratio = 0.60    # 文字 60%
    figure_width_ratio = 0.40  # 圖形 40%
else:  # Wide, Medium, Large, Extra
    text_width_ratio = 0.65    # 文字 65%
    figure_width_ratio = 0.35  # 圖形 35%
```

**寬度計算**（Line 158-163）:
```python
# 無圖形時
content_width = w - text_x_offset - 2*INNER_SEP_VALUE - SAFETY_MARGIN

# 有圖形時
available_width = w - text_x_offset - 2*INNER_SEP_VALUE - TEXT_FIGURE_GAP
text_w = text_width_ratio * available_width
figure_w = figure_width_ratio * available_width
```

**各位置使用**（Line 167-178）:
- **right**: `resizebox{figure_w cm}` = `0.40 或 0.35 * available_width`
- **left**: `resizebox{figure_w cm}` = `0.40 或 0.35 * available_width`
- **bottom**: `resizebox{content_width cm}` = 填滿可用寬度

### 2.2 詳解頁面當前行為（`utils/latex/generator.py:552-563`）

**right 位置**（Line 552-558）:
```python
# 在 0.38\linewidth 的 minipage 內
right_figure = f"\\resizebox{{\\linewidth}}{{!}}{{{figure_content}}}"
# \linewidth = minipage 寬度，填滿 100%
```

**bottom 位置**（Line 560-563）:
```python
bottom_figure = f"\\resizebox{{0.9\\linewidth}}{{!}}{{{figure_content}}}"
# 固定使用 90% 寬度 ← 要改為 65%
```

## 3. 新設計方案

### 3.1 layout 參數結構

生成器可返回的 `figure_data` 新增 `layout_question` 和 `layout_explanation`:

```python
{
    'type': 'function_plot',

    # 圖形繪製參數（傳給 FigureGenerator）
    'params': {
        'figure_width': '9cm',
        'figure_height': '6cm',
        'x_range': (-3, 3),
        # ...
    },

    # 題目頁面佈局參數（可選）
    'layout_question': {
        'width_ratio': 0.50,  # 比例值 0~1
        'position': 'right'   # 可選，覆蓋 get_figure_position()
    },

    # 詳解頁面佈局參數（可選）
    'layout_explanation': {
        'width_ratio': 0.65,  # 比例值 0~1
        'position': 'bottom'  # 可選，覆蓋 get_explanation_figure_position()
    }
}
```

### 3.2 比例驅動的寬度計算

#### 題目頁面（使用絕對單位 cm）

**邏輯**:
```python
# 從 layout_question 讀取比例，若無則使用原有邏輯
layout_q = figure_data_question.get('layout_question', {}) if figure_data_question else {}
custom_ratio = layout_q.get('width_ratio')

if custom_ratio is not None:
    # 使用自訂比例
    figure_w = round(custom_ratio * available_width, 3)
else:
    # 使用原有比例邏輯
    figure_w = round(figure_width_ratio * available_width, 3)

# 應用到 resizebox
resized_figure = f"\\resizebox{{{figure_w}cm}}{{!}}{{{figure_content}}}"
```

#### 詳解頁面（使用相對單位 \linewidth）

**邏輯**:
```python
# 從 layout_explanation 讀取比例
layout_e = figure_data_explanation.get('layout_explanation', {}) if figure_data_explanation else {}

if explanation_figure_position == 'right':
    # right 位置：預設填滿 minipage
    width_ratio = layout_e.get('width_ratio', 1.0)
    right_figure = f"\\resizebox{{{width_ratio}\\linewidth}}{{!}}{{{figure_content}}}"

elif explanation_figure_position == 'bottom':
    # bottom 位置：預設 0.65（從 0.9 改過來）
    width_ratio = layout_e.get('width_ratio', 0.65)
    bottom_figure = f"\\resizebox{{{width_ratio}\\linewidth}}{{!}}{{{figure_content}}}"
```

### 3.3 位置參數優先級

```python
# 題目頁面
layout_q = figure_data_question.get('layout_question', {}) if figure_data_question else {}
figure_position = layout_q.get('position') or item.get('figure_position', 'right')

# 詳解頁面
layout_e = figure_data_explanation.get('layout_explanation', {}) if figure_data_explanation else {}
explanation_figure_position = layout_e.get('position') or question.get('explanation_figure_position', 'right')
```

**優先級**（高到低）:
1. `layout.position`（最高，單次覆蓋）
2. `get_figure_position()` / `get_explanation_figure_position()`（次高，生成器預設）
3. LaTeX Generator 預設值（最低，`'right'`）

## 4. 實施計畫

### 階段一：修改 LaTeX Generator（核心功能）

**檔案**: `utils/latex/generator.py`

#### Step 1.1: 題目頁面支援 layout_question（Line 133 附近開始修改）

**A. 讀取 layout_question 參數**
```python
# 當前 Line 133
figure_position = item.get('figure_position', 'right')

# 修改為
layout_q = {}
if figure_data_question:
    layout_q = figure_data_question.get('layout_question', {})
figure_position = layout_q.get('position') or item.get('figure_position', 'right')
```

**B. 應用 width_ratio（Line 165-178 修改）**

在 `if figure_content and figure_position != 'none':` 區塊內：

```python
# 讀取自訂比例
custom_width_ratio = layout_q.get('width_ratio')

if figure_position == 'right':
    # 計算實際寬度
    if custom_width_ratio is not None:
        calculated_figure_w = round(custom_width_ratio * available_width, 3)
    else:
        calculated_figure_w = figure_w  # 使用原有邏輯計算的值

    resized_figure = f"\\resizebox{{{calculated_figure_w}cm}}{{!}}{{{figure_content}}}"
    # ... 其餘代碼不變

elif figure_position == 'left':
    # 同 right 邏輯
    if custom_width_ratio is not None:
        calculated_figure_w = round(custom_width_ratio * available_width, 3)
    else:
        calculated_figure_w = figure_w

    resized_figure = f"\\resizebox{{{calculated_figure_w}cm}}{{!}}{{{figure_content}}}"
    # ... 其餘代碼不變

elif figure_position == 'bottom':
    # bottom 位置：如果有自訂比例，使用比例；否則填滿
    if custom_width_ratio is not None:
        calculated_width = round(custom_width_ratio * (w - text_x_offset - 2*INNER_SEP_VALUE - SAFETY_MARGIN), 3)
    else:
        calculated_width = content_width  # 原有邏輯：填滿

    resized_figure = f"\\resizebox{{{calculated_width}cm}}{{!}}{{{figure_content}}}"
    # ... 其餘代碼不變
```

#### Step 1.2: 詳解頁面支援 layout_explanation（Line 538 附近開始修改）

**A. 讀取 layout_explanation 參數（Line 547 附近）**
```python
# 當前 Line 547
explanation_figure_position = question.get('explanation_figure_position', 'right')

# 修改為
layout_e = {}
if figure_data_explanation:
    layout_e = figure_data_explanation.get('layout_explanation', {})
explanation_figure_position = layout_e.get('position') or question.get('explanation_figure_position', 'right')
```

**B. 應用 width_ratio（Line 552-563 修改）**

```python
if figure_content:
    if explanation_figure_position == 'right':
        # right 位置：在 0.38\linewidth minipage 內
        # 預設填滿 minipage（1.0），可自訂
        width_ratio = layout_e.get('width_ratio', 1.0)
        right_figure = f"\\resizebox{{{width_ratio}\\linewidth}}{{!}}{{{figure_content}}}"
        # ... 其餘代碼不變

    elif explanation_figure_position == 'bottom':
        # bottom 位置：預設 0.65（從 0.9 改過來）✅ 核心修改
        width_ratio = layout_e.get('width_ratio', 0.65)
        bottom_figure = f"\\resizebox{{{width_ratio}\\linewidth}}{{!}}{{{figure_content}}}"
        # ... 其餘代碼不變
```

### 階段二：更新開發指南文檔

**檔案**: `docs/生成器開發指南.md`

在適當章節（建議第6章「圖形數據整合」）添加：

```markdown
### 6.X 配圖佈局參數（layout 參數群）

生成器可以通過 `layout_question` 和 `layout_explanation` 參數控制圖形在 LaTeX 中的顯示寬度。

#### 使用方式

在 `get_figure_data_question()` 或 `get_figure_data_explanation()` 返回的字典中添加：

\`\`\`python
def get_figure_data_explanation(self):
    return {
        'type': 'function_plot',
        'params': {
            'figure_width': '9cm',  # pgfplots 繪圖區域尺寸
            'figure_height': '6cm',
            # ... 其他繪圖參數
        },
        'layout_explanation': {
            'width_ratio': 0.65,  # 佔可用寬度的 65%
            'position': 'bottom'  # 可選，覆蓋 get_explanation_figure_position()
        }
    }
\`\`\`

#### 參數說明

**layout_question**（題目頁面佈局）:
- `width_ratio` (float, 0~1): 圖形佔可用寬度的比例
  - 若不設定，使用預設比例（Small/Square: 0.40, 其他: 0.35）
- `position` (str, optional): 覆蓋 `get_figure_position()`
  - 可選值：'right', 'left', 'bottom'

**layout_explanation**（詳解頁面佈局）:
- `width_ratio` (float, 0~1): 圖形佔可用寬度的比例
  - right 位置預設 1.0（填滿 minipage）
  - bottom 位置預設 0.65（佔 tcolorbox 寬度 65%）
- `position` (str, optional): 覆蓋 `get_explanation_figure_position()`
  - 可選值：'right', 'bottom'

#### 使用場景

1. **簡單圖形需要較小空間**：
   \`\`\`python
   'layout_explanation': {'width_ratio': 0.55}
   \`\`\`

2. **複雜圖形需要較大空間**：
   \`\`\`python
   'layout_explanation': {'width_ratio': 0.80}
   \`\`\`

3. **動態調整位置和寬度**：
   \`\`\`python
   'layout_question': {
       'width_ratio': 0.50,
       'position': 'bottom'
   }
   \`\`\`

#### 注意事項

- layout 參數是**可選的**，不設定時使用預設行為
- `width_ratio` 值應在 0~1 範圍內
- 題目頁面使用 cm 單位（LaTeX Generator 自動轉換）
- 詳解頁面使用 \linewidth 相對單位（LaTeX Generator 自動轉換）
```

### 階段三：測試驗證

#### Step 3.1: 預設行為測試

**測試目標**: 確保未使用 layout 參數的生成器行為不變

**測試方法**:
```bash
python main.py
# 選擇各種生成器（三角函數、對數等）
# 生成 PDF 檢查圖形顯示
```

**檢查點**:
- ✅ 題目頁面圖形寬度正確（Small/Square: 40%, 其他: 35%）
- ✅ 題目頁面 bottom 位置填滿可用寬度
- ✅ 詳解頁面 right 位置填滿 minipage
- ✅ 詳解頁面 bottom 位置使用新預設 65%（從 90% 改過來）

#### Step 3.2: 二次函數極值生成器測試

**測試目標**: 驗證詳解 bottom 新預設值 0.65 的效果

**測試方法**:
```bash
python main.py
# 選擇「二次函數的極值」
# 生成全域極值和區間極值題型
```

**預期效果**:
- ✅ 全域極值詳解圖形佔 65% 寬度（不會過大）
- ✅ 區間極值詳解圖形佔 65% 寬度
- ✅ 圖形完全在藍色邊框內
- ✅ 左右留白適當

#### Step 3.3: layout 參數功能測試（未來擴展時）

當有新生成器使用 layout 參數時，驗證：
- ✅ `width_ratio` 正確應用
- ✅ `position` 正確覆蓋
- ✅ 題目和詳解分別控制

## 5. 向後兼容性保證

### 5.1 未使用 layout 的現有生成器

**行為**: 完全不受影響

**原因**:
```python
# 現有生成器返回
{
    'type': 'function_plot',
    'params': {...}
    # 沒有 layout_question 或 layout_explanation
}

# LaTeX Generator 處理
layout_q = figure_data_question.get('layout_question', {})  # 返回 {}
custom_ratio = layout_q.get('width_ratio')  # 返回 None

if custom_ratio is not None:  # False，跳過
    ...
else:
    # 使用原有邏輯，行為完全相同
    figure_w = round(figure_width_ratio * available_width, 3)
```

### 5.2 預設值變更影響分析

**唯一變更**: 詳解頁面 bottom 位置從 `0.9` 改為 `0.65`

**影響範圍**: 所有使用 `explanation_figure_position = 'bottom'` 的生成器

**當前受影響的生成器**:
- `generators/algebra/quadratic_extremum.py` ← 預期修改
- 其他使用 bottom 位置的生成器（需檢查）

**檢查方法**:
```bash
grep -r "get_explanation_figure_position" generators/ | grep "bottom"
```

### 5.3 FigureRenderer 不受影響

**原因**:
```python
# FigureRenderer.render() 只提取 params
figure_type = figure_data['type']
params = figure_data.get('params', {})
# layout_question 和 layout_explanation 不傳遞給 FigureGenerator
```

### 5.4 現有位置參數機制保留

**題目位置**:
```python
# 優先級: layout.position > figure_position > 'right'
figure_position = layout_q.get('position') or item.get('figure_position', 'right')
```

**詳解位置**:
```python
# 優先級: layout.position > explanation_figure_position > 'right'
explanation_figure_position = layout_e.get('position') or question.get('explanation_figure_position', 'right')
```

## 6. 預設值總結

### 6.1 題目頁面預設值（保持不變）

| 格子類型 | 位置 | 圖形寬度 | 計算公式 |
|---------|------|---------|---------|
| Small/Square | right | 40% | `0.40 * available_width` |
| Small/Square | left | 40% | `0.40 * available_width` |
| Small/Square | bottom | 填滿 | `content_width` |
| Wide/Medium/Large/Extra | right | 35% | `0.35 * available_width` |
| Wide/Medium/Large/Extra | left | 35% | `0.35 * available_width` |
| Wide/Medium/Large/Extra | bottom | 填滿 | `content_width` |

### 6.2 詳解頁面預設值

| 位置 | 當前預設 | 修改後預設 | 說明 |
|------|---------|-----------|------|
| right | `1.0\linewidth` | **保持不變** | 填滿 0.38\linewidth minipage |
| bottom | `0.9\linewidth` | **改為 0.65** | ✅ 唯一修改點 |

## 7. 風險評估

### 低風險
- ✅ 只修改 `utils/latex/generator.py`（單一模組）
- ✅ 新參數是可選的（完全向後兼容）
- ✅ 不影響 FigureRenderer
- ✅ 不需要修改任何生成器

### 需要注意
- ⚠️ 詳解 bottom 預設值從 0.9 改為 0.65，需要測試所有使用 bottom 位置的生成器
- ⚠️ 確保 `width_ratio` 值在合理範圍（0~1）
- ⚠️ 題目頁面 bottom 位置若使用 `width_ratio`，計算基準是 `content_width`

### 測試覆蓋
**必測場景**:
1. 二次函數極值（詳解 bottom）← 預期改善
2. 三角函數（詳解 right）← 應不受影響
3. 對數內插（詳解 bottom，如有）
4. 題目頁面各位置（right/left/bottom）

## 8. 成功標準

- ✅ 二次函數極值詳解圖形佔 65% 寬度（不再過大）
- ✅ 圖形完全在藍色邊框內，左右留白適當
- ✅ 所有其他生成器行為不變
- ✅ 題目頁面圖形寬度符合預設比例
- ✅ 無 LaTeX 編譯錯誤
- ✅ 未來生成器可使用 layout 參數自訂寬度

## 9. 未來擴展方向

### 9.1 支援更多佈局參數
```python
'layout_explanation': {
    'width_ratio': 0.65,
    'height_ratio': 0.8,         # 未來：高度比例
    'vertical_spacing': '1em',   # 未來：垂直間距
    'horizontal_align': 'center' # 未來：水平對齊
}
```

### 9.2 支援不同單位系統
```python
'layout_explanation': {
    'width': '8cm',           # 絕對寬度
    # 或
    'width_ratio': 0.65,      # 相對寬度
    'unit': 'linewidth'       # 單位類型
}
```

---

**總結**: 此方案通過引入 `layout_question` 和 `layout_explanation` 參數群，建立彈性的配圖佈局控制機制，同時調整詳解 bottom 預設值解決當前問題，完全向後兼容，為未來提供擴展性。
