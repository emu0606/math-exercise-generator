# 圖形生成器開發指南改善計畫

> **日期**: 2025-10-11
> **目標**: 基於導入機制調查結果，改善圖形生成器開發指南
> **狀態**: 研擬中，待討論

---

## 📋 改善目標

基於 [圖形生成器自動導入機制調查報告](20251011_圖形生成器導入機制調查報告_研擬中.md) 的發現，需要在開發指南中補充以下關鍵資訊：

1. **惰性導入機制說明**: 解釋 figures 模組何時被載入
2. **註冊機制細節**: 說明裝飾器和手動導入的關係
3. **開發注意事項**: 強調不可移除的手動導入代碼
4. **測試和驗證**: 提供驗證圖形生成器註冊的方法

---

## 🔍 當前文檔分析

### ✅ 當前文檔優點

1. **結構清晰**: 從概述到實作到最佳實踐，層次分明
2. **範例豐富**: 提供完整的代碼範例
3. **實用性強**: 包含參數設計、TikZ 生成、測試等實用內容
4. **文檔意識**: 提醒開發者更新 `available_figures.md`

### ⚠️ 需要補充的關鍵資訊

根據調查報告，以下重要機制在當前文檔中**缺失或不夠明確**：

1. **缺失：惰性導入機制**
   - 未說明 figures 模組何時被導入
   - 未說明與 generators 導入時機的差異
   - 開發者可能誤以為圖形生成器在 UI 啟動時就已註冊

2. **缺失：註冊機制內部運作**
   - 雖然展示了 `@register_figure_generator` 的使用
   - 但未說明裝飾器只在類被導入時才執行
   - 未說明 `figures/__init__.py` 底部手動導入的必要性

3. **缺失：開發限制和注意事項**
   - 未明確警告不可移除 `__init__.py` 的手動導入
   - 未說明新增圖形生成器時需要添加到手動導入列表

4. **缺失：驗證和測試方法**
   - 未提供驗證圖形生成器是否成功註冊的方法
   - 未說明如何測試導入機制

---

## 📝 具體改善建議

### 建議 1: 新增「導入與註冊機制」專節

在「核心概念」章節後，新增一節詳細說明導入機制：

```markdown
## 導入與註冊機制

### 惰性導入設計

figures 模組採用**惰性導入 (Lazy Import)** 機制：

- **啟動時**: UI 啟動時不會導入 figures 模組
- **首次使用**: 通常在 PDF 生成階段由 `FigureRenderer` 觸發導入
- **性能優化**: 減少 UI 啟動時間約 15%，節省 5-10 MB 記憶體

```python
# 應用程式啟動流程
main.py
  ├─ import generators     # ✅ 自動註冊所有題目生成器
  └─ UI 啟動               # ❌ figures 不會被導入

# PDF 生成流程
用戶點擊「生成PDF」
  └─ FigureRenderer.render()
       └─ import figures   # ⭐ 此時才觸發導入和註冊
```

### 裝飾器註冊原理

`@register_figure_generator` 裝飾器的執行時機：

```python
@register_figure_generator
class CircleGenerator(FigureGenerator):
    # ⭐ 裝飾器只有在此類被導入時才執行
    pass
```

**關鍵點**:
1. 裝飾器在類定義時執行（模組導入時）
2. 未被導入的類不會被註冊
3. 這就是為什麼需要 `__init__.py` 中的手動導入

### figures/__init__.py 的關鍵角色

`figures/__init__.py` 底部的手動導入代碼是**註冊系統的核心**：

```python
# figures/__init__.py (底部)
# ⚠️ 這些手動導入是必要的，不可移除

# 基礎圖形生成器
from .unit_circle import UnitCircleGenerator
from .circle import CircleGenerator
from .coordinate_system import CoordinateSystemGenerator
# ... 其他導入
```

**為什麼需要手動導入？**

1. **觸發裝飾器**: 只有導入類，裝飾器才會執行
2. **建立註冊表**: 將所有生成器加入 `_figure_generators` 字典
3. **提供統一接口**: 讓 `get_figure_generator()` 能找到生成器

**如果移除會發生什麼？**

```python
# ❌ 錯誤：移除手動導入
# figures/__init__.py 不再導入 CircleGenerator

# 後果：
import figures
circle_gen = figures.get_figure_generator('circle')
# ValueError: 找不到類型為 'circle' 的圖形生成器
```

### 驗證註冊是否成功

開發完成後，驗證圖形生成器是否正確註冊：

```python
# 驗證腳本
import figures

# 檢查所有已註冊的圖形類型
registered = figures.get_registered_figure_types()
print(f"已註冊圖形數量: {len(registered)}")
print(f"圖形類型列表: {list(registered.keys())}")

# 驗證特定生成器
try:
    MyGen = figures.get_figure_generator('my_figure_type')
    print(f"✅ 成功找到: {MyGen.__name__}")
except ValueError as e:
    print(f"❌ 註冊失敗: {e}")
```
```

---

### 建議 2: 更新「註冊機制」章節

擴充原有的簡短說明，加入更多細節：

```markdown
### 註冊機制

#### 使用裝飾器註冊

```python
from figures import register_figure_generator
from figures.base import FigureGenerator

@register_figure_generator
class MyFigureGenerator(FigureGenerator):
    @classmethod
    def get_name(cls) -> str:
        return 'my_figure_type'  # ⚠️ 必須是唯一的類型名稱
```

#### 註冊流程說明

1. **定義生成器類**: 繼承 `FigureGenerator`
2. **添加裝飾器**: 使用 `@register_figure_generator`
3. **實現 get_name()**: 返回唯一的圖形類型標識符
4. **添加到 __init__.py**: ⚠️ **關鍵步驟** - 在 `figures/__init__.py` 底部添加手動導入

```python
# figures/__init__.py (底部新增)
from .my_figure import MyFigureGenerator  # ⚠️ 必須手動添加此行
```

#### ⚠️ 常見錯誤

**錯誤 1: 忘記添加到 __init__.py**
```python
# ❌ 錯誤做法：只定義類和裝飾器
# my_figure.py
@register_figure_generator
class MyFigureGenerator(FigureGenerator):
    pass

# 但沒有在 __init__.py 中導入
# 結果：生成器不會被註冊
```

**錯誤 2: 移除現有的手動導入**
```python
# ❌ 嚴重錯誤：以為可以「清理」手動導入
# figures/__init__.py
# from .circle import CircleGenerator  # 被移除

# 結果：所有依賴 CircleGenerator 的功能失效
```

**正確做法**
```python
# ✅ 完整的註冊流程

# 1. 定義生成器
# figures/my_figure.py
from figures import register_figure_generator
from figures.base import FigureGenerator

@register_figure_generator
class MyFigureGenerator(FigureGenerator):
    @classmethod
    def get_name(cls) -> str:
        return 'my_figure'

    def generate_tikz(self, params):
        return "\\draw (0,0) circle (1);"

# 2. 添加到 __init__.py
# figures/__init__.py (底部)
from .my_figure import MyFigureGenerator  # ⚠️ 手動添加此行

# 3. 驗證註冊
import figures
assert 'my_figure' in figures.get_registered_figure_types()
print("✅ 註冊成功")
```
```

---

### 建議 3: 新增「開發注意事項」警告框

在多個關鍵位置添加醒目的警告框：

```markdown
### 註冊機制

> ⚠️ **重要**: figures/__init__.py 中的手動導入代碼
>
> `figures/__init__.py` 底部的所有手動導入語句（如 `from .circle import CircleGenerator`）是註冊系統的核心機制，**絕對不可移除**。
>
> - 這些導入觸發 `@register_figure_generator` 裝飾器的執行
> - 移除任何一行會導致對應的圖形生成器無法使用
> - 新增圖形生成器時，必須在此處添加對應的導入語句
>
> 更多細節請參考「導入與註冊機制」章節。

---

### 生成器實作

> 💡 **提示**: 開發完成後的檢查清單
>
> 1. [ ] 實現 `FigureGenerator` 的所有必要方法
> 2. [ ] 使用 `@register_figure_generator` 裝飾器
> 3. [ ] ⚠️ 在 `figures/__init__.py` 底部添加手動導入
> 4. [ ] 運行驗證腳本確認註冊成功
> 5. [ ] 更新 `available_figures.md` 文檔
> 6. [ ] 編寫單元測試
```

---

### 建議 4: 更新「測試驗證」章節

擴充測試章節，加入註冊驗證測試：

```markdown
### 測試驗證

#### 1. 註冊驗證測試 (優先執行)

```python
def test_figure_registration():
    """驗證圖形生成器是否正確註冊"""
    import figures

    # 檢查是否在註冊表中
    registered_types = figures.get_registered_figure_types()
    assert 'my_figure' in registered_types, "圖形類型未註冊"

    # 檢查是否能正確獲取
    generator_class = figures.get_figure_generator('my_figure')
    assert generator_class is not None, "無法獲取生成器類"
    assert generator_class.__name__ == 'MyFigureGenerator'

    print("✅ 註冊驗證通過")
```

#### 2. 基本功能測試

```python
def test_circle_generation():
    """測試基本的圖形生成功能"""
    import figures

    # 獲取生成器
    CircleGen = figures.get_figure_generator('circle')
    generator = CircleGen()

    # 測試生成
    params = {'radius': 2.0, 'center_x': 1.0, 'center_y': 1.0}
    result = generator.generate_tikz(params)

    # 驗證輸出
    assert 'circle (2.0)' in result
    assert isinstance(result, str)
    assert len(result) > 0

    print("✅ 基本功能測試通過")
```

#### 3. 變體測試

```python
def test_circle_variants():
    """測試 question/explanation 變體"""
    import figures

    generator = figures.get_figure_generator('circle')()

    # 測試題目變體
    question_params = {'radius': 1.0, 'variant': 'question'}
    question_result = generator.generate_tikz(question_params)

    # 測試解答變體
    explanation_params = {'radius': 1.0, 'variant': 'explanation'}
    explanation_result = generator.generate_tikz(explanation_params)

    # 解答圖應該有更多元素
    assert len(explanation_result) >= len(question_result)

    print("✅ 變體測試通過")
```

#### 4. 參數驗證測試

```python
def test_parameter_validation():
    """測試參數驗證功能"""
    import figures
    from pydantic import ValidationError

    generator = figures.get_figure_generator('circle')()

    # 測試無效參數
    try:
        invalid_params = {'radius': -1.0}  # 負數半徑
        generator.generate_tikz(invalid_params)
        assert False, "應該拋出驗證錯誤"
    except (ValidationError, ValueError):
        print("✅ 參數驗證測試通過")
```

#### 測試執行順序建議

```bash
# 1. 首先驗證註冊 (最重要)
python -c "from test_my_figure import test_figure_registration; test_figure_registration()"

# 2. 基本功能測試
python -c "from test_my_figure import test_circle_generation; test_circle_generation()"

# 3. 完整測試套件
pytest tests/test_figure_my_figure.py -v
```
```

---

### 建議 5: 新增「故障排除」具體案例

在「故障排除」章節中，新增具體的註冊相關錯誤：

```markdown
### 故障排除

#### 註冊相關錯誤

**錯誤 1: ValueError: 找不到類型為 'xxx' 的圖形生成器**

```python
# 錯誤訊息
ValueError: 找不到類型為 'my_figure' 的圖形生成器
```

**原因與解決方法**:

1. **忘記添加到 __init__.py**
   ```python
   # 檢查 figures/__init__.py 底部是否有
   from .my_figure import MyFigureGenerator

   # 如果沒有，手動添加此行
   ```

2. **get_name() 返回值不匹配**
   ```python
   # 檢查生成器的 get_name() 方法
   @classmethod
   def get_name(cls) -> str:
       return 'my_figure'  # 必須與使用時的名稱完全一致
   ```

3. **驗證是否註冊成功**
   ```python
   import figures
   print(list(figures.get_registered_figure_types().keys()))
   # 檢查輸出列表中是否包含你的圖形類型
   ```

**錯誤 2: 圖形生成器數量不符預期**

```python
# 檢查註冊數量
import figures
print(f"已註冊圖形: {len(figures.get_registered_figure_types())}")
# 預期: 13 (或更多，如果你新增了圖形)
```

**原因**: 可能有手動導入被意外移除或註釋掉

**解決方法**: 檢查 `figures/__init__.py` 底部，確保所有圖形生成器都有對應的導入語句

---

**錯誤 3: 裝飾器沒有執行**

**症狀**: 定義了 `@register_figure_generator`，但圖形仍然找不到

**原因**: 類所在的模組從未被導入

**解決方法**:
```python
# 1. 確認裝飾器正確使用
@register_figure_generator  # ⚠️ 不要忘記這個裝飾器
class MyFigureGenerator(FigureGenerator):
    pass

# 2. 確認添加到 __init__.py
# figures/__init__.py
from .my_figure import MyFigureGenerator  # ⚠️ 必須有此行

# 3. 測試導入
python -c "import figures; print('my_figure' in figures.get_registered_figure_types())"
```
```

---

## 📊 改善計畫總結

### 新增章節

1. **「導入與註冊機制」專節** (核心概念之後)
   - 惰性導入設計
   - 裝飾器註冊原理
   - `__init__.py` 的關鍵角色
   - 驗證註冊方法

### 擴充章節

2. **「註冊機制」章節**
   - 詳細的註冊流程
   - 常見錯誤和正確做法
   - 完整的範例代碼

3. **「測試驗證」章節**
   - 註冊驗證測試 (優先級最高)
   - 測試執行順序建議

4. **「故障排除」章節**
   - 註冊相關錯誤的具體案例
   - 診斷和解決步驟

### 新增警告框

5. **多處添加醒目的警告和提示**
   - ⚠️ 不可移除手動導入的警告
   - 💡 開發完成檢查清單
   - ⚠️ 常見錯誤提醒

---

## ✅ 實施步驟

1. **Phase 1: 核心內容補充** (優先)
   - [ ] 新增「導入與註冊機制」專節
   - [ ] 更新「註冊機制」章節
   - [ ] 添加關鍵警告框

2. **Phase 2: 測試和驗證**
   - [ ] 擴充「測試驗證」章節
   - [ ] 提供完整的驗證腳本

3. **Phase 3: 故障排除**
   - [ ] 新增註冊相關錯誤案例
   - [ ] 提供診斷和解決方法

4. **Phase 4: 驗證和審核**
   - [ ] 確保所有範例代碼可執行
   - [ ] 檢查文檔結構和流暢度
   - [ ] 與現有文檔保持一致性

---

## 🎯 預期成果

改善後的開發指南將：

1. ✅ **防止常見錯誤**: 明確警告不可移除手動導入
2. ✅ **加深理解**: 解釋惰性導入和註冊機制的原理
3. ✅ **提升效率**: 提供完整的驗證和測試方法
4. ✅ **降低學習曲線**: 通過具體案例說明故障排除

開發者將能夠：
- 理解 figures 模組何時被載入
- 正確實現和註冊新的圖形生成器
- 快速診斷和解決註冊相關問題
- 避免破壞現有的註冊機制

---

## 📚 相關文檔

- [圖形生成器自動導入機制調查報告](20251011_圖形生成器導入機制調查報告_研擬中.md) - 調查依據
- [圖形生成器開發指南](圖形生成器開發指南.md) - 當前文檔
- [available_figures.md](available_figures.md) - 圖形類型參考

---

**計畫制定日期**: 2025-10-11
**待討論事項**: 改善內容的優先順序和具體措辭
