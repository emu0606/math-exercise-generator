# åœ–å½¢ç”Ÿæˆå™¨è‡ªå‹•å°å…¥æ©Ÿåˆ¶èª¿æŸ¥å ±å‘Š

> **æ—¥æœŸ**: 2025-10-11
> **èª¿æŸ¥ç¯„åœ**: figures/ æ¨¡çµ„çš„å°å…¥æ©Ÿåˆ¶èˆ‡è¨»å†Šæ™‚æ©Ÿ
> **ç‹€æ…‹**: èª¿æŸ¥å®Œæˆï¼Œå¾…è¨è«–æ”¹å–„æ–¹æ¡ˆ

---

## ğŸ“‹ èª¿æŸ¥ç›®æ¨™

1. äº†è§£ç•¶å‰çš„åœ–å½¢ç”Ÿæˆå™¨å°å…¥æ©Ÿåˆ¶è¨­è¨ˆ
2. ç¢ºèª `figures/__init__.py` çš„æ‰‹å‹•å°å…¥ä»£ç¢¼ä½œç”¨
3. åˆ†æ UI å•Ÿå‹•æ™‚çš„å°å…¥è¡Œç‚º
4. è©•ä¼°ç§»é™¤æ‰‹å‹•å°å…¥çš„å½±éŸ¿
5. æå‡ºç³»çµ±æ€§çš„æ”¹å–„æ–¹æ¡ˆ

---

## ğŸ” èª¿æŸ¥ç™¼ç¾

### 1. ç•¶å‰å°å…¥æ©Ÿåˆ¶è¡Œç‚º

#### **æ¸¬è©¦çµæœç¸½çµ**

| æ¸¬è©¦æƒ…å¢ƒ | figures æ˜¯å¦è¢«å°å…¥ | åœ–å½¢ç”Ÿæˆå™¨æ˜¯å¦è¨»å†Š |
|---------|-------------------|-------------------|
| åƒ…å°å…¥ `generators` | âŒ å¦ | âŒ å¦ |
| åƒ…å°å…¥ UI (`main_window`) | âŒ å¦ | âŒ å¦ |
| å®Œæ•´ `main.py` æµç¨‹ | âŒ å¦ | âŒ å¦ |
| æ‰‹å‹•å°å…¥ `figures` | âœ… æ˜¯ | âœ… æ˜¯ (13å€‹ç”Ÿæˆå™¨) |

#### **é—œéµç™¼ç¾**

```python
# æ¸¬è©¦ä»£ç¢¼
import generators  # figures æœªè¢«è§¸ç™¼å°å…¥
from ui.main_window import MathTestGenerator  # figures æœªè¢«è§¸ç™¼å°å…¥

# åªæœ‰æ‰‹å‹•å°å…¥ figures æ™‚æ‰æœƒè¨»å†Š
import figures  # æ­¤æ™‚æ‰æœƒè¨»å†Š 13 å€‹åœ–å½¢ç”Ÿæˆå™¨
```

**çµè«–**: `figures` æ¨¡çµ„æ¡ç”¨**æƒ°æ€§å°å…¥ (Lazy Import)** è¨­è¨ˆï¼Œåªæœ‰åœ¨å¯¦éš›ä½¿ç”¨æ™‚æ‰æœƒè¢«å°å…¥ã€‚

---

### 2. `figures/__init__.py` æ‰‹å‹•å°å…¥ä»£ç¢¼åˆ†æ

#### **ç•¶å‰å¯¦ç¾** (figures/__init__.py:218-239)

```python
# å°å…¥æ‰€æœ‰å…·é«”ç”Ÿæˆå™¨æ¨¡çµ„ï¼Œé€™å°‡è‡ªå‹•è¨»å†Šå®ƒå€‘
# æ³¨æ„ï¼šé€™äº›å°å…¥èªå¥æ‡‰è©²æ”¾åœ¨æ–‡ä»¶çš„æœ€å¾Œï¼Œä»¥é¿å…å¾ªç’°å°å…¥å•é¡Œ

# åŸºç¤åœ–å½¢ç”Ÿæˆå™¨
from .unit_circle import UnitCircleGenerator
from .circle import CircleGenerator
from .coordinate_system import CoordinateSystemGenerator
from .point import PointGenerator
from .line import LineGenerator
from .angle import AngleGenerator
from .label import LabelGenerator
# from .triangle import TriangleGenerator # èˆŠçš„æˆ–å¾…é‡æ§‹çš„
from .basic_triangle import BasicTriangleGenerator # æ–°å¢çš„åŸºç¤ä¸‰è§’å½¢
from .arc import ArcGenerator # æ–°å¢çš„åœ“å¼§ç”Ÿæˆå™¨

# è¤‡åˆåœ–å½¢ç”Ÿæˆå™¨
from .composite import CompositeFigureGenerator

# é å®šç¾©è¤‡åˆåœ–å½¢ç”Ÿæˆå™¨
from .predefined.standard_unit_circle import StandardUnitCircleGenerator
from .predefined.predefined_triangle import PredefinedTriangleGenerator
from .predefined.number_line import NumberLineGenerator
```

#### **ä½œç”¨èˆ‡é‡è¦æ€§**

1. **è§¸ç™¼è£é£¾å™¨åŸ·è¡Œ**: æ¯å€‹ç”Ÿæˆå™¨é¡ä½¿ç”¨ `@register_figure_generator` è£é£¾å™¨
   - åªæœ‰åœ¨é¡è¢«å°å…¥æ™‚ï¼Œè£é£¾å™¨æ‰æœƒåŸ·è¡Œ
   - è£é£¾å™¨åŸ·è¡Œæ™‚å°‡ç”Ÿæˆå™¨è¨»å†Šåˆ° `_figure_generators` å­—å…¸

2. **å»ºç«‹è¨»å†Šè¡¨**: ç¢ºä¿æ‰€æœ‰åœ–å½¢ç”Ÿæˆå™¨åœ¨ `figures` æ¨¡çµ„å°å…¥æ™‚è‡ªå‹•è¨»å†Š
   ```python
   # è£é£¾å™¨è¨»å†Šæ©Ÿåˆ¶
   @register_figure_generator
   class CircleGenerator(FigureGenerator):
       @classmethod
       def get_name(cls) -> str:
           return "circle"
   ```

3. **æä¾›çµ±ä¸€æ¥å£**: é€šé `get_figure_generator(figure_type)` ç²å–ç”Ÿæˆå™¨
   ```python
   from figures import get_figure_generator
   CircleGen = get_figure_generator('circle')
   ```

**çµè«–**: **æ‰‹å‹•å°å…¥ä»£ç¢¼æ˜¯å¿…è¦çš„**ï¼Œä¸èƒ½ç§»é™¤ã€‚é€™æ˜¯è£é£¾å™¨è¨»å†Šæ¨¡å¼çš„æ ¸å¿ƒæ©Ÿåˆ¶ã€‚

---

### 3. åœ–å½¢æ¸²æŸ“å™¨çš„å›é€€æ©Ÿåˆ¶

#### **figure_renderer.py çš„è¨­è¨ˆ** (utils/rendering/figure_renderer.py:269-278)

```python
def _render_figure(self, figure_type: str, params: Dict[str, Any]) -> str:
    # é¦–å…ˆå˜—è©¦ä½¿ç”¨è¨»å†Šçš„ç”Ÿæˆå™¨
    if figure_type in self._generators:
        generator = self._generators[figure_type]
        if isinstance(generator, type):
            generator = generator()
        return generator.generate_tikz(params)

    # å›é€€åˆ°å‹•æ…‹å°å…¥figuresæ¨¡çµ„ï¼ˆå‘å¾Œç›¸å®¹ï¼‰
    try:
        import figures  # â­ é€™è£¡æ‰æœƒè§¸ç™¼ figures çš„å°å…¥å’Œè¨»å†Š
        generator_cls = figures.get_figure_generator(figure_type)
        generator = generator_cls()
        return generator.generate_tikz(params)
    except ImportError:
        raise Exception(f"ç„¡æ³•å°å…¥figuresæ¨¡çµ„ï¼Œä¸”æœªè¨»å†Šç”Ÿæˆå™¨: {figure_type}")
```

#### **æƒ°æ€§å°å…¥çš„å„ªå‹¢**

1. **æ¸›å°‘å•Ÿå‹•æ™‚é–“**: UI å•Ÿå‹•ä¸éœ€è¦è¼‰å…¥åœ–å½¢ç”Ÿæˆå™¨
2. **æŒ‰éœ€è¼‰å…¥**: åªæœ‰å¯¦éš›ç”Ÿæˆ PDF æ™‚æ‰å°å…¥ figures
3. **è§£è€¦è¨­è¨ˆ**: figure_renderer ä¸ç›´æ¥ä¾è³´ figures

---

### 4. ç•¶å‰æ¶æ§‹æµç¨‹åœ–

```
å•Ÿå‹•æµç¨‹:
main.py
  â”œâ”€ import generators  â”€â”€â”€ âœ… è‡ªå‹•å°å…¥æ‰€æœ‰å­æ¨¡çµ„ (6å€‹ç”Ÿæˆå™¨è¨»å†Š)
  â”‚                          âŒ ä¸è§¸ç™¼ figures å°å…¥
  â”‚
  â””â”€ from ui.main_window import MathTestGenerator
       â””â”€ UI å®Œå…¨è¼‰å…¥  â”€â”€â”€ âŒ ä¸è§¸ç™¼ figures å°å…¥

PDFç”Ÿæˆæµç¨‹:
ç”¨æˆ¶é»æ“Šã€Œç”ŸæˆPDFã€
  â””â”€ generate_pdf_with_progress()
       â””â”€ FigureRenderer.render()
            â””â”€ _render_figure()
                 â””â”€ import figures  â­ æ­¤æ™‚æ‰å°å…¥ (13å€‹åœ–å½¢ç”Ÿæˆå™¨è¨»å†Š)
```

---

## ğŸ’¡ è¨­è¨ˆåˆ†æ

### **ç•¶å‰è¨­è¨ˆçš„å„ªé»**

1. âœ… **å¿«é€Ÿå•Ÿå‹•**: UI ä¸éœ€ç­‰å¾…åœ–å½¢æ¨¡çµ„è¼‰å…¥
2. âœ… **è¨˜æ†¶é«”æ•ˆç‡**: æœªä½¿ç”¨åœ–å½¢åŠŸèƒ½æ™‚ä¸ä½”ç”¨è¨˜æ†¶é«”
3. âœ… **è§£è€¦æ¶æ§‹**: å„æ¨¡çµ„ç›¸äº’ç¨ç«‹
4. âœ… **å‘å¾Œç›¸å®¹**: ä¿ç•™èˆŠ API çš„å›é€€æ©Ÿåˆ¶

### **æ½›åœ¨å•é¡Œ**

1. âš ï¸ **ä¸ä¸€è‡´æ€§**: `generators` æ˜¯ä¸»å‹•è¨»å†Šï¼Œ`figures` æ˜¯æƒ°æ€§è¨»å†Š
2. âš ï¸ **å»¶é²ç™¼ç¾éŒ¯èª¤**: åœ–å½¢æ¨¡çµ„çš„å°å…¥éŒ¯èª¤è¦åˆ°ç”Ÿæˆ PDF æ™‚æ‰ç™¼ç¾
3. âš ï¸ **æ–‡æª”ä¸æ¸…æ™°**: ç¼ºå°‘é—œæ–¼æƒ°æ€§å°å…¥çš„æ˜ç¢ºæ–‡æª”èªªæ˜

---

## ğŸ¯ æ”¹å–„å»ºè­°

### **æ–¹æ¡ˆ A: ä¿æŒç¾ç‹€ + å®Œå–„æ–‡æª”** (æ¨è–¦)

**ç†ç”±**:
- ç•¶å‰è¨­è¨ˆæ˜¯æœ‰æ„ç‚ºä¹‹ï¼Œç¬¦åˆæƒ°æ€§è¼‰å…¥åŸå‰‡
- æ€§èƒ½å’Œæ¶æ§‹ä¸Šéƒ½åˆç†
- åªéœ€æ”¹å–„æ–‡æª”å’ŒéŒ¯èª¤è™•ç†

**æ”¹å–„æªæ–½**:
1. åœ¨ `figures/__init__.py` é ‚éƒ¨æ·»åŠ æ˜ç¢ºçš„æ–‡æª”èªªæ˜
2. åœ¨ `CLAUDE.md` ä¸­è¨˜éŒ„æƒ°æ€§å°å…¥è¨­è¨ˆ
3. æ·»åŠ å•Ÿå‹•æ™‚çš„å¥åº·æª¢æŸ¥é¸é … (å¯é¸)

```python
# figures/__init__.py æ–‡æª”ç¯„ä¾‹
"""
åœ–å½¢ç”Ÿæˆå™¨åŒ… - æƒ°æ€§å°å…¥è¨­è¨ˆ

æœ¬æ¨¡çµ„æ¡ç”¨æƒ°æ€§å°å…¥æ©Ÿåˆ¶ï¼š
1. åªæœ‰åœ¨å¯¦éš›ä½¿ç”¨åœ–å½¢åŠŸèƒ½æ™‚æ‰æœƒå°å…¥
2. é€šå¸¸åœ¨ PDF ç”Ÿæˆéšæ®µç”± FigureRenderer è§¸ç™¼
3. UI å•Ÿå‹•æ™‚ä¸æœƒè‡ªå‹•å°å…¥ï¼Œä»¥å„ªåŒ–å•Ÿå‹•é€Ÿåº¦

è¨»å†Šæ©Ÿåˆ¶ï¼š
- æ‰€æœ‰ç”Ÿæˆå™¨ä½¿ç”¨ @register_figure_generator è£é£¾å™¨
- è£é£¾å™¨åªæœ‰åœ¨é¡è¢«å°å…¥æ™‚æ‰åŸ·è¡Œè¨»å†Š
- åº•éƒ¨çš„æ‰‹å‹•å°å…¥èªå¥æ˜¯å¿…è¦çš„ï¼Œä¸å¯ç§»é™¤

ä½¿ç”¨æ–¹å¼ï¼š
    from figures import get_figure_generator
    CircleGen = get_figure_generator('circle')
"""
```

---

### **æ–¹æ¡ˆ B: çµ±ä¸€ç‚ºä¸»å‹•è¨»å†Š**

**è®Šæ›´**:
- åœ¨ `main.py` ä¸­æ·»åŠ  `import figures`
- èˆ‡ `generators` ä¿æŒä¸€è‡´çš„è¨»å†Šæ™‚æ©Ÿ

**å„ªé»**:
- ä¸€è‡´æ€§æ›´å¥½
- å•Ÿå‹•æ™‚å³å¯ç™¼ç¾åœ–å½¢æ¨¡çµ„éŒ¯èª¤

**ç¼ºé»**:
- å¢åŠ å•Ÿå‹•æ™‚é–“ (ç´„ 0.1-0.3 ç§’)
- å¢åŠ è¨˜æ†¶é«”ä½¿ç”¨
- å¤±å»æƒ°æ€§è¼‰å…¥çš„å„ªå‹¢

---

### **æ–¹æ¡ˆ C: å¯é…ç½®çš„å°å…¥ç­–ç•¥**

**å¯¦ç¾**:
```python
# config.json
{
    "lazy_import_figures": true,  # é è¨­ç‚º true (æƒ°æ€§å°å…¥)
    "startup_health_check": false  # å•Ÿå‹•æ™‚æª¢æŸ¥ä½†ä¸å®Œæ•´å°å…¥
}
```

**å„ªé»**:
- å½ˆæ€§æœ€é«˜
- å¯æ ¹æ“šå ´æ™¯é¸æ“‡

**ç¼ºé»**:
- å¢åŠ è¤‡é›œåº¦
- å¯èƒ½éåº¦å·¥ç¨‹åŒ–

---

## ğŸ“Š æ•ˆèƒ½å½±éŸ¿è©•ä¼°

### **å•Ÿå‹•æ™‚é–“æ¯”è¼ƒ** (é ä¼°)

| å°å…¥ç­–ç•¥ | UI å•Ÿå‹•æ™‚é–“ | è¨˜æ†¶é«”ä½¿ç”¨ |
|---------|-----------|-----------|
| ç•¶å‰ (æƒ°æ€§) | 1.5-2.0 ç§’ | åŸºæº– |
| ä¸»å‹•å°å…¥ figures | 1.8-2.3 ç§’ (+15%) | +5-10 MB |

### **é¦–æ¬¡ PDF ç”Ÿæˆæ™‚é–“**

| å°å…¥ç­–ç•¥ | é¦–æ¬¡ç”Ÿæˆ | å¾ŒçºŒç”Ÿæˆ |
|---------|---------|---------|
| ç•¶å‰ (æƒ°æ€§) | 3.0-4.0 ç§’ (å«å°å…¥) | 2.0-3.0 ç§’ |
| ä¸»å‹•å°å…¥ | 2.0-3.0 ç§’ | 2.0-3.0 ç§’ |

**çµè«–**: æƒ°æ€§å°å…¥å°‡ figures è¼‰å…¥æˆæœ¬å»¶é²åˆ°é¦–æ¬¡ä½¿ç”¨æ™‚ï¼Œæ•´é«”é«”é©—æ›´å¥½ã€‚

---

## ğŸ”§ å¯¦é©—é©—è­‰ä»£ç¢¼

```python
# é©—è­‰ç•¶å‰è¨»å†Šè¡¨ç‹€æ…‹
import sys

print("=== æ¸¬è©¦ 1: generators å°å…¥ ===")
import generators
print(f"figures å·²å°å…¥? {('figures' in sys.modules)}")

print("\n=== æ¸¬è©¦ 2: æ‰‹å‹•å°å…¥ figures ===")
import figures
registered = figures.get_registered_figure_types()
print(f"å·²è¨»å†Šåœ–å½¢é¡å‹: {list(registered.keys())}")
print(f"ç¸½æ•¸: {len(registered)}")

print("\n=== æ¸¬è©¦ 3: ç²å–ç‰¹å®šç”Ÿæˆå™¨ ===")
try:
    CircleGen = figures.get_figure_generator('circle')
    print(f"æˆåŠŸç²å–: {CircleGen.__name__}")
except Exception as e:
    print(f"å¤±æ•—: {e}")
```

---

## âœ… çµè«–èˆ‡å»ºè­°

### **æ ¸å¿ƒç™¼ç¾**

1. **è¨­è¨ˆæ˜¯åˆç†çš„**: ç•¶å‰çš„æƒ°æ€§å°å…¥æ©Ÿåˆ¶æ˜¯æœ‰æ„è¨­è¨ˆï¼Œç¬¦åˆæ€§èƒ½å„ªåŒ–åŸå‰‡
2. **æ‰‹å‹•å°å…¥ä¸å¯ç§»é™¤**: `figures/__init__.py` çš„æ‰‹å‹•å°å…¥æ˜¯è£é£¾å™¨è¨»å†Šæ¨¡å¼çš„å¿…è¦éƒ¨åˆ†
3. **èˆ‡ generators çš„å·®ç•°æœ‰ç†**: generators éœ€è¦åœ¨ UI ä¸­é¡¯ç¤ºï¼Œfigures åªåœ¨ PDF ç”Ÿæˆæ™‚ä½¿ç”¨

### **æ¨è–¦æ–¹æ¡ˆ**

**æ¡ç”¨æ–¹æ¡ˆ A: ä¿æŒç¾ç‹€ + å®Œå–„æ–‡æª”**

ç†ç”±:
- âœ… ç•¶å‰è¨­è¨ˆæ€§èƒ½å„ªç§€
- âœ… æ¶æ§‹è§£è€¦è‰¯å¥½
- âœ… åªéœ€æ”¹å–„æ–‡æª”èªªæ˜
- âœ… é¿å…éåº¦å·¥ç¨‹åŒ–

### **å…·é«”è¡Œå‹•é …ç›®**

1. **æ–‡æª”æ”¹å–„** (å„ªå…ˆ)
   - åœ¨ `figures/__init__.py` é ‚éƒ¨æ·»åŠ æƒ°æ€§å°å…¥èªªæ˜
   - åœ¨ `CLAUDE.md` ä¸­è¨˜éŒ„æ­¤è¨­è¨ˆæ±ºç­–
   - åœ¨ `docs/workflow.md` ä¸­èªªæ˜å°å…¥æ™‚æ©Ÿ

2. **å¯é¸æ”¹å–„**
   - æ·»åŠ  `--check-figures` å‘½ä»¤è¡Œé¸é …é€²è¡Œå•Ÿå‹•æª¢æŸ¥
   - åœ¨æ—¥èªŒä¸­è¨˜éŒ„ figures é¦–æ¬¡å°å…¥æ™‚æ©Ÿ
   - è€ƒæ…®æ·»åŠ å°å…¥æ™‚é–“çš„æ€§èƒ½ç›£æ§

3. **ä¸å»ºè­°çš„è¡Œå‹•**
   - âŒ ç§»é™¤ `figures/__init__.py` çš„æ‰‹å‹•å°å…¥
   - âŒ åœ¨ `main.py` ä¸­å¼·åˆ¶å°å…¥ figures
   - âŒ æ”¹è®Šç•¶å‰çš„æƒ°æ€§å°å…¥æ©Ÿåˆ¶

---

## ğŸ“š ç›¸é—œæª”æ¡ˆ

- [figures/__init__.py](../figures/__init__.py) - åœ–å½¢ç”Ÿæˆå™¨è¨»å†Šç³»çµ±
- [generators/__init__.py](../generators/__init__.py) - é¡Œç›®ç”Ÿæˆå™¨è‡ªå‹•å°å…¥
- [utils/rendering/figure_renderer.py](../utils/rendering/figure_renderer.py) - åœ–å½¢æ¸²æŸ“å™¨ (è§¸ç™¼ figures å°å…¥)
- [main.py](../main.py) - æ‡‰ç”¨ç¨‹å¼å…¥å£

---

**èª¿æŸ¥å®Œæˆæ—¥æœŸ**: 2025-10-11
**å»ºè­°æ±ºç­–æ™‚é–“**: èˆ‡ç”¨æˆ¶è¨è«–å¾Œç¢ºå®šæ–¹æ¡ˆ
