# AI 開發指南改善計畫

> **計畫類型**: 文檔修正與擴充
> **日期**: 2025-10-02
> **狀態**: 研擬中
> **目標**: 根據三角方程式生成器開發經驗，改善 AI 開發指南

---

## 📋 問題來源

### **實際開發案例**
在三角方程式生成器開發過程中，AI 在不審閱計畫的情況下直接實作，發現了多個指南缺失的重要資訊。

**開發流程**：
1. ✅ 用戶要求「完全重寫」而非「重構」- AI 正確理解
2. ✅ 生成詳細計畫文檔 - 包含架構設計和配置規劃
3. ✅ 用戶明確授權「開始實施」- 遵守代碼修改規範
4. ⚠️ **AI 未審閱計畫直接實作** - 模擬真實使用情境
5. ❌ **遺漏配置系統關鍵步驟** - 指南未涵蓋

---

## 🔍 發現的問題清單

### **問題 1: 配置系統完全缺失**

#### **現象**
- AI 實作了完整的生成器（545行）
- 實作了 `__init__` 配置讀取
- 實作了所有核心方法
- ✅ 功能測試通過
- ❌ **但 UI 無法顯示配置選項**

#### **根本原因**
指南完全沒有提到 `get_config_schema()` 方法：
- 核心 4 步驟中沒有
- 抽象結構範例中沒有
- 開發檢查清單中沒有

#### **嚴重性評估**
- 🔴 **高**: 配置系統是生成器的核心功能之一
- 🔴 **高**: 沒有配置，教師無法調整題目參數
- 🟡 **中**: 測試可以通過，但實際使用會失敗

---

### **問題 2: difficulty 配置誤導**

#### **現象**
用戶在討論過程中指出：
> "題目難度目前是沒有實現的，和配置是兩件事，在 option 實現通解和限定範圍這兩種就行"

#### **指南中的誤導內容**
```python
# L233-236（典範生成器導讀）
def __init__(self, options=None):
    options = options or {}
    self.functions = options.get("functions", ["sin", "cos", "tan"])
    self.difficulty = options.get("difficulty", "MEDIUM")  # ❌ 誤導
    # 無需 Pydantic，簡單直接
```

#### **問題分析**
- `difficulty` 是生成器的**屬性**，不是**配置選項**
- `difficulty` 應該由 `get_difficulty()` 方法返回
- `options` 應該只包含**教師可調整的參數**（如題型、單位、範圍）

#### **嚴重性評估**
- 🟡 **中**: 不會導致錯誤，但概念混淆
- 🟡 **中**: 用戶需要額外糾正，增加溝通成本

---

### **問題 3: 配置選項設計指導不足**

#### **現象**
在設計 `functions` 配置時，AI 的設計路徑：
1. 初始設計：`self.functions = options.get("functions", ["sin", "cos", "tan"])`
2. 發現問題：UI 需要 select 控件，不能是列表
3. 補充實作：新增 `_parse_functions_option()` 映射方法
4. 補充配置：新增 `get_config_schema()` 完整定義

#### **問題分析**
指南沒有說明：
- 配置選項的 **UI 友善性**要求
- select 控件比 checkbox 組合更適合多選一的場景
- 需要將 UI 選項映射為內部資料結構

#### **嚴重性評估**
- 🟢 **低**: AI 最終完成了正確實作
- 🟡 **中**: 但多走了彎路，效率降低

---

### **問題 4: 抽象結構示例代碼過度抽象**

#### **現象**
指南 L312-385 提供的抽象結構範例：
```python
# [3] 參數生成/選取
# ⚠️ 以下是常見模式範例，需根據你的題型調整，不要直接複製！

# 模式1：從預建清單選取（參考 InverseTrigonometricFunctionGenerator）
angle = random.choice(self.special_angles)  # 你需在 __init__ 建立 self.special_angles = [0, 30, 45, ...]

# 模式2：直接隨機整數（適合簡單計算題）
coefficient = random.randint(1, 10)  # 直接指定合理範圍

# 模式3：從預篩選組合選取（參考 DoubleRadicalSimplificationGenerator）
# a, b = random.choice(self.valid_combinations)  # 你需在 __init__ 呼叫 _build_valid_combinations()
```

#### **問題分析**
- ✅ 提供了三種模式，很有幫助
- ❌ 但註解掉的代碼讓 AI 不確定是否該使用
- ❌ 使用 `value1, value2` 等無意義變數名
- ❌ 警告「不要直接複製」但沒說如何調整

#### **嚴重性評估**
- 🟢 **低**: AI 還是能理解和實作
- 🟡 **中**: 但示例代碼的指導性降低

---

### **問題 5: 缺少配置系統專門章節**

#### **現象**
配置系統資訊分散在多個地方：
- Q8 提到「需要哪些配置」（L161-175）
- 抽象結構中有簡單的 `options.get()` 示例（L337）
- 但沒有專門章節講解配置系統

#### **問題分析**
缺少的關鍵資訊：
- ❌ `get_config_schema()` 方法的存在
- ❌ 配置 Schema 規範的連結
- ❌ UI 配置控件類型（select, number_input, checkbox, percentage_group）
- ❌ 配置選項設計的最佳實踐

#### **嚴重性評估**
- 🔴 **高**: 配置系統是生成器開發的核心部分
- 🔴 **高**: 完全遺漏會導致功能不完整

---

## 🎯 改善目標

### **核心目標**
1. **完整性**: 涵蓋生成器開發的**所有必要步驟**
2. **優先級**: 區分「必需」和「可選」的步驟
3. **實用性**: 提供可直接使用的代碼範例
4. **準確性**: 避免誤導性的內容

### **次要目標**
- 保持簡潔：不過度增加篇幅
- 保持結構：維持現有的章節組織
- 保持風格：維持對話式和教學式的語氣

---

## 📝 改善方案

### **方案 A: 核心步驟擴充（推薦）**

#### **修改位置**: L11-15（核心 4 步驟）

**現有內容**:
```markdown
### 核心 4 步驟
1. **繼承基類**: `class YourGenerator(QuestionGenerator)`
2. **實作方法**: `_generate_core_question()` 返回標準 dict
3. **配置讀取**: 用 `options.get(key, default)` 簡潔處理
4. **LaTeX 格式**: 所有數學符號用 LaTeX（`^\\circ` 不是 `°`）
```

**改善後**:
```markdown
### 核心 5 步驟（按實作順序）
1. **繼承基類**: `class YourGenerator(QuestionGenerator)`
2. **配置系統**: 實作 `get_config_schema()` 定義可配置選項（必需，若生成器需要配置）
3. **實作核心邏輯**: `_generate_core_question()` 返回標準 dict
4. **配置讀取**: 用 `options.get(key, default)` 簡潔處理
5. **LaTeX 格式**: 所有數學符號用 LaTeX（`^\\circ` 不是 `°`）

**重要提醒**：
- ✅ 如果生成器有配置需求，必須實作 `get_config_schema()`
- ✅ 否則 UI 無法顯示配置選項
- ✅ 詳見「配置系統開發」章節
```

---

### **方案 B: 新增配置系統專章**

#### **插入位置**: L158 之後（在「階段 3: 配置與圖形」之前）

**新增章節**:
```markdown
---

## 🔧 **配置系統開發**（必讀）

### **為什麼需要配置系統？**
配置系統讓教師可以調整生成器的行為，而無需修改代碼。
例如：選擇題型、調整數值範圍、開啟/關閉特定功能。

### **配置系統的兩個關鍵部分**

#### **1. 定義配置項：`get_config_schema()`（UI層）**

這是一個**類方法**，告訴 UI 系統「有哪些可配置的選項」。

**格式規範**：
```python
@classmethod
def get_config_schema(cls) -> Dict[str, Dict[str, Any]]:
    """配置描述，供 UI 動態生成配置介面"""
    return {
        "config_key": {
            "type": "select",           # 控件類型
            "label": "顯示標籤",        # UI 顯示的文字
            "default": "預設值",        # 預設選項
            "options": ["選項1", "選項2"],  # 可選值（select 必需）
            "description": "詳細說明"   # 可選的提示文字
        }
    }
```

**支援的控件類型**：
- `select`: 下拉選擇框（單選）
- `number_input`: 數字輸入框
- `checkbox`: 勾選框（布林值）
- `percentage_group`: 百分比分配（進階）

**完整範例**：
```python
@classmethod
def get_config_schema(cls):
    return {
        "unit_mode": {
            "type": "select",
            "label": "答案單位",
            "default": "degree",
            "options": ["degree", "radian", "mixed"],
            "description": "degree=角度, radian=弧度, mixed=隨機選擇"
        },
        "max_value": {
            "type": "number_input",
            "label": "數值上限",
            "default": 25,
            "min": 5,
            "max": 100
        },
        "allow_negative": {
            "type": "checkbox",
            "label": "允許負數",
            "default": False
        }
    }
```

**詳細規範**: 參考 [`配置Schema規範.md`](配置Schema規範.md)

---

#### **2. 讀取配置值：`__init__()` 中的 `options.get()`（生成器層）**

在 `__init__` 中使用 `options.get(key, default)` 讀取配置。

**基本模式**：
```python
def __init__(self, options=None):
    super().__init__(options)
    options = options or {}

    # 直接讀取簡單配置
    self.unit_mode = options.get("unit_mode", "degree")
    self.max_value = options.get("max_value", 25)
    self.allow_negative = options.get("allow_negative", False)
```

**進階模式**（需要轉換）：
```python
def __init__(self, options=None):
    super().__init__(options)
    options = options or {}

    # UI 選項需要映射為內部資料結構
    functions_option = options.get("functions", "all")
    self.functions = self._parse_functions_option(functions_option)

def _parse_functions_option(self, option: str) -> List[str]:
    """將 UI 選項映射為函數列表"""
    mapping = {
        "all": ["sin", "cos", "tan"],
        "sin_cos": ["sin", "cos"],
        "tan": ["tan"]
    }
    return mapping.get(option, ["sin", "cos", "tan"])
```

---

### **配置系統開發檢查清單**

生成器需要配置時：
- [ ] 實作 `get_config_schema()` 類方法
- [ ] 每個配置項包含必需欄位：`type`, `label`, `default`
- [ ] `select` 類型必須提供 `options` 列表
- [ ] `default` 值必須在 `options` 範圍內
- [ ] 在 `__init__` 中用 `options.get(key, default)` 讀取
- [ ] 如需轉換，實作私有方法處理映射邏輯

生成器不需要配置時：
- [ ] 不實作 `get_config_schema()`（或返回空字典）
- [ ] `__init__` 仍然接受 `options` 參數（繼承要求）

---

### **常見錯誤**

❌ **忘記實作 `get_config_schema()`**
- 結果：UI 無法顯示配置選項
- 修正：新增類方法並定義配置項

❌ **將 `difficulty` 放入 options**
- 錯誤：`self.difficulty = options.get("difficulty", "MEDIUM")`
- 正確：`difficulty` 是生成器屬性，由 `get_difficulty()` 返回

❌ **預設值不在選項列表中**
- 錯誤：`default: "easy"` 但 `options: ["normal", "hard"]`
- 結果：ConfigFactory 驗證失敗

❌ **options 列表過長**
- 不好：`options: ["sin", "cos", "tan", "sin_cos", "sin_tan", "cos_tan", "all"]`
- 更好：`options: ["all", "sin_cos", "sin", "cos", "tan"]`（精簡常用組合）

---
```

---

### **方案 C: 修正誤導內容**

#### **修改位置 1**: L233-240（典範生成器導讀）

**移除誤導行**:
```python
def __init__(self, options=None):
    options = options or {}
    self.functions = options.get("functions", ["sin", "cos", "tan"])
    # self.difficulty = options.get("difficulty", "MEDIUM")  # ❌ 移除此行
```

**新增說明**:
```markdown
**重要提醒**：
- ✅ `options` 只包含**教師可調整的參數**
- ❌ 不要將生成器屬性（如 `difficulty`, `grade`）放入 options
- ✅ 這些屬性應該由對應的 getter 方法返回
```

---

#### **修改位置 2**: L337-338（抽象結構範例）

**改善前**:
```python
# [1] 讀取配置
options = options or {}
self.param1 = options.get('param1', default_value)
self.param2 = options.get('param2', default_value)
```

**改善後**:
```python
# [1] 讀取配置（如果生成器需要配置）
options = options or {}
self.unit_mode = options.get('unit_mode', 'degree')  # 使用具體範例
self.max_value = options.get('max_value', 25)

# 如需要映射，實作輔助方法
functions_option = options.get('functions', 'all')
self.functions = self._parse_functions_option(functions_option)
```

---

### **方案 D: 改善檢查清單**

#### **修改位置**: L485-513（開發檢查清單）

**擴充配置處理部分**:
```markdown
### 配置處理
- [ ] 如生成器需要配置，實作 `get_config_schema()` 類方法
- [ ] 配置項符合 Schema 規範（type, label, default, options）
- [ ] 用 `options.get(key, default)` 讀取配置
- [ ] 所有配置都有合理預設值
- [ ] 不將生成器屬性（difficulty, grade）放入 options
- [ ] 參考典範代碼的配置模式
```

---

## 📊 改善優先級

### **P0 - 必須立即修正**（功能性缺陷）
1. ✅ 新增配置系統專章（方案 B）
2. ✅ 擴充核心步驟（方案 A）

### **P1 - 重要但可分階段**（誤導性內容）
3. ✅ 移除 difficulty 誤導（方案 C）
4. ✅ 改善檢查清單（方案 D）

### **P2 - 改善體驗**（優化建議）
5. 🔵 改善抽象結構範例（方案 C 位置 2）
6. 🔵 新增更多配置系統範例

---

## 🎯 實施計畫

### **階段 1: 核心內容補充**（P0）

**目標**: 讓 AI 不會再遺漏配置系統

**任務**:
1. 在「核心 4 步驟」擴充為「核心 5 步驟」
2. 新增「配置系統開發」完整章節
3. 插入位置：L158 之後

**預期效果**:
- AI 在開發時會記得實作 `get_config_schema()`
- AI 知道配置系統的兩個關鍵部分
- AI 能查閱配置 Schema 規範

---

### **階段 2: 誤導內容修正**（P1）

**目標**: 避免概念混淆

**任務**:
1. 移除典範導讀中的 `difficulty` 範例
2. 新增「不要將屬性放入 options」的明確說明
3. 改善抽象結構中的配置讀取範例

**預期效果**:
- AI 不會將 `difficulty` 放入 options
- AI 理解 options 只包含「可配置參數」

---

### **階段 3: 檢查清單完善**（P1）

**目標**: 確保開發過程完整

**任務**:
1. 擴充「配置處理」檢查項目
2. 新增「配置系統驗證」檢查項目

**預期效果**:
- AI 在完成開發後會自我檢查配置系統
- 減少遺漏的機會

---

## ✅ 驗證方式

### **驗證標準**
改善後的指南應該能讓 AI：
1. ✅ 在實作時記得 `get_config_schema()`
2. ✅ 正確設計配置選項（UI 友善）
3. ✅ 正確實作配置讀取邏輯
4. ✅ 不將生成器屬性放入 options
5. ✅ 完成開發後有完整的配置系統

### **驗證方法**
- **模擬測試**: 讓 AI 根據新指南開發一個生成器
- **檢查項目**: 是否自動實作 `get_config_schema()`
- **功能測試**: UI 能否正確顯示配置選項

---

## 📚 參考資料

### **本次開發案例**
- `generators/trigonometry/trigonometric_equation.py` - 三角方程式生成器
- `docs/20251002_三角方程式生成器完全重寫計畫_研擬中.md` - 開發計畫

### **相關規範文檔**
- `docs/配置Schema規範.md` - 配置系統詳細規範
- `docs/生成器開發指南.md` - 人類開發者指南

### **典範生成器**
- `generators/algebra/double_radical_simplification.py` - number_input 範例
- `generators/trigonometry/TrigAngleConversionGenerator.py` - percentage_group 範例
- `generators/trigonometry/TrigonometricFunctionGenerator.py` - select 範例

---

## 🚀 後續行動

### **待確認事項**
1. ⏳ 用戶審閱和批准改善方案
2. ⏳ 確認改善優先級和範圍
3. ⏳ 決定是否一次完成所有改善或分階段

### **實施階段**（待授權）
1. 修改 `docs/AI開發指南_生成器快速上手.md`
2. 新增配置系統章節
3. 修正誤導內容
4. 擴充檢查清單
5. 驗證改善效果

---

**計畫狀態**: 研擬完成，等待用戶確認和授權實施


 "這樣很清楚了，另外我想加上配置，單位的部份：可以選角度、弧度、或混合。題目類型我想增加為寫出通解，或者限定定義域的
  範兩種。就是像sin(x)=0.5，請問在[-180,180]範圍內的解？定義域範圍用正負180和0到360兩種好了。你覺得這想法如何？"前面是
  當時溝通的原文，結果不知為何多出了sin cos tan sin+cos分離的選項，我應該完全沒有要求到這個，是哪來的幻覺？另一個部份
  是「題型想要通解或限定」「限定要兩種範圍」當時我心中想的是「選了限定後，兩種範圍隨機出現」而你作的是「選了限定後，再
  讓使用者從兩種範圍選一」這確實是不太好取得共識的位置。