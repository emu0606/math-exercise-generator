# 圖形生成器開發指南

## 概述

### 圖形生成器的角色
圖形生成器是數學測驗系統的圖形組件，負責為數學題目生成對應的 TikZ 圖形代碼。當題目生成器產生一道幾何題、三角函數題或其他需要圖形輔助的數學問題時，圖形生成器提供參數化的視覺化支援。

### 與題目生成器的關係
- **參數化配合**：圖形參數與題目數值同步變化
- **格式統一**：所有圖形輸出標準化的 TikZ 代碼
- **變體支援**：同一圖形可產生題目版和解答版

### 核心價值
- **一致性**：統一的視覺風格和代碼規範
- **參數化**：動態調整圖形內容配合不同題目
- **自動化**：減少手工繪圖，提升生成效率

## 導入與註冊機制

### 惰性導入設計

figures 模組採用**惰性導入 (Lazy Import)** 機制：

- **啟動時**: UI 啟動時不會導入 figures 模組
- **首次使用**: 在 PDF 生成階段由 `FigureRenderer` 觸發導入
- **性能優化**: 減少 UI 啟動時間約 15%，節省 5-10 MB 記憶體

### 裝飾器註冊原理

`@register_figure_generator` 裝飾器的執行時機：

```python
@register_figure_generator
class CircleGenerator(FigureGenerator):
    # ⭐ 裝飾器只有在此類被導入時才執行
    pass
```

**關鍵點**:
1. 裝飾器在類定義時執行（模組導入時）
2. 未被導入的類不會被註冊
3. 這就是為什麼需要 `__init__.py` 中的手動導入

### figures/__init__.py 的關鍵角色

`figures/__init__.py` 底部的手動導入代碼是**註冊系統的核心**：

```python
# figures/__init__.py (底部)
# ⚠️ 這些手動導入是必要的，不可移除

# 基礎圖形生成器
from .unit_circle import UnitCircleGenerator
from .circle import CircleGenerator
from .coordinate_system import CoordinateSystemGenerator
# ... 其他導入
```

**為什麼需要手動導入？**

1. **觸發裝飾器**: 只有導入類，裝飾器才會執行
2. **建立註冊表**: 將所有生成器加入 `_figure_generators` 字典
3. **提供統一接口**: 讓 `get_figure_generator()` 能找到生成器

### 驗證註冊是否成功

開發完成後，驗證圖形生成器是否正確註冊：

```python
# 驗證腳本
import figures

# 檢查所有已註冊的圖形類型
registered = figures.get_registered_figure_types()
print(f"已註冊圖形數量: {len(registered)}")

# 驗證特定生成器
try:
    MyGen = figures.get_figure_generator('my_figure_type')
    print(f"✅ 成功找到: {MyGen.__name__}")
except ValueError as e:
    print(f"❌ 註冊失敗: {e}")
```

## 核心概念

### 題目與解答變體
圖形生成器的一個關鍵特色是支援兩種顯示變體：

#### Question 變體（題目圖）
- **目的**：提供足夠資訊讓學生理解題目，但不洩漏答案
- **特點**：最少必要資訊，隱藏解答相關的標註
- **例子**：單位圓只顯示圓周和角度標記，不顯示座標值

#### Explanation 變體（解答圖）
- **目的**：提供完整資訊輔助說明解題過程
- **特點**：顯示所有相關數值、標註、輔助線等
- **例子**：單位圓顯示完整座標、三角函數值、投影線等

```python
# 變體使用範例
params = {
    'angle': 60,
    'variant': 'question'    # 或 'explanation'
}
```

### 參數模型系統
使用 Pydantic 建立型別安全的參數驗證：

```python
from figures.params.base import BaseFigureParams
from pydantic import Field

class MyFigureParams(BaseFigureParams):
    radius: float = Field(default=1.0, gt=0, description="圓的半徑")
    center_x: float = Field(default=0.0, description="圓心 x 座標")
    center_y: float = Field(default=0.0, description="圓心 y 座標")
```

### 註冊機制

#### 使用裝飾器註冊

```python
from figures import register_figure_generator
from figures.base import FigureGenerator

@register_figure_generator
class MyFigureGenerator(FigureGenerator):
    @classmethod
    def get_name(cls) -> str:
        return 'my_figure_type'  # ⚠️ 必須是唯一的類型名稱
```

#### 註冊流程說明

1. **定義生成器類**: 繼承 `FigureGenerator`
2. **添加裝飾器**: 使用 `@register_figure_generator`
3. **實現 get_name()**: 返回唯一的圖形類型標識符
4. **添加到 __init__.py**: ⚠️ **關鍵步驟** - 在 `figures/__init__.py` 底部添加手動導入

```python
# figures/__init__.py (底部新增)
from .my_figure import MyFigureGenerator  # ⚠️ 必須手動添加此行
```

> ⚠️ **重要**: figures/__init__.py 中的手動導入代碼
>
> `figures/__init__.py` 底部的所有手動導入語句（如 `from .circle import CircleGenerator`）是註冊系統的核心機制，**絕對不可移除**。
>
> - 這些導入觸發 `@register_figure_generator` 裝飾器的執行
> - 移除任何一行會導致對應的圖形生成器無法使用
> - 新增圖形生成器時，必須在此處添加對應的導入語句

## 開發實作

### 參數模型設計

#### 基本結構
所有參數模型都需要繼承 `BaseFigureParams`：

```python
from figures.params.base import BaseFigureParams
from pydantic import Field
from typing import Literal

class CircleParams(BaseFigureParams):
    radius: float = Field(default=1.0, gt=0, description="半徑")
    center_x: float = Field(default=0.0, description="圓心 x 座標")
    center_y: float = Field(default=0.0, description="圓心 y 座標")
    fill: bool = Field(default=False, description="是否填充")
    line_color: str = Field(default='black', description="線條顏色")
```

#### 變體欄位處理
`BaseFigureParams` 已包含 `variant` 欄位，無需重複定義：

```python
# 在 generate_tikz 方法中使用
def generate_tikz(self, params: Dict[str, Any]) -> str:
    validated_params = CircleParams(**params)

    if validated_params.variant == 'explanation':
        # 顯示額外的解答資訊
        pass
    else:
        # 顯示基本的題目資訊
        pass
```

### 生成器實作

#### 基本結構
```python
from figures.base import FigureGenerator
from utils import get_logger
from typing import Dict, Any

@register_figure_generator
class CircleGenerator(FigureGenerator):

    def __init__(self):
        super().__init__()
        self.logger = get_logger(self.__class__.__name__)

    @classmethod
    def get_name(cls) -> str:
        return 'circle'

    def generate_tikz(self, params: Dict[str, Any]) -> str:
        # 參數驗證
        validated_params = CircleParams(**params)

        # 生成 TikZ 代碼
        tikz_code = self._build_circle_tikz(validated_params)

        return tikz_code
```

#### 錯誤處理
```python
from pydantic import ValidationError

def generate_tikz(self, params: Dict[str, Any]) -> str:
    try:
        validated_params = CircleParams(**params)
    except ValidationError as e:
        self.logger.error(f"參數驗證失敗: {str(e)}")
        raise ValueError(f"圓形參數驗證失敗: {str(e)}")

    # 繼續處理...
```

### 數學計算支援

#### 使用 utils.geometry 模組
系統提供完整的幾何計算工具，避免重複實作基礎數學運算：

```python
from utils import Point, Triangle, distance, angle_between
import utils.geometry as geom

# 點運算
point_a = Point(0, 0)
point_b = Point(3, 4)
dist = distance(point_a, point_b)  # 返回 5.0

# 三角形計算
triangle = Triangle(Point(0, 0), Point(3, 0), Point(1.5, 2.6))
area = triangle.area()  # 計算面積
perimeter = triangle.perimeter()  # 計算周長
side_lengths = triangle.side_lengths()  # 獲取三邊長度

# 角度計算
angle = angle_at_vertex(point_a, point_b, Point(5, 0))
```

#### 常用計算功能
- **點運算**：座標變換、距離計算、角度運算
- **線段運算**：長度、斜率、交點計算
- **圓形運算**：圓周上的點、切線、弦長計算
- **三角形運算**：面積、周長、邊長、重心計算

## TikZ 生成要點

### 基本結構
```python
def _build_circle_tikz(self, params: CircleParams) -> str:
    tikz_lines = []

    # 圓形主體
    circle_cmd = f"\\draw[color={params.line_color}] ({params.center_x},{params.center_y}) circle ({params.radius});"
    tikz_lines.append(circle_cmd)

    # 根據變體添加額外元素
    if params.variant == 'explanation':
        # 添加中心點
        center_cmd = f"\\fill ({params.center_x},{params.center_y}) circle (0.05);"
        tikz_lines.append(center_cmd)

    return '\n'.join(tikz_lines)
```

### 座標系統
- TikZ 使用笛卡爾座標系
- 單位通常為公分 (cm)
- 座標格式：`(x,y)`

### 常用圖形元素
```python
# 點
"\\fill (x,y) circle (0.05);"

# 線段
"\\draw (x1,y1) -- (x2,y2);"

# 圓
"\\draw (center_x,center_y) circle (radius);"

# 弧線
"\\draw (center_x,center_y) ++(start_angle:radius) arc (start_angle:end_angle:radius);"

# 標籤
"\\node at (x,y) {text};"
```

### 顏色和樣式
```python
# 顏色
"\\draw[color=red] ..."
"\\draw[blue] ..."

# 線條樣式
"\\draw[dashed] ..."
"\\draw[thick] ..."
"\\draw[->] ..."  # 箭頭
```

## 最佳實踐

### 參數設計原則
1. **合理預設值**：讓生成器在最少參數下也能正常工作
2. **清楚命名**：參數名稱應該一目了然
3. **適當驗證**：使用 Pydantic 的驗證功能防止無效輸入
4. **文檔完整**：每個參數都要有 description

### 代碼組織
1. **方法分割**：將複雜的 TikZ 生成邏輯拆分為私有方法
2. **常數定義**：將重複使用的數值定義為類別常數
3. **日誌使用**：在關鍵步驟記錄日誌，便於除錯

### 測試驗證

#### 1. 註冊驗證測試 (優先執行)

```python
def test_figure_registration():
    """驗證圖形生成器是否正確註冊"""
    import figures

    # 檢查是否在註冊表中
    registered_types = figures.get_registered_figure_types()
    assert 'my_figure' in registered_types, "圖形類型未註冊"

    # 檢查是否能正確獲取
    generator_class = figures.get_figure_generator('my_figure')
    assert generator_class is not None, "無法獲取生成器類"
    assert generator_class.__name__ == 'MyFigureGenerator'

    print("✅ 註冊驗證通過")
```

#### 2. 基本功能測試

```python
def test_circle_generation():
    """測試基本的圖形生成功能"""
    import figures

    # 獲取生成器
    CircleGen = figures.get_figure_generator('circle')
    generator = CircleGen()

    # 測試生成
    params = {'radius': 2.0, 'center_x': 1.0, 'center_y': 1.0}
    result = generator.generate_tikz(params)

    # 驗證輸出
    assert 'circle (2.0)' in result
    assert isinstance(result, str)
    assert len(result) > 0

    print("✅ 基本功能測試通過")
```

#### 3. 變體測試

```python
def test_circle_variants():
    """測試 question/explanation 變體"""
    import figures

    generator = figures.get_figure_generator('circle')()

    # 測試題目變體
    question_params = {'radius': 1.0, 'variant': 'question'}
    question_result = generator.generate_tikz(question_params)

    # 測試解答變體
    explanation_params = {'radius': 1.0, 'variant': 'explanation'}
    explanation_result = generator.generate_tikz(explanation_params)

    # 解答圖應該有更多元素
    assert len(explanation_result) >= len(question_result)

    print("✅ 變體測試通過")
```

#### 4. 參數驗證測試

```python
def test_parameter_validation():
    """測試參數驗證功能"""
    import figures
    from pydantic import ValidationError

    generator = figures.get_figure_generator('circle')()

    # 測試無效參數
    try:
        invalid_params = {'radius': -1.0}  # 負數半徑
        generator.generate_tikz(invalid_params)
        assert False, "應該拋出驗證錯誤"
    except (ValidationError, ValueError):
        print("✅ 參數驗證測試通過")
```

## 參考資源

### 可用基礎圖形
詳細的圖形類型和參數說明請參考 [`available_figures.md`](available_figures.md)。

常用的基礎圖形包括：
- **點**：基本座標點
- **線段**：直線和曲線
- **圓形**：圓周和填充圓
- **多邊形**：三角形、矩形等
- **弧線**：角度標記和扇形
- **標籤**：文字說明

### 故障排除

#### 註冊相關錯誤

**錯誤 1: ValueError: 找不到類型為 'xxx' 的圖形生成器**

```python
# 錯誤訊息
ValueError: 找不到類型為 'my_figure' 的圖形生成器
```

**原因與解決方法**:

1. **忘記添加到 __init__.py**
   ```python
   # 檢查 figures/__init__.py 底部是否有
   from .my_figure import MyFigureGenerator

   # 如果沒有，手動添加此行
   ```

2. **get_name() 返回值不匹配**
   ```python
   # 檢查生成器的 get_name() 方法
   @classmethod
   def get_name(cls) -> str:
       return 'my_figure'  # 必須與使用時的名稱完全一致
   ```

3. **驗證是否註冊成功**
   ```python
   import figures
   print(list(figures.get_registered_figure_types().keys()))
   # 檢查輸出列表中是否包含你的圖形類型
   ```

**錯誤 2: 圖形生成器數量不符預期**

```python
# 檢查註冊數量
import figures
print(f"已註冊圖形: {len(figures.get_registered_figure_types())}")
# 預期: 13 (或更多，如果你新增了圖形)
```

**原因**: 可能有手動導入被意外移除或註釋掉

**解決方法**: 檢查 `figures/__init__.py` 底部，確保所有圖形生成器都有對應的導入語句

**錯誤 3: 裝飾器沒有執行**

**症狀**: 定義了 `@register_figure_generator`，但圖形仍然找不到

**原因**: 類所在的模組從未被導入

**解決方法**:
```python
# 1. 確認裝飾器正確使用
@register_figure_generator  # ⚠️ 不要忘記這個裝飾器
class MyFigureGenerator(FigureGenerator):
    pass

# 2. 確認添加到 __init__.py
# figures/__init__.py
from .my_figure import MyFigureGenerator  # ⚠️ 必須有此行

# 3. 測試導入
# python -c "import figures; print('my_figure' in figures.get_registered_figure_types())"
```

#### 其他常見錯誤

1. **參數驗證失敗**：檢查參數型別和範圍
2. **TikZ 語法錯誤**：確認括號和分號的正確使用
3. **座標超出範圍**：檢查圖形是否在合理的座標範圍內

#### 除錯技巧

1. **使用日誌**：在關鍵步驟輸出中間結果
2. **分段測試**：先測試基本圖形，再添加複雜元素
3. **驗證 TikZ**：將生成的代碼放入 LaTeX 文檔中編譯測試

### 進階主題

#### 複合圖形生成器
對於複雜圖形，可以使用 `CompositeFigureGenerator` 組合多個基礎圖形：

```python
# 參考 figures/predefined/standard_unit_circle.py 的實作
composite_params = CompositeParams(
    sub_figures=[
        SubFigureParams(id="circle", type="circle", params={...}),
        SubFigureParams(id="point", type="point", params={...}),
    ]
)
```

#### 自訂 TikZ 樣式
可以定義專用的 TikZ 樣式來保持視覺一致性：

```python
tikz_styles = """
\\tikzset{
    math_point/.style={fill=red, circle, inner sep=1pt},
    math_line/.style={thick, blue},
}
"""
```

## 開發完成後的文檔更新

### 📝 重要提醒：更新圖形類型文檔

當你完成新圖形生成器的開發後，**務必**更新系統文檔：

#### 1. 更新 available_figures.md
在 [`docs/available_figures.md`](available_figures.md) 中添加你的新圖形類型：

```markdown
### X. 你的圖形名稱 (`your_figure_type`)

簡短描述你的圖形用途和特色。

**參數**：
```python
{
    'variant': 'question',  # 或 'explanation'
    'your_param_1': 'default_value',
    'your_param_2': 42,
    # ... 其他參數
}
```

**示例**：
```python
'figure_data_question': {
    'type': 'your_figure_type',
    'params': {
        'variant': 'question',
        'your_param_1': 'example_value'
    },
    'options': {
        'scale': 1.0  # 可選
    }
}
```
```

#### 2. 文檔更新檢查清單
- [ ] 添加圖形類型到 `available_figures.md`
- [ ] 提供完整的參數說明和預設值
- [ ] 包含實用的使用範例
- [ ] 說明 question/explanation 變體的差異
- [ ] 如果是複合圖形，說明子圖形組成

#### 3. 測試文檔範例
確保你在文檔中提供的範例代碼能夠正常運行：

```python
# 測試你的文檔範例
from figures import get_figure_generator

generator_class = get_figure_generator('your_figure_type')
generator = generator_class()
result = generator.generate_tikz({
    'variant': 'question',
    # 使用文檔中的參數範例
})
print("✅ 文檔範例測試通過")
```

這樣確保其他開發者和使用者能夠：
1. 快速發現你的新圖形類型
2. 理解如何正確使用參數
3. 參考實際可運行的程式碼範例