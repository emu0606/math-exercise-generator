# 生成器配置UI整合工作計畫

> **專案**: 數學測驗生成器UI配置系統
> **制定日期**: 2025-09-20
> **狀態**: 📋 **初步草稿** - 基於UI清理完成後的下階段工作
> **範圍**: 生成器配置與UI整合的設計方案

## 🎯 **專案背景**

### **當前狀況**
- ✅ **UI清理已完成** (2025-09-19): 失敗重構代碼已清除，系統穩定運行
- ✅ **三角函數生成器就緒**: TrigonometricFunctionGenerator支援options配置
- ⚠️ **配置傳遞缺失**: UI無法將配置傳遞給生成器

### **核心需求**
基於`docs/20250919_生成器難度參數設計心得與建議.md`的洞察：
- **概念分離**: 「PDF難度標籤」vs「生成器配置選項」
- **參數重新命名**: `difficulty` → `function_scope`、`angle_mode`
- **UI配置支援**: 需要將用戶選擇的配置傳遞給生成器

## 🚨 **設計原則與經驗洞察**

### **避免靜態配置檔案膨脹**
**經驗教訓**: 不使用巨大的`GENERATOR_CONFIGS`字典
```python
# ❌ 避免這種做法 - 會愈來愈肥愈來愈難管
GENERATOR_CONFIGS = {
    "三角函數值計算": {...},
    "反三角函數計算": {...},
    # ... 愈來愈多
}
```

### **生成器自描述架構**
**推薦方案**: 讓每個生成器自己定義配置需求
```python
# ✅ 生成器自描述配置
class TrigonometricFunctionGenerator(QuestionGenerator):
    @classmethod
    def get_config_schema(cls):
        """生成器自己描述需要的配置"""
        return {
            "function_scope": {
                "type": "select",
                "options": ["basic", "extended"],
                "default": "basic",
                "label": "函數範圍",
                "description": "basic(sin,cos,tan) vs extended(+cot,sec,csc)"
            },
            "angle_mode": {
                "type": "select",
                "options": ["degree", "radian", "mixed"],
                "default": "degree",
                "label": "角度模式",
                "description": "度數/弧度/混合顯示"
            }
        }
```

### **概念澄清與命名規範**
基於心得文檔的重要發現：
- **PDF難度標籤**: `get_difficulty() -> "MEDIUM"` (固定值)
- **配置選項**: `function_scope`, `angle_mode` (動態值)
- **避免混淆命名**: 不使用`difficulty`作為配置參數名

## 📋 **技術方案設計**

### **階段1: 數據格式擴展**

#### **1.1 擴展selected_data格式**
```python
# 當前格式
selected_data = [
    {"topic": "三角函數值計算", "count": 5}
]

# 新格式 (向後兼容)
selected_data = [
    {
        "topic": "三角函數值計算",
        "count": 5,
        "config": {  # 新增配置字段
            "function_scope": "extended",
            "angle_mode": "radian"
        }
    }
]
```

#### **1.2 PDF協調器擴展**
```python
# utils/orchestration/pdf_orchestrator.py 修改
def generate_questions_for_topic(topic_data):
    topic = topic_data["topic"]
    count = topic_data["count"]
    config = topic_data.get("config", {})  # 提取配置

    generator_class = registry.get_generator(topic)
    generator = generator_class(config)  # 傳遞配置

    questions = []
    for _ in range(count):
        question = generator.generate_question()
        questions.append(question)

    return questions
```

### **階段2: 生成器自描述系統**

#### **2.1 基礎框架擴展**
```python
# generators/base.py 添加配置描述支援
class QuestionGenerator:
    @classmethod
    def get_config_schema(cls):
        """生成器配置描述 - 子類別可覆寫"""
        return {}  # 預設無配置需求

    @classmethod
    def has_config(cls):
        """檢查生成器是否需要配置"""
        return bool(cls.get_config_schema())
```

#### **2.2 註冊器擴展**
```python
# utils/core/registry.py 添加配置查詢
def get_generator_config_schema(self, topic: str) -> Dict[str, Any]:
    """獲取生成器的配置描述"""
    generator_class = self.get_generator(topic)
    return generator_class.get_config_schema()

def generator_has_config(self, topic: str) -> bool:
    """檢查生成器是否需要配置"""
    generator_class = self.get_generator(topic)
    return generator_class.has_config()
```

### **階段3: UI最小擴展**

#### **3.1 CategoryWidget配置支援**
```python
# ui/category_widget.py 修改
def get_selected_data(self):
    """獲取選擇數據，包含配置資訊"""
    selected_data = []

    for item in self.get_checked_items():
        topic_data = {
            "topic": item.topic,
            "count": item.count
        }

        # 檢查是否有配置需求
        if registry.generator_has_config(item.topic):
            config = self._get_topic_config(item.topic)
            if config:
                topic_data["config"] = config

        selected_data.append(topic_data)

    return selected_data

def _get_topic_config(self, topic: str) -> Dict[str, Any]:
    """獲取主題的配置設定"""
    # 從UI配置儲存中獲取，或使用預設值
    return self.topic_configs.get(topic, {})
```

#### **3.2 配置對話框**
```python
# ui/config_dialog.py (新檔案)
class GeneratorConfigDialog(QDialog):
    """生成器配置對話框"""

    def __init__(self, topic: str, current_config: Dict[str, Any] = None):
        super().__init__()
        self.topic = topic
        self.config_schema = registry.get_generator_config_schema(topic)
        self.current_config = current_config or {}

        self.init_ui()

    def init_ui(self):
        """根據配置描述動態建立UI控件"""
        for param_name, param_info in self.config_schema.items():
            if param_info["type"] == "select":
                self.create_select_widget(param_name, param_info)
            # 其他類型...

    def get_config(self) -> Dict[str, Any]:
        """獲取用戶配置"""
        # 從UI控件收集配置值
        pass
```

## 🚀 **實施計畫**

### **階段1: 後端基礎 (30分鐘)**
1. **擴展PDF協調器**: 支援config字段傳遞
2. **擴展註冊器**: 添加配置查詢方法
3. **擴展基礎框架**: 添加get_config_schema方法

### **階段2: 生成器更新 (20分鐘)**
1. **修改TrigonometricFunctionGenerator**:
   - 添加get_config_schema方法
   - 重新命名difficulty → function_scope
2. **測試配置傳遞**: 確認options正確傳遞

### **階段3: UI擴展 (40分鐘)**
1. **CategoryWidget修改**: 支援配置數據收集
2. **簡單配置對話框**: 為三角函數生成器提供配置UI
3. **整合測試**: 端到端配置傳遞測試

### **階段4: 驗證測試 (10分鐘)**
1. **功能測試**: 配置正確傳遞給生成器
2. **UI測試**: 配置對話框正常工作
3. **向後兼容**: 無配置的生成器仍正常工作

## ⚠️ **風險評估**

### **技術風險 (低)**
- **CategoryWidget修改**: 已知工作的怪物檔案，修改風險低
- **向後兼容**: 新config字段為可選，不影響現有功能
- **測試覆蓋**: 變更範圍明確，容易測試

### **設計風險 (極低)**
- **生成器自描述**: 職責分離清楚，不會互相干擾
- **按需擴展**: 不預設未來需求，避免過度設計
- **概念清晰**: 基於心得文檔的明確原則

### **風險控制**
- **漸進式實施**: 每階段獨立測試
- **最小變更**: 避免大規模修改
- **配置預設值**: 確保無配置時正常工作

## 🎯 **成功標準**

### **功能目標**
- [ ] 三角函數生成器支援function_scope和angle_mode配置
- [ ] UI提供配置選擇界面
- [ ] 配置正確傳遞給生成器
- [ ] PDF生成包含配置後的題目

### **架構目標**
- [ ] 生成器自描述配置系統建立
- [ ] 避免靜態配置檔案膨脹
- [ ] 向後兼容無配置的生成器
- [ ] 為未來生成器配置需求建立基礎

### **品質目標**
- [ ] 代碼清晰易懂
- [ ] 配置命名符合心得文檔原則
- [ ] 系統穩定可靠
- [ ] 易於擴展維護

---

**計畫狀態**: 📋 **初步草稿** - 基於UI清理完成和心得文檔洞察
**核心理念**: 生成器自描述 + 按需擴展 + 概念清晰分離
**下一步**: 評估方案可行性，制定詳細實施步驟
**時間預估**: 總計100分鐘 (後端30分鐘 + 生成器20分鐘 + UI40分鐘 + 測試10分鐘)