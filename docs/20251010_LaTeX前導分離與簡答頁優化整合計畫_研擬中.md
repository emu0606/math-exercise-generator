# 20251010_LaTeX前導分離與簡答頁優化整合計畫_研擬中

## 計畫概述

**目標**：整合兩項重構工作，實現完全獨立的 LaTeX 前導架構 + 智能動態簡答頁格式。

**整合內容**：
1. **LaTeX 前導分離重構** - 三種文件類型完全獨立（零耦合）
2. **簡答頁格式優化** - 四種卡片寬度 + 答案寬度自動計算
3. **色系輪換機制** - 每回內每 5 題換色系，提升對答可讀性
4. **動態顏色系統** - LaTeX 動態顏色切換機制
5. **保留分回邏輯** - 與題目頁、詳解頁題號保持一致

## 動機與價值

### 前導分離的價值
1. **零耦合** - 修改題目頁不影響簡答頁和詳解頁
2. **彈性最大化** - 每種文件可獨立配置字型、頁邊距
3. **風險隔離** - 錯誤不會跨文件傳播

### 簡答頁優化的價值
1. **空間利用** - 短答案不浪費整行（目前固定三欄）
2. **視覺清晰** - 長答案有足夠寬度（目前會突出格子）
3. **對答友善** - 色系輪換幫助快速定位（每回內每 5 題一組）
4. **保持一致** - 題號與題目頁、詳解頁完全對應

## 架構設計

### 完全獨立的前導架構

```
LaTeXStructure
├── get_question_preamble(title)          # 完全獨立 - 題目頁
├── get_answer_preamble(title)            # 完全獨立 - 簡答頁（新格式）
└── get_explanation_preamble(title)       # 完全獨立 - 詳解頁
```

### 簡答頁新格式設計

#### 四種卡片寬度
```latex
\tinyCard{題號}{答案}      % 四欄 (0.23\textwidth) - 單數字、簡單分數
\shortCard{題號}{答案}     % 三欄 (0.305\textwidth) - 簡單三角函數
\mediumCard{題號}{答案}    % 兩欄 (0.47\textwidth) - 根式、帶「或」
\longCard{題號}{答案}      % 單欄 (0.98\textwidth) - 通解、長表達式
```

#### 四色系輪換（基於回內題號）

**關鍵設計**：色系基於**回內題號**輪換，不是全局題號。

```
每回內色系循環：
  回內題 1-5:  色系 1 (藍灰)
  回內題 6-10: 色系 2 (綠)
  回內題 11-15: 色系 3 (紫)
  回內題 16-20: 色系 4 (橙)

換回後色系重置：
  第1回 題1-5: 藍灰
  第2回 題1-5: 藍灰 (重新開始)
  第3回 題1-5: 藍灰 (重新開始)
```

**整合分回功能**：
- ✅ 保留 `\roundtitle{第N回}` 標題
- ✅ 題號使用回內編號（與題目頁、詳解頁一致）
- ✅ 每回內色系獨立循環（1→2→3→4）
- ✅ 換回時自動強制換行和重置

**視覺效果示例**（假設 10 題/回）：
```
【第1回】
[1藍] [2藍] [3藍] [4藍] [5藍]
[6綠] [7綠] [8綠] [9綠] [10綠]

【第2回】
[1藍] [2藍] [3藍] [4藍] [5藍]  ← 色系重置
[6綠] [7綠] [8綠] [9綠] [10綠]
```

### 寬度計算邏輯

**方案 B：算空格（接近實際渲染）**

```python
def _estimate_answer_display_width(answer: str) -> int:
    """估算答案顯示寬度

    規則：
    - \frac{分子}{分母} → max(分子, 分母) 長度
    - \sqrt{內容} → 內容長度 + 1
    - 上下標 ^{...} _{...} → 不佔額外寬度
    - 運算符 +, -, = → 兩側各加 1 格空格
    - 絕對值 |...| → 內容長度 + 2
    - 多行 \\\\ → 取最長行
    - 中文字 → 計 2 格
    """
```

**分類閾值**：
```python
width < 8:   tiny    # -1, √3/2, 45°
width < 15:  short   # -cos(20°), sin(θ)
width < 30:  medium  # √19 - 2√3, x = -45° 或 135°
width >= 30: long    # 通解、n ∈ ℤ
```

## 實施步驟

### Phase 1：LaTeX 前導分離（基礎重構）

**目標**：建立完全獨立的三個 preamble 方法

#### 1.1 新增三個獨立方法

**檔案**：`utils/latex/structure.py`

**新增方法**：
- `get_question_preamble(title)` - 題目頁完整前導
- `get_answer_preamble(title)` - 簡答頁完整前導（**含新卡片格式**）
- `get_explanation_preamble(title)` - 詳解頁完整前導

**簡答頁 preamble 關鍵內容**：
```latex
% 四色系定義
\definecolor{cardback1}{RGB}{240,248,255}    % 藍灰 - 淡藍底
\definecolor{cardborder1}{RGB}{100,149,237}
\definecolor{numback1}{RGB}{70,130,180}

\definecolor{cardback2}{RGB}{240,255,240}    % 綠 - 淡綠底
\definecolor{cardborder2}{RGB}{60,179,113}
\definecolor{numback2}{RGB}{46,139,87}

\definecolor{cardback3}{RGB}{248,240,255}    % 紫 - 淡紫底
\definecolor{cardborder3}{RGB}{147,112,219}
\definecolor{numback3}{RGB}{106,90,205}

\definecolor{cardback4}{RGB}{255,248,240}    % 橙 - 淡橙底
\definecolor{cardborder4}{RGB}{255,140,0}
\definecolor{numback4}{RGB}{255,99,71}

% 動態顏色切換
\newcommand{\setColorScheme}[1]{
  \ifnum#1=1
    \colorlet{cardback}{cardback1}
    \colorlet{cardborder}{cardborder1}
    \colorlet{numback}{numback1}
  \else\ifnum#1=2
    \colorlet{cardback}{cardback2}
    \colorlet{cardborder}{cardborder2}
    \colorlet{numback}{numback2}
  \else\ifnum#1=3
    \colorlet{cardback}{cardback3}
    \colorlet{cardborder}{cardborder3}
    \colorlet{numback}{numback3}
  \else
    \colorlet{cardback}{cardback4}
    \colorlet{cardborder}{cardborder4}
    \colorlet{numback}{numback4}
  \fi\fi\fi
}

% 四種寬度卡片（使用動態顏色）
\newcommand{\tinyCard}[2]{
  \noindent\begin{minipage}[t]{0.23\textwidth}
    \begin{tcolorbox}[
      enhanced, colback=cardback, colframe=cardborder,
      arc=3mm, boxrule=1.2pt,
      left=1mm, right=2mm, top=2.5mm, bottom=2.5mm
    ]
    \tikz[baseline=(num.base)]{
      \node[rectangle, rounded corners=2mm, fill=numback,
            text=white, inner sep=2pt, font=\small\bfseries] (num) {#1};
    }\hspace{2mm}#2
    \end{tcolorbox}
  \end{minipage}\hspace{0.015\textwidth}%
}

\newcommand{\shortCard}[2]{...}   % 0.305\textwidth
\newcommand{\mediumCard}[2]{...}  % 0.47\textwidth
\newcommand{\longCard}[2]{...}    % 0.98\textwidth


% 換行命令。這是錯誤的工作項目，latex不需要\br換行命令，有自己的換行命令可直接使用。
\newcommand{\br}{\par}



% 回標題命令（保留原有）
\newcommand{\roundtitle}[1]{
    \begin{center}
        \colorbox{roundtitle!10}{
            \begin{minipage}{0.95\textwidth}
                \centering\large\textbf{\textcolor{roundtitle}{#1}}
            \end{minipage}
        }
    \end{center}
    \vspace{0.5em}
}
```

#### 1.2 移除舊命令

**檔案**：`utils/latex/structure.py`

**刪除內容**（第 114-141 行）：
- `\newcommand{\numberedAnswerLine}[2]{...}` - 舊的固定三欄格式
- `\newenvironment{answerRow}{...}{...}` - 舊的行環境

#### 1.3 更新調用點

**檔案**：`utils/latex/generator.py`

```python
# 第 74 行 - generate_question_tex()
content = self.latex_structure.get_question_preamble(test_title)

# 第 195 行 - generate_answer_tex()
content = self.latex_structure.get_answer_preamble(test_title)

# 第 275 行 - generate_explanation_tex()
content = self.latex_structure.get_explanation_preamble(test_title)
```

#### 1.4 清理舊方法

- 刪除 `LaTeXStructure.get_preamble()`
- 刪除 `LaTeXGenerator._get_preamble()` 適配方法
- 使用 Grep 確認無遺留調用

### Phase 2：簡答頁寬度計算（智能化）

**目標**：實現答案寬度自動計算，決定使用哪種卡片

#### 2.1 新增寬度估算方法

**檔案**：`utils/latex/generator.py`

**新增方法**：
```python
def _estimate_answer_display_width(self, answer: str) -> int:
    """估算答案的顯示寬度（字元數）

    考慮 LaTeX 語義結構，而非單純字元計數。

    處理邏輯：
    1. 多行答案（\\\\）→ 取最長行
    2. 分數（\\frac{分子}{分母}）→ max(分子, 分母)
    3. 根號（\\sqrt{內容}）→ 內容長度 + 1
    4. 上下標（^{...} _{...}）→ 移除（不佔寬度）
    5. 絕對值（|...|）→ 內容長度 + 2
    6. 運算符（+, -, =）→ 兩側各加 1 格空白
    7. LaTeX 命令（\\sin, \\cos, \\pi, \\circ...）→ 替換為等寬字元
    8. 中文字 → 計 2 格

    Returns:
        估計的顯示寬度（字元數）

    Example:
        >>> _estimate_answer_display_width("$-1$")
        2
        >>> _estimate_answer_display_width("$\\frac{\\sqrt{3}}{2}$")
        2  # max(√3, 2) = 2
        >>> _estimate_answer_display_width("$\\sqrt{19} - 2\\sqrt{3}$")
        9  # √ 1 9 空 - 空 2 √ 3
    """
    import re

    # 處理多行：取最長的一行
    if '\\\\' in answer:
        lines = answer.split('\\\\')
        return max(self._estimate_answer_display_width(line) for line in lines)

    # 移除數學模式符號
    text = answer.replace('$', '')

    # 處理分數：\frac{分子}{分母} → 取較長者
    frac_pattern = r'\\frac\{([^}]*)\}\{([^}]*)\}'
    while True:
        match = re.search(frac_pattern, text)
        if not match:
            break
        numerator = match.group(1)
        denominator = match.group(2)
        longer = numerator if len(numerator) >= len(denominator) else denominator
        text = text[:match.start()] + longer + text[match.end():]

    # 處理根號：\sqrt{內容} → _內容（根號佔 1 格）
    sqrt_pattern = r'\\sqrt\{([^}]*)\}'
    text = re.sub(sqrt_pattern, r'_\1', text)

    # 處理上下標：^{...} 和 _{...} → 移除
    text = re.sub(r'\^+\{[^}]*\}', '', text)
    text = re.sub(r'_+\{[^}]*\}', '', text)

    # 運算符兩側加空格（模擬 LaTeX 自動間距）
    text = re.sub(r'([+\-=])', r' \1 ', text)

    # 處理常見 LaTeX 命令（替換為等寬字元）
    replacements = {
        r'\\circ': '°',
        r'\\pi': 'π',
        r'\\in': '∈',
        r'\\mathbb\{Z\}': 'Z',
        r'\\sin': 'sin',
        r'\\cos': 'cos',
        r'\\tan': 'tan',
        r'\\cot': 'cot',
        r'\\sec': 'sec',
        r'\\csc': 'csc',
        r'\\arcsin': 'arcsin',
        r'\\arccos': 'arccos',
        r'\\arctan': 'arctan',
        r'\\cdot': '·',
        r'\\times': '×',
        r'\\left\|': '|',
        r'\\right\|': '|',
    }
    for pattern, replacement in replacements.items():
        text = re.sub(pattern, replacement, text)

    # 移除剩餘反斜線命令
    text = re.sub(r'\\[a-zA-Z]+', '', text)

    # 移除多餘空白但保留單個空格
    text = re.sub(r'\s+', ' ', text).strip()

    # 中文字計 2 格
    chinese_chars = sum(1 for c in text if '\u4e00' <= c <= '\u9fff')
    total_chars = len(text)
    english_chars = total_chars - chinese_chars

    return english_chars + chinese_chars * 2
```

#### 2.2 新增卡片類型判斷方法

```python
def _get_answer_card_type(self, answer: str) -> str:
    """根據答案顯示寬度決定卡片類型

    分類標準：
    - tiny (< 8):   單數字、簡單分數
    - short (< 15): 簡單三角函數、角度
    - medium (< 30): 根式、帶「或」的短式
    - long (>= 30): 通解、長表達式

    Returns:
        'tiny' | 'short' | 'medium' | 'long'
    """
    # 特殊規則：包含通解符號 → 強制 long
    if 'n \\in' in answer or '\\mathbb{Z}' in answer:
        return 'long'

    # 估算顯示寬度
    width = self._estimate_answer_display_width(answer)

    # 根據寬度分類
    if width < 8:
        return 'tiny'
    elif width < 15:
        return 'short'
    elif width < 30:
        return 'medium'
    else:
        return 'long'
```

### Phase 3：簡答頁生成邏輯（整合）

**目標**：整合寬度計算 + 卡片選擇 + 色系輪換 + 保留分回邏輯

#### 3.1 完全重寫 `generate_answer_tex()` 方法

**檔案**：`utils/latex/generator.py`

**關鍵修改**：
```python
def generate_answer_tex(self, layout_results, test_title, questions_per_round=0):
    """生成簡答頁 LaTeX（新格式：四寬度 + 四色系 + 分回）

    Args:
        layout_results: 佈局結果列表
        test_title: 測驗標題
        questions_per_round: 每回題數（0表示不分回）
    """
    # 使用新的完全獨立 preamble
    content = self.latex_structure.get_answer_preamble(test_title)
    content += r"\begin{document}" + "\n"

    # 標題
    content += r"\begin{center}" + "\n"
    content += r"{\Large \textbf{" + test_title + r" - 簡答}}" + "\n"
    content += r"\end{center}" + "\n\n"

    # 生成日期
    content += r"\noindent 生成日期：" + self.current_date + r"\hfill" + "\n\n"

    # 追蹤當前回數和行寬度
    current_round = -1
    current_line_width = 0.0
    card_widths = {
        'tiny': 0.25,      # 0.23 + 0.015 間距 + 0.005 容錯
        'short': 0.325,    # 0.305 + 0.02
        'medium': 0.49,    # 0.47 + 0.02
        'long': 1.0        # 0.98 + 換行
    }

    for i, question in enumerate(layout_results):
        # 🔑 計算回數和回內題號（保持原邏輯）
        if questions_per_round > 0:
            round_num = (i // questions_per_round) + 1
            question_num_in_round = (i % questions_per_round) + 1
        else:
            round_num = 1
            question_num_in_round = i + 1

        # 🔑 換回處理（保持原邏輯，替換 answerRow 為 br）
        if round_num != current_round:
            # 結束上一回的行
            if current_line_width > 0:
                content += "\\br\n"
                current_line_width = 0.0

            # 添加回次間距
            if current_round != -1 and round_num > 1:
                content += r"\vspace{1.5em}" + "\n\n"

            # 插入回標題
            content += f"\\roundtitle{{第{round_num}回}}\n\n"
            current_round = round_num

        # 🆕 色系輪換（基於回內題號）
        if (question_num_in_round - 1) % 5 == 0:
            color_scheme = ((question_num_in_round - 1) // 5) % 4 + 1
            content += f"\\setColorScheme{{{color_scheme}}}\n"

        # 🆕 決定卡片類型
        answer = question.get('answer', '')
        card_type = self._get_answer_card_type(answer)
        card_width = card_widths[card_type]

        # 🆕 檢查是否需要換行（基於寬度累積）
        if current_line_width + card_width > 1.0 and current_line_width > 0:
            content += "\\br\n"
            current_line_width = 0.0

        # 🆕 生成卡片（使用回內題號）
        content += f"\\{card_type}Card{{{question_num_in_round}}}{{{answer}}}\n"

        # 🆕 更新行寬度
        current_line_width += card_width
        if card_type == 'long':
            current_line_width = 0.0  # long 卡片佔滿整行

    # 結束最後一行（如果未結束）
    if current_line_width > 0:
        content += "\\br\n"

    # 頁尾
    content += self.latex_structure.generate_page_footer()
    content += r"\end{document}" + "\n"

    return content
```

**關鍵特點**：
- ✅ 保留分回邏輯（`round_num`, `question_num_in_round`）
- ✅ 保留 `\roundtitle{第N回}`
- ✅ 色系基於回內題號輪換
- ✅ 題號使用回內編號（與題目頁一致）
- ✅ 自動換行基於寬度累積
- ✅ 換回時強制換行和重置

### Phase 4：測試驗證

#### 4.1 功能測試

**測試案例**：生成包含各種答案類型的測驗

```python
# 測試答案集
test_answers = [
    "$-1$",                                              # tiny (2字元)
    "$\\frac{\\sqrt{3}}{2}$",                            # tiny (2字元)
    "$45^\\circ$",                                       # tiny (3字元)
    "$\\sqrt{19} - 2\\sqrt{3}$",                         # short (9字元)
    "$-\\cos(20^\\circ)$",                               # short (9字元)
    "$x = -45^\\circ$ 或 $135^\\circ$",                  # medium (~20字元)
    "$\\sqrt{23} + \\sqrt{7}$",                          # short (11字元)
    "$x = 45^\\circ + 360^\\circ n, n \\in \\mathbb{Z}$" # long (特殊規則)
]
```

**驗證項目**：
- [ ] tiny 卡片四欄排列正確
- [ ] short 卡片三欄排列正確
- [ ] medium 卡片兩欄排列正確
- [ ] long 卡片單欄佔滿整行
- [ ] 自動換行邏輯正確（基於寬度累積）
- [ ] 分回標題正常顯示
- [ ] 色系在每回內正確輪換（1-5藍，6-10綠...）
- [ ] 換回後色系重置為 1
- [ ] 題號顯示回內編號（1-10循環）

#### 4.2 寬度計算驗證

**測試寬度估算準確性**：
```python
test_cases = [
    ("$-1$", 2, "tiny"),
    ("$\\frac{\\sqrt{3}}{2}$", 2, "tiny"),
    ("$45^\\circ$", 3, "tiny"),
    ("$\\sqrt{19} - 2\\sqrt{3}$", 9, "short"),
    ("$2$ 或 $3$", 5, "tiny"),
    ("$x = -45^\\circ$ 或 $135^\\circ$", 20, "medium"),
]

for answer, expected_width, expected_type in test_cases:
    actual_width = self._estimate_answer_display_width(answer)
    actual_type = self._get_answer_card_type(answer)
    assert actual_width == expected_width, f"寬度計算錯誤: {answer}"
    assert actual_type == expected_type, f"類型判斷錯誤: {answer}"
```

#### 4.3 LaTeX 編譯測試

**簡答頁檢查**：
- [ ] 四種卡片正常渲染
- [ ] 色系切換正常（顏色正確）
- [ ] 卡片排列整齊（對齊、間距）
- [ ] 題號框顏色隨色系變化
- [ ] 長答案不會超出卡片邊界
- [ ] 短答案不會浪費空間
- [ ] 回標題正常顯示
- [ ] 換回時正確換行和間距

**題目頁、詳解頁檢查**：
- [ ] 前導分離後功能不受影響
- [ ] LaTeX 編譯無錯誤
- [ ] PDF 輸出正常

#### 4.4 獨立性驗證

**測試前導完全獨立**：
1. 修改簡答頁字型大小 12pt → 10pt
2. 生成三種文件 PDF
3. 確認只有簡答頁字型變小，題目頁和詳解頁不受影響

#### 4.5 分回功能驗證

**測試案例 1**：無分回（50 題連續）
```python
questions_per_round = 0
# 預期：無回標題，題號 1-50 連續，色系每 5 題輪換
```

**測試案例 2**：有分回（5 回 × 10 題）
```python
questions_per_round = 10
# 預期：
# 第1回：題號 1-10，色系 1-5藍 6-10綠
# 第2回：題號 1-10，色系 1-5藍 6-10綠（重置）
```

**測試案例 3**：不規則分回（3 回 × 15 題）
```python
questions_per_round = 15
# 預期：
# 第1回：題號 1-15，色系 1-5藍 6-10綠 11-15紫
# 第2回：題號 1-15，色系 1-5藍 6-10綠 11-15紫（重置）
```

### Phase 5：閾值微調（根據實測結果）

**目標**：根據實際 PDF 輸出微調分類閾值

**可調整參數**：
```python
# 當前閾值
TINY_THRESHOLD = 8      # 可能需要調整為 6 或 10
SHORT_THRESHOLD = 15    # 可能需要調整為 12 或 18
MEDIUM_THRESHOLD = 30   # 可能需要調整為 25 或 35

# 卡片寬度
TINY_WIDTH = 0.23       # 可能需要微調
SHORT_WIDTH = 0.305
MEDIUM_WIDTH = 0.47
LONG_WIDTH = 0.98

# 色系顏色
# 根據印刷效果調整 RGB 值
```

**調整方法**：
1. 生成 50 題測驗（包含各種答案類型）
2. 檢查 PDF 輸出，記錄分類錯誤
3. 調整閾值，重新生成
4. 重複直到 95% 以上正確分類

## 風險評估與緩解

### 高風險點

#### 風險 1：寬度估算不準確
- **描述**：某些 LaTeX 結構未考慮到，導致寬度計算錯誤
- **影響**：卡片類型選擇錯誤，答案超出邊界或空白過多
- **緩解措施**：
  1. 建立完整測試案例集（涵蓋所有題型）
  2. 特殊規則優先（如通解強制 long）
  3. 允許 5% 誤差率，閾值微調補償

#### 風險 2：自動換行邏輯錯誤
- **描述**：行寬計算錯誤，導致卡片超出頁面或換行不當
- **影響**：排版混亂，視覺效果差
- **緩解措施**：
  1. 保守估計卡片寬度（加入容錯值）
  2. 充分測試各種卡片組合
  3. long 卡片強制佔滿整行

#### 風險 3：色系印刷效果不佳
- **描述**：色系在螢幕好看，但印刷後難以區分
- **影響**：失去色系輪換的對答輔助效果
- **緩解措施**：
  1. 選擇高對比色系（明度差異明顯）
  2. 測試黑白影印效果
  3. 提供可配置色系方案

### 中風險點

#### 風險 4：前導分離遺漏命令
- **描述**：某個 LaTeX 命令在新 preamble 中遺漏
- **影響**：LaTeX 編譯錯誤
- **緩解措施**：
  1. 對照原 preamble 逐行檢查
  2. Phase 1 完成後立即全面測試
  3. 保留原 preamble 作為參考

#### 風險 5：分回邏輯破壞
- **描述**：修改過程中破壞原有分回邏輯
- **影響**：題號錯誤、與題目頁不對應
- **緩解措施**：
  1. 保留所有分回相關代碼
  2. 充分測試不同 `questions_per_round` 值
  3. 對比舊版輸出確認題號一致性

### 低風險點

#### 風險 6：LaTeX 版本兼容性
- **描述**：某些 LaTeX 命令在不同版本表現不同
- **影響**：在其他環境編譯可能失敗
- **緩解措施**：
  1. 使用標準 LaTeX 命令
  2. 文檔註明需要的套件版本
  3. 提供完整編譯環境說明

## 成功標準

### 功能完整性
- [ ] 三個完全獨立 preamble 方法正常運作
- [ ] 四種卡片寬度正確實現
- [ ] 寬度自動計算 95% 以上準確
- [ ] 色系輪換正常（每回內每 5 題一組）
- [ ] 分回功能正常（與題目頁題號一致）
- [ ] 自動換行邏輯正確
- [ ] 所有文件 PDF 正常生成

### 獨立性驗證
- [ ] 修改簡答頁配置不影響題目頁和詳解頁
- [ ] 修改題目頁配置不影響簡答頁和詳解頁
- [ ] 修改詳解頁配置不影響題目頁和簡答頁

### 品質標準
- [ ] 無 LaTeX 編譯錯誤
- [ ] 無 Python 執行錯誤
- [ ] 代碼符合專案規範（合理行數、Sphinx 文檔）
- [ ] 舊方法已完全移除

### 視覺效果
- [ ] 簡答頁排版整齊美觀
- [ ] 色系對比明顯，易於區分
- [ ] 長答案不超出邊界
- [ ] 短答案不浪費空間
- [ ] 回標題清晰醒目
- [ ] 黑白影印時仍可區分色系（明度差異）

### 一致性驗證
- [ ] 簡答頁題號與題目頁完全一致
- [ ] 簡答頁題號與詳解頁完全一致
- [ ] 分回邏輯與原系統行為一致

## 預期效果

### 1. 維護性提升（零耦合）
- **完全獨立** - 三種文件零耦合，修改一個絕不影響其他
- **風險隔離** - 錯誤不會跨文件傳播
- **易於擴展** - 新增文件類型（如答題卡）不影響現有代碼

### 2. 簡答頁用戶體驗
- **節省空間** - 短答案用四欄，不浪費紙張
- **視覺清晰** - 長答案用單欄，有足夠寬度
- **對答友善** - 色系輪換快速定位（「第2回綠色組」）
- **美觀大方** - 流式佈局自然換行
- **保持一致** - 題號與題目頁完全對應

### 3. 開發效率
- **自動化** - 不需手動決定卡片寬度
- **智能化** - LaTeX 語義感知寬度計算
- **可調整** - 閾值、色系、卡片寬度都可配置

### 4. 技術債務清理
- **移除耦合** - 刪除共用 preamble 方法
- **代碼簡化** - 簡答頁生成邏輯清晰
- **符合原則** - 零耦合優於過早抽象

## 時程估計

| 階段 | 任務 | 預估時間 |
|------|------|---------|
| Phase 1 | 前導分離 - 新增三個獨立方法 | 40 分鐘 |
| Phase 1 | 前導分離 - 更新調用點、清理舊方法 | 15 分鐘 |
| Phase 2 | 寬度計算 - 實現估算方法 | 30 分鐘 |
| Phase 2 | 寬度計算 - 卡片類型判斷 | 10 分鐘 |
| Phase 3 | 簡答頁生成 - 重寫邏輯（保留分回） | 30 分鐘 |
| Phase 4 | 測試驗證 - 功能測試 | 20 分鐘 |
| Phase 4 | 測試驗證 - 寬度計算驗證 | 15 分鐘 |
| Phase 4 | 測試驗證 - LaTeX 編譯測試 | 15 分鐘 |
| Phase 4 | 測試驗證 - 獨立性驗證 | 10 分鐘 |
| Phase 4 | 測試驗證 - 分回功能驗證 | 10 分鐘 |
| Phase 5 | 閾值微調 | 20 分鐘 |

**總計**：約 215 分鐘（3.6 小時）

## 回滾計畫

如果重構過程中發現嚴重問題：

1. **使用 Git 還原**
   ```bash
   git checkout -- utils/latex/structure.py
   git checkout -- utils/latex/generator.py
   ```

2. **確認功能正常**
   ```bash
   python main.py
   # 測試基本功能
   ```

3. **分階段回滾**
   - 如果只有簡答頁問題 → 只回滾 Phase 2-3
   - 如果前導分離有問題 → 完全回滾 Phase 1-3

## 實施檢查清單

### 執行前確認
- [ ] 已備份當前程式碼（Git commit）
- [ ] 已閱讀並理解完整計畫
- [ ] 已準備測試環境（LaTeX 編譯器、測試數據）
- [ ] 已確認 Python 和 LaTeX 環境正常

### Phase 1 執行後檢查
- [ ] 三個新方法語法正確
- [ ] 調用點更新完成
- [ ] 舊方法已刪除
- [ ] 題目頁 PDF 正常生成
- [ ] 簡答頁 PDF 正常生成（暫用基本格式）
- [ ] 詳解頁 PDF 正常生成

### Phase 2 執行後檢查
- [ ] 寬度估算方法語法正確
- [ ] 測試案例通過（至少 80% 準確）
- [ ] 卡片類型判斷邏輯正確
- [ ] 無 Python 執行錯誤

### Phase 3 執行後檢查
- [ ] 簡答頁生成邏輯整合完成
- [ ] 分回邏輯保留正常
- [ ] 色系輪換正常
- [ ] 自動換行正常
- [ ] 簡答頁 PDF 輸出正常
- [ ] 題號與題目頁一致

### Phase 4 執行後檢查
- [ ] 所有測試案例通過
- [ ] 所有成功標準達成
- [ ] 視覺效果符合預期
- [ ] 無編譯錯誤或警告
- [ ] 分回功能正常

### Phase 5 執行後檢查
- [ ] 閾值微調完成
- [ ] 分類準確率 ≥ 95%
- [ ] 最終 PDF 輸出滿意

---

**計畫狀態**：研擬中
**建立日期**：2025-10-10
**修訂日期**：2025-10-10（修正分回邏輯理解）
**預計執行日期**：待用戶確認
**預估工時**：215 分鐘（3.6 小時）
**風險等級**：中等（已識別緩解措施）
**設計哲學**：零耦合 + 智能化 + 用戶友善 + 保持一致性
**整合目標**：前導分離（基礎） + 簡答頁優化（增值） + 分回邏輯（保留）
