# ConfigFactory æ§ä»¶æ“´å±•å¯¦æ–½æŒ‡å—

> **æ–‡æª”**: æ•¸å­¸æ¸¬é©—ç”Ÿæˆå™¨ ConfigFactory æ§ä»¶æ“´å±•å¯¦æ–½æŒ‡å—
> **å‰µå»ºæ—¥æœŸ**: 2025-09-29
> **ç‹€æ…‹**: âœ… **å·²å®Œæˆ**
> **ç›®çš„**: ç‚ºå·¥ç¨‹å¸«æä¾›åœ¨ ConfigUIFactory ä¸­æ–°å¢æ§ä»¶é¡å‹çš„å®Œæ•´å¯¦æ–½æµç¨‹

## ğŸ¯ **è¨­è¨ˆåŸå‰‡**

### **æ ¸å¿ƒç†å¿µ**
- **å¯¦ç”¨ç‚ºå…ˆ**: åªå¯¦ç¾å¯¦éš›éœ€è¦çš„æ§ä»¶é¡å‹
- **åš´æ ¼é©—è­‰**: æ‰€æœ‰é…ç½®å¿…é ˆç¬¦åˆè¦ç¯„ï¼ŒéŒ¯èª¤æ ¼å¼ç«‹å³æ‹‹å‡ºç•°å¸¸
- **å‘å¾Œå…¼å®¹**: æ–°æ§ä»¶ä¸å½±éŸ¿ç¾æœ‰åŠŸèƒ½
- **æ˜“æ–¼ç¶­è­·**: éµå¾ªç¾æœ‰æ¨¡å¼ï¼Œä¿æŒä»£ç¢¼ä¸€è‡´æ€§

---

## ğŸ“‹ **ç›®å‰å·²å¯¦ç¾çš„æ§ä»¶é¡å‹**

### **1. select - ä¸‹æ‹‰é¸æ“‡æ¡† (QComboBox)**

#### **æ ¼å¼å®šç¾©**
```python
{
    "type": "select",
    "label": "é¡¯ç¤ºæ¨™ç±¤",
    "default": "é è¨­é¸é …",
    "options": ["é¸é …1", "é¸é …2", "é¸é …3"],  # å¿…éœ€
    "description": "å¯é¸çš„è©³ç´°èªªæ˜"
}
```

#### **å¯¦éš›ä½¿ç”¨ç¯„ä¾‹**
```python
# ä¾†è‡ª TrigonometricFunctionGenerator
"function_scope": {
    "type": "select",
    "label": "å‡½æ•¸ç¯„åœ",
    "default": "basic",
    "options": ["basic", "extended"],
    "description": "basic(sin,cos,tan) vs extended(+cot,sec,csc)"
},
"angle_mode": {
    "type": "select",
    "label": "è§’åº¦æ¨¡å¼",
    "default": "degree",
    "options": ["degree", "radian", "mixed"],
    "description": "degree(è§’åº¦åˆ¶) radian(å¼§åº¦åˆ¶) mixed(æ··åˆ)"
}
```

#### **é©—è­‰è¦å‰‡**
- âœ… `options` å¿…éœ€ï¼Œä¸”ç‚ºéç©ºåˆ—è¡¨
- âœ… `default` å¿…éœ€ï¼Œä¸”å¿…é ˆåœ¨ `options` ä¸­

---

### **2. checkbox - å‹¾é¸æ¡† (QCheckBox)**

#### **æ ¼å¼å®šç¾©**
```python
{
    "type": "checkbox",
    "label": "é¡¯ç¤ºæ¨™ç±¤",
    "default": True | False,
    "description": "å¯é¸çš„è©³ç´°èªªæ˜"
}
```

#### **é©—è­‰è¦å‰‡**
- âœ… `default` å¿…éœ€ï¼Œä¸”ç‚ºå¸ƒæ—å€¼

---

### **3. percentage_group - ç™¾åˆ†æ¯”åˆ†é…å°è©±æ¡† (QPushButton + PercentageConfigDialog)**

#### **æ ¼å¼å®šç¾©**
```python
{
    "type": "percentage_group",
    "label": "çµ„åˆæ¨™ç±¤",
    "description": "è©³ç´°èªªæ˜",
    "items": {
        "item1_key": {
            "label": "é …ç›®1æ¨™ç±¤",
            "default": æ•¸å­—å€¼
        },
        "item2_key": {
            "label": "é …ç›®2æ¨™ç±¤",
            "default": æ•¸å­—å€¼
        }
        # ... æ›´å¤šé …ç›®
    }
}
```

#### **å¯¦éš›ä½¿ç”¨ç¯„ä¾‹**
```python
# ä¾†è‡ª TrigAngleConversionGenerator
"mode_weights": {
    "type": "percentage_group",
    "label": "é¡Œå‹æ¯”ä¾‹åˆ†é…",
    "description": "èª¿æ•´ä¸‰ç¨®é¡Œå‹çš„å‡ºç¾é »ç‡ï¼Œç¸½å’Œè‡ªå‹•ä¿æŒç‚º100%",
    "items": {
        "original": {
            "label": "0~90Â°è½‰æ›",
            "default": 70
        },
        "formula": {
            "label": "å…¬å¼å•ç­”",
            "default": 10
        },
        "narrow_angle": {
            "label": "0~45Â°è½‰æ›",
            "default": 20
        }
    }
}
```

#### **é©—è­‰è¦å‰‡**
- âœ… `items` å¿…éœ€ï¼Œä¸”è‡³å°‘åŒ…å«2å€‹é …ç›®
- âœ… æ‰€æœ‰é …ç›®çš„ `default` ç¸½å’Œå¿…é ˆç­‰æ–¼100
- âœ… æ‰€æœ‰é …ç›®å¿…é ˆåŒ…å« `label` å’Œ `default`

---

### **4. number_input - æ•¸å­—è¼¸å…¥æ¡† (QSpinBox)**

#### **æ ¼å¼å®šç¾©**
```python
{
    "type": "number_input",
    "label": "é¡¯ç¤ºæ¨™ç±¤",
    "default": æ•¸å­—å€¼,
    "min": æœ€å°å€¼,     # å¿…éœ€
    "max": æœ€å¤§å€¼,     # å¿…éœ€
    "description": "å¯é¸çš„è©³ç´°èªªæ˜"
}
```

#### **å¯¦éš›ä½¿ç”¨ç¯„ä¾‹**
```python
# ä¾†è‡ª DoubleRadicalSimplificationGenerator
"max_value": {
    "type": "number_input",
    "label": "æ•¸å€¼ä¸Šé™",
    "default": 25,
    "min": 5,
    "max": 100,
    "description": "æ§åˆ¶ç”Ÿæˆç­”æ¡ˆæ•¸å­—çš„æœ€å¤§å€¼"
}
```

#### **é©—è­‰è¦å‰‡**
- âœ… `default`, `min`, `max` å¿…éœ€ï¼Œä¸”ç‚ºæ•¸å­—é¡å‹
- âœ… `min` < `max`
- âœ… `min` â‰¤ `default` â‰¤ `max`

---

## ğŸ”§ **æ–°å¢æ§ä»¶é¡å‹çš„å®Œæ•´å¯¦æ–½æµç¨‹**

åŸºæ–¼ number_input çš„å¯¦éš›å¯¦ç¾ç¶“é©—ï¼Œä»¥ä¸‹æ˜¯å®Œæ•´çš„8æ­¥é©Ÿæµç¨‹ï¼š

### **Phase A: ConfigUIFactory æ“´å±•**

#### **A1: å°å…¥ PyQt æ§ä»¶ (1åˆ†é˜)**
**æª”æ¡ˆ**: `utils/ui/config_factory.py` ç¬¬30è¡Œ
```python
# åœ¨ç¾æœ‰å°å…¥ä¸­æ–°å¢æ§ä»¶
from PyQt5.QtWidgets import QWidget, QVBoxLayout, QHBoxLayout, QLabel, QComboBox, QCheckBox, QPushButton, QSpinBox, æ–°æ§ä»¶é¡å‹
```

#### **A2: æ›´æ–°æ¨¡çµ„æ–‡æª” (1åˆ†é˜)**
**æª”æ¡ˆ**: `utils/ui/config_factory.py` ç¬¬12è¡Œ
```python
# åœ¨æ”¯æ´æ§ä»¶é¡å‹åˆ—è¡¨ä¸­æ–°å¢
- æ”¯æ´æ§ä»¶é¡å‹ï¼šselect(ä¸‹æ‹‰æ¡†)ã€checkbox(å‹¾é¸æ¡†)ã€percentage_group(ç™¾åˆ†æ¯”åˆ†é…)ã€number_input(æ•¸å­—è¼¸å…¥æ¡†)ã€æ–°æ§ä»¶é¡å‹(èªªæ˜)
```

#### **A3: æ›´æ–° ConfigUIFactory é¡åˆ¥æ–‡æª” (1åˆ†é˜)**
**æª”æ¡ˆ**: `utils/ui/config_factory.py` ç¬¬44-48è¡Œ
```python
# åœ¨æ”¯æ´çš„æ§ä»¶é¡å‹ä¸­æ–°å¢
- æ–°æ§ä»¶é¡å‹: èªªæ˜ï¼ˆå°æ‡‰çš„PyQtæ§ä»¶ï¼‰
```

#### **A4: æ–°å¢æ§ä»¶å‰µå»ºåˆ†æ”¯ (2åˆ†é˜)**
**æª”æ¡ˆ**: `utils/ui/config_factory.py` ç¬¬147-157è¡Œ
```python
# åœ¨ç¾æœ‰ elif åˆ†æ”¯å¾Œæ–°å¢
elif control_type == "æ–°æ§ä»¶é¡å‹":
    control = self._create_æ–°æ§ä»¶é¡å‹_widget(config)
```

#### **A5: å¯¦ç¾æ§ä»¶å‰µå»ºæ–¹æ³• (8-15åˆ†é˜)**
**æª”æ¡ˆ**: `utils/ui/config_factory.py`
```python
def _create_æ–°æ§ä»¶é¡å‹_widget(self, config: Dict[str, Any]) -> å°æ‡‰PyQtæ§ä»¶:
    """å‰µå»ºæ–°æ§ä»¶é¡å‹

    Args:
        config: å¿…é ˆåŒ…å«ç‰¹å®šåƒæ•¸

    Returns:
        å°æ‡‰PyQtæ§ä»¶: é…ç½®å¥½çš„æ§ä»¶å¯¦ä¾‹

    Raises:
        ValueError: é…ç½®åƒæ•¸éŒ¯èª¤
    """
    # 1. é©—è­‰å¿…éœ€åƒæ•¸
    required_fields = ['field1', 'field2']
    for field in required_fields:
        if field not in config:
            raise ValueError(f"æ–°æ§ä»¶é¡å‹å¿…é ˆæä¾›{field}åƒæ•¸")

    # 2. æå–ä¸¦é©—è­‰åƒæ•¸
    # 3. å‰µå»º PyQt æ§ä»¶
    # 4. è¨­å®šæ§ä»¶å±¬æ€§
    # 5. è¿”å›æ§ä»¶
```

#### **A6: æ–°å¢å€¼æ”¶é›†é‚è¼¯ (2åˆ†é˜)**
**æª”æ¡ˆ**: `utils/ui/config_factory.py` ç¬¬487-502è¡Œ
```python
# åœ¨ç¾æœ‰ elif åˆ†æ”¯å¾Œæ–°å¢
elif control_type == "æ–°æ§ä»¶é¡å‹" and isinstance(control, å°æ‡‰PyQtæ§ä»¶):
    return control.ç²å–å€¼çš„æ–¹æ³•()
```

### **Phase B: ç”Ÿæˆå™¨é…ç½®å¯¦ç¾**

#### **B1: å¯¦ç¾ get_config_schema æ–¹æ³• (5-8åˆ†é˜)**
**æª”æ¡ˆ**: ç›®æ¨™ç”Ÿæˆå™¨æª”æ¡ˆ
```python
@classmethod
def get_config_schema(cls) -> Dict[str, Dict[str, Any]]:
    """å–å¾—ç”Ÿæˆå™¨é…ç½®æè¿°ï¼Œä¾›UIå‹•æ…‹ç”Ÿæˆé…ç½®ä»‹é¢"""
    return {
        "config_field": {
            "type": "æ–°æ§ä»¶é¡å‹",
            "label": "é¡¯ç¤ºæ¨™ç±¤",
            "default": é è¨­å€¼,
            # å…¶ä»–å¿…éœ€åƒæ•¸
            "description": "èªªæ˜æ–‡å­—"
        }
    }
```

### **Phase C: æ•´åˆæ¸¬è©¦**

#### **C1: åŸºæœ¬åŠŸèƒ½æ¸¬è©¦ (3åˆ†é˜)**
```bash
# æ¸¬è©¦æ§ä»¶å‰µå»º
py -c "
from utils.ui.config_factory import ConfigUIFactory
factory = ConfigUIFactory()
schema = {'test': {'type': 'æ–°æ§ä»¶é¡å‹', ...}}
widget = factory.create_widget_from_schema(schema)
print('âœ… æ§ä»¶å‰µå»ºæˆåŠŸ')
"

# æ¸¬è©¦å€¼æ”¶é›†
py -c "
from utils.ui.config_factory import ConfigValueCollector
collector = ConfigValueCollector()
values = collector.collect_values(widget, schema)
print('âœ… å€¼æ”¶é›†æˆåŠŸ:', values)
"
```

#### **C2: è¨»å†Šç³»çµ±æ•´åˆæ¸¬è©¦ (2åˆ†é˜)**
```bash
# æ¸¬è©¦ç”Ÿæˆå™¨é…ç½®æª¢æ¸¬
py -c "
from utils.core.registry import registry
import generators  # ç¢ºä¿è¨»å†Š
config_info = registry.get_generator_with_config_info('é¡åˆ¥', 'å­é¡åˆ¥')
print('âœ… é…ç½®æª¢æ¸¬æˆåŠŸ:', config_info['has_config'])
print('æ§ä»¶é¡å‹:', config_info['config_schema']['field']['type'])
"
```

#### **C3: UIå•Ÿå‹•æ¸¬è©¦ (2åˆ†é˜)**
```bash
# å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼æª¢æŸ¥ç„¡éŒ¯èª¤
python main.py
```

---

## ğŸ“š **å¯¦éš›ç”Ÿæˆå™¨é…ç½®ç¯„ä¾‹**

### **TrigonometricFunctionGenerator**
```python
@classmethod
def get_config_schema(cls) -> Dict[str, Dict[str, Any]]:
    return {
        "function_scope": {
            "type": "select",
            "label": "å‡½æ•¸ç¯„åœ",
            "default": "basic",
            "options": ["basic", "extended"],
            "description": "basic(sin,cos,tan) vs extended(+cot,sec,csc)"
        },
        "angle_mode": {
            "type": "select",
            "label": "è§’åº¦æ¨¡å¼",
            "default": "degree",
            "options": ["degree", "radian", "mixed"],
            "description": "degree(è§’åº¦åˆ¶) radian(å¼§åº¦åˆ¶) mixed(æ··åˆ)"
        }
    }
```

### **TrigAngleConversionGenerator**
```python
@classmethod
def get_config_schema(cls):
    return {
        "mode_weights": {
            "type": "percentage_group",
            "label": "é¡Œå‹æ¯”ä¾‹åˆ†é…",
            "description": "èª¿æ•´ä¸‰ç¨®é¡Œå‹çš„å‡ºç¾é »ç‡ï¼Œç¸½å’Œè‡ªå‹•ä¿æŒç‚º100%",
            "items": {
                "original": {"label": "0~90Â°è½‰æ›", "default": 70},
                "formula": {"label": "å…¬å¼å•ç­”", "default": 10},
                "narrow_angle": {"label": "0~45Â°è½‰æ›", "default": 20}
            }
        },
        "angle_range": {
            "type": "select",
            "label": "è§’åº¦ç¯„åœ",
            "options": ["basic", "extended"],
            "default": "basic",
            "description": "basic(-80Â°~260Â°)ï¼Œextended(åŸºç¤è§’åº¦+n*360Â°)"
        }
    }
```

### **DoubleRadicalSimplificationGenerator**
```python
@classmethod
def get_config_schema(cls) -> Dict[str, Dict[str, Any]]:
    return {
        "max_value": {
            "type": "number_input",
            "label": "æ•¸å€¼ä¸Šé™",
            "default": 25,
            "min": 5,
            "max": 100,
            "description": "æ§åˆ¶ç”Ÿæˆç­”æ¡ˆæ•¸å­—çš„æœ€å¤§å€¼"
        }
    }
```

---

## ğŸ§ª **å¯¦æ–½é©—è­‰æª¢æŸ¥æ¸…å–®**

### **ConfigUIFactory æ“´å±•æª¢æŸ¥**
- [ ] PyQt æ§ä»¶å·²æ­£ç¢ºå°å…¥
- [ ] æ¨¡çµ„å’Œé¡åˆ¥æ–‡æª”å·²æ›´æ–°
- [ ] æ§ä»¶å‰µå»ºåˆ†æ”¯å·²æ–°å¢
- [ ] `_create_xxx_widget` æ–¹æ³•å·²å¯¦ç¾
- [ ] åƒæ•¸é©—è­‰é‚è¼¯å®Œæ•´
- [ ] å€¼æ”¶é›†é‚è¼¯å·²æ–°å¢

### **ç”Ÿæˆå™¨æ•´åˆæª¢æŸ¥**
- [ ] `get_config_schema` æ–¹æ³•å·²å¯¦ç¾
- [ ] schema æ ¼å¼ç¬¦åˆè¦ç¯„
- [ ] `has_config()` è¿”å› True
- [ ] è¨»å†Šç³»çµ±æ­£ç¢ºæª¢æ¸¬é…ç½®

### **åŠŸèƒ½æ¸¬è©¦æª¢æŸ¥**
- [ ] æ§ä»¶å‰µå»ºæ¸¬è©¦é€šé
- [ ] å€¼æ”¶é›†æ¸¬è©¦é€šé
- [ ] è¨»å†Šç³»çµ±æ•´åˆæ¸¬è©¦é€šé
- [ ] UIå•Ÿå‹•ç„¡éŒ¯èª¤æˆ–è­¦å‘Š

### **ä»£ç¢¼å“è³ªæª¢æŸ¥**
- [ ] èªæ³•æª¢æŸ¥é€šé
- [ ] éµå¾ªç¾æœ‰ä»£ç¢¼é¢¨æ ¼
- [ ] éŒ¯èª¤è™•ç†æ©Ÿåˆ¶å®Œæ•´
- [ ] æ–‡æª”è¨»é‡‹æ¸…æ¥šå®Œæ•´

---

## ğŸ” **æ¶æ§‹é‡é»èªªæ˜**

### **ConfigUIFactory æ¶æ§‹**
```python
class ConfigUIFactory:
    def create_widget_from_schema(schema) -> QWidget:
        """æ ¹æ“šschemaè‡ªå‹•ç”ŸæˆUIæ§ä»¶"""

    def _create_field_widget(field_name, config) -> QWidget:
        """ç‚ºå–®ä¸€é…ç½®é …å‰µå»ºæ§ä»¶"""

    def _create_select_widget(config) -> QComboBox:
        """å‰µå»ºä¸‹æ‹‰é¸æ“‡æ§ä»¶"""

    def _create_checkbox_widget(config) -> QCheckBox:
        """å‰µå»ºå‹¾é¸æ¡†æ§ä»¶"""

    def _create_percentage_group_widget(config) -> QPushButton:
        """å‰µå»ºç™¾åˆ†æ¯”åˆ†é…æ§ä»¶"""

    def _create_number_input_widget(config) -> QSpinBox:
        """å‰µå»ºæ•¸å­—è¼¸å…¥æ§ä»¶"""
```

### **ConfigValueCollector æ¶æ§‹**
```python
class ConfigValueCollector:
    def collect_values(config_widget, schema) -> Dict[str, Any]:
        """å¾UIæ§ä»¶æ”¶é›†é…ç½®å€¼"""

    def _extract_field_value(container, field_name, config) -> Any:
        """æå–å–®ä¸€æ¬„ä½çš„å€¼"""
```

### **ç”Ÿæˆå™¨è¨»å†Šæµç¨‹**
```
1. ç”Ÿæˆå™¨å¯¦ç¾ get_config_schema()
2. åŸºé¡çš„ has_config() æª¢æŸ¥æ˜¯å¦æœ‰é…ç½®
3. è¨»å†Šç³»çµ±çš„ get_generator_with_config_info() ç²å–é…ç½®è³‡è¨Š
4. CategoryWidget ä½¿ç”¨ ConfigUIFactory å‰µå»ºUI
5. ç”¨æˆ¶é…ç½®å¾Œä½¿ç”¨ ConfigValueCollector æ”¶é›†å€¼
6. é…ç½®å€¼å‚³éçµ¦ç”Ÿæˆå™¨çš„ __init__(options)
```

---

## ğŸ“ **æœ€ä½³å¯¦è¸å»ºè­°**

### **æ§ä»¶è¨­è¨ˆåŸå‰‡**
1. **ç°¡å–®å„ªå…ˆ**: èƒ½ç”¨ select å°±ä¸ç”¨è¤‡é›œæ§ä»¶
2. **ç”¨æˆ¶å‹å–„**: label è¦è®“æ•™å¸«ä¸€çœ‹å°±æ‡‚
3. **åˆç†é è¨­**: default æ‡‰è©²æ˜¯æœ€å¸¸ç”¨çš„é¸é …
4. **é©ç•¶èªªæ˜**: description è§£é‡‹é¸é …çš„å¯¦éš›å½±éŸ¿

### **åƒæ•¸é©—è­‰åŸå‰‡**
1. **åš´æ ¼é©—è­‰**: æ‰€æœ‰å¿…éœ€åƒæ•¸éƒ½è¦æª¢æŸ¥
2. **æ¸…æ¥šéŒ¯èª¤**: éŒ¯èª¤è¨Šæ¯è¦æŒ‡å‡ºå…·é«”å•é¡Œ
3. **é‚è¼¯æª¢æŸ¥**: åƒæ•¸é–“çš„é‚è¼¯é—œä¿‚è¦é©—è­‰
4. **é¡å‹å®‰å…¨**: ä½¿ç”¨ isinstance ç¢ºä¿é¡å‹æ­£ç¢º

### **ä»£ç¢¼ç¶­è­·åŸå‰‡**
1. **æ¨¡å¼ä¸€è‡´**: éµå¾ªç¾æœ‰æ§ä»¶çš„å¯¦ç¾æ¨¡å¼
2. **æ–‡æª”å®Œæ•´**: æ¯å€‹æ–¹æ³•éƒ½è¦æœ‰æ¸…æ¥šçš„docstring
3. **æ¸¬è©¦è¦†è“‹**: æ¯å€‹æ–°æ§ä»¶éƒ½è¦æœ‰å°æ‡‰æ¸¬è©¦
4. **å‘å¾Œå…¼å®¹**: æ–°åŠŸèƒ½ä¸èƒ½å½±éŸ¿ç¾æœ‰åŠŸèƒ½

---

**ç‹€æ…‹**: âœ… **å·²å®Œæˆ** - åŸºæ–¼ number_input å¯¦éš›å¯¦ç¾ç¶“é©—ç·¨å¯«
**é©ç”¨ç¯„åœ**: æ‰€æœ‰éœ€è¦åœ¨ ConfigUIFactory ä¸­æ–°å¢æ§ä»¶é¡å‹çš„é–‹ç™¼å·¥ä½œ
**æ›´æ–°æ—¥æœŸ**: 2025-09-29
**å¯¦æˆ°é©—è­‰**: number_input æ§ä»¶å®Œæ•´å¯¦æ–½æµç¨‹å·²é©—è­‰é€šé