# ConfigFactory 控件擴展實施指南

> **文檔**: 數學測驗生成器 ConfigFactory 控件擴展實施指南
> **創建日期**: 2025-09-29
> **狀態**: ✅ **已完成**
> **目的**: 為工程師提供在 ConfigUIFactory 中新增控件類型的完整實施流程

## 🎯 **設計原則**

### **核心理念**
- **實用為先**: 只實現實際需要的控件類型
- **嚴格驗證**: 所有配置必須符合規範，錯誤格式立即拋出異常
- **向後兼容**: 新控件不影響現有功能
- **易於維護**: 遵循現有模式，保持代碼一致性

---

## 📋 **目前已實現的控件類型**

### **1. select - 下拉選擇框 (QComboBox)**

#### **格式定義**
```python
{
    "type": "select",
    "label": "顯示標籤",
    "default": "預設選項",
    "options": ["選項1", "選項2", "選項3"],  # 必需
    "description": "可選的詳細說明"
}
```

#### **實際使用範例**
```python
# 來自 TrigonometricFunctionGenerator
"function_scope": {
    "type": "select",
    "label": "函數範圍",
    "default": "basic",
    "options": ["basic", "extended"],
    "description": "basic(sin,cos,tan) vs extended(+cot,sec,csc)"
},
"angle_mode": {
    "type": "select",
    "label": "角度模式",
    "default": "degree",
    "options": ["degree", "radian", "mixed"],
    "description": "degree(角度制) radian(弧度制) mixed(混合)"
}
```

#### **驗證規則**
- ✅ `options` 必需，且為非空列表
- ✅ `default` 必需，且必須在 `options` 中

---

### **2. checkbox - 勾選框 (QCheckBox)**

#### **格式定義**
```python
{
    "type": "checkbox",
    "label": "顯示標籤",
    "default": True | False,
    "description": "可選的詳細說明"
}
```

#### **驗證規則**
- ✅ `default` 必需，且為布林值

---

### **3. percentage_group - 百分比分配對話框 (QPushButton + PercentageConfigDialog)**

#### **格式定義**
```python
{
    "type": "percentage_group",
    "label": "組合標籤",
    "description": "詳細說明",
    "items": {
        "item1_key": {
            "label": "項目1標籤",
            "default": 數字值
        },
        "item2_key": {
            "label": "項目2標籤",
            "default": 數字值
        }
        # ... 更多項目
    }
}
```

#### **實際使用範例**
```python
# 來自 TrigAngleConversionGenerator
"mode_weights": {
    "type": "percentage_group",
    "label": "題型比例分配",
    "description": "調整三種題型的出現頻率，總和自動保持為100%",
    "items": {
        "original": {
            "label": "0~90°轉換",
            "default": 70
        },
        "formula": {
            "label": "公式問答",
            "default": 10
        },
        "narrow_angle": {
            "label": "0~45°轉換",
            "default": 20
        }
    }
}
```

#### **驗證規則**
- ✅ `items` 必需，且至少包含2個項目
- ✅ 所有項目的 `default` 總和必須等於100
- ✅ 所有項目必須包含 `label` 和 `default`

---

### **4. number_input - 數字輸入框 (QSpinBox)**

#### **格式定義**
```python
{
    "type": "number_input",
    "label": "顯示標籤",
    "default": 數字值,
    "min": 最小值,     # 必需
    "max": 最大值,     # 必需
    "description": "可選的詳細說明"
}
```

#### **實際使用範例**
```python
# 來自 DoubleRadicalSimplificationGenerator
"max_value": {
    "type": "number_input",
    "label": "數值上限",
    "default": 25,
    "min": 5,
    "max": 100,
    "description": "控制生成答案數字的最大值"
}
```

#### **驗證規則**
- ✅ `default`, `min`, `max` 必需，且為數字類型
- ✅ `min` < `max`
- ✅ `min` ≤ `default` ≤ `max`

---

## 🔧 **新增控件類型的完整實施流程**

基於 number_input 的實際實現經驗，以下是完整的8步驟流程：

### **Phase A: ConfigUIFactory 擴展**

#### **A1: 導入 PyQt 控件 (1分鐘)**
**檔案**: `utils/ui/config_factory.py` 第30行
```python
# 在現有導入中新增控件
from PyQt5.QtWidgets import QWidget, QVBoxLayout, QHBoxLayout, QLabel, QComboBox, QCheckBox, QPushButton, QSpinBox, 新控件類型
```

#### **A2: 更新模組文檔 (1分鐘)**
**檔案**: `utils/ui/config_factory.py` 第12行
```python
# 在支援控件類型列表中新增
- 支援控件類型：select(下拉框)、checkbox(勾選框)、percentage_group(百分比分配)、number_input(數字輸入框)、新控件類型(說明)
```

#### **A3: 更新 ConfigUIFactory 類別文檔 (1分鐘)**
**檔案**: `utils/ui/config_factory.py` 第44-48行
```python
# 在支援的控件類型中新增
- 新控件類型: 說明（對應的PyQt控件）
```

#### **A4: 新增控件創建分支 (2分鐘)**
**檔案**: `utils/ui/config_factory.py` 第147-157行
```python
# 在現有 elif 分支後新增
elif control_type == "新控件類型":
    control = self._create_新控件類型_widget(config)
```

#### **A5: 實現控件創建方法 (8-15分鐘)**
**檔案**: `utils/ui/config_factory.py`
```python
def _create_新控件類型_widget(self, config: Dict[str, Any]) -> 對應PyQt控件:
    """創建新控件類型

    Args:
        config: 必須包含特定參數

    Returns:
        對應PyQt控件: 配置好的控件實例

    Raises:
        ValueError: 配置參數錯誤
    """
    # 1. 驗證必需參數
    required_fields = ['field1', 'field2']
    for field in required_fields:
        if field not in config:
            raise ValueError(f"新控件類型必須提供{field}參數")

    # 2. 提取並驗證參數
    # 3. 創建 PyQt 控件
    # 4. 設定控件屬性
    # 5. 返回控件
```

#### **A6: 新增值收集邏輯 (2分鐘)**
**檔案**: `utils/ui/config_factory.py` 第487-502行
```python
# 在現有 elif 分支後新增
elif control_type == "新控件類型" and isinstance(control, 對應PyQt控件):
    return control.獲取值的方法()
```

### **Phase B: 生成器配置實現**

#### **B1: 實現 get_config_schema 方法 (5-8分鐘)**
**檔案**: 目標生成器檔案
```python
@classmethod
def get_config_schema(cls) -> Dict[str, Dict[str, Any]]:
    """取得生成器配置描述，供UI動態生成配置介面"""
    return {
        "config_field": {
            "type": "新控件類型",
            "label": "顯示標籤",
            "default": 預設值,
            # 其他必需參數
            "description": "說明文字"
        }
    }
```

### **Phase C: 整合測試**

#### **C1: 基本功能測試 (3分鐘)**
```bash
# 測試控件創建
py -c "
from utils.ui.config_factory import ConfigUIFactory
factory = ConfigUIFactory()
schema = {'test': {'type': '新控件類型', ...}}
widget = factory.create_widget_from_schema(schema)
print('✅ 控件創建成功')
"

# 測試值收集
py -c "
from utils.ui.config_factory import ConfigValueCollector
collector = ConfigValueCollector()
values = collector.collect_values(widget, schema)
print('✅ 值收集成功:', values)
"
```

#### **C2: 註冊系統整合測試 (2分鐘)**
```bash
# 測試生成器配置檢測
py -c "
from utils.core.registry import registry
import generators  # 確保註冊
config_info = registry.get_generator_with_config_info('類別', '子類別')
print('✅ 配置檢測成功:', config_info['has_config'])
print('控件類型:', config_info['config_schema']['field']['type'])
"
```

#### **C3: UI啟動測試 (2分鐘)**
```bash
# 啟動應用程式檢查無錯誤
python main.py
```

---

## 📚 **實際生成器配置範例**

### **TrigonometricFunctionGenerator**
```python
@classmethod
def get_config_schema(cls) -> Dict[str, Dict[str, Any]]:
    return {
        "function_scope": {
            "type": "select",
            "label": "函數範圍",
            "default": "basic",
            "options": ["basic", "extended"],
            "description": "basic(sin,cos,tan) vs extended(+cot,sec,csc)"
        },
        "angle_mode": {
            "type": "select",
            "label": "角度模式",
            "default": "degree",
            "options": ["degree", "radian", "mixed"],
            "description": "degree(角度制) radian(弧度制) mixed(混合)"
        }
    }
```

### **TrigAngleConversionGenerator**
```python
@classmethod
def get_config_schema(cls):
    return {
        "mode_weights": {
            "type": "percentage_group",
            "label": "題型比例分配",
            "description": "調整三種題型的出現頻率，總和自動保持為100%",
            "items": {
                "original": {"label": "0~90°轉換", "default": 70},
                "formula": {"label": "公式問答", "default": 10},
                "narrow_angle": {"label": "0~45°轉換", "default": 20}
            }
        },
        "angle_range": {
            "type": "select",
            "label": "角度範圍",
            "options": ["basic", "extended"],
            "default": "basic",
            "description": "basic(-80°~260°)，extended(基礎角度+n*360°)"
        }
    }
```

### **DoubleRadicalSimplificationGenerator**
```python
@classmethod
def get_config_schema(cls) -> Dict[str, Dict[str, Any]]:
    return {
        "max_value": {
            "type": "number_input",
            "label": "數值上限",
            "default": 25,
            "min": 5,
            "max": 100,
            "description": "控制生成答案數字的最大值"
        }
    }
```

---

## 🧪 **實施驗證檢查清單**

### **ConfigUIFactory 擴展檢查**
- [ ] PyQt 控件已正確導入
- [ ] 模組和類別文檔已更新
- [ ] 控件創建分支已新增
- [ ] `_create_xxx_widget` 方法已實現
- [ ] 參數驗證邏輯完整
- [ ] 值收集邏輯已新增

### **生成器整合檢查**
- [ ] `get_config_schema` 方法已實現
- [ ] schema 格式符合規範
- [ ] `has_config()` 返回 True
- [ ] 註冊系統正確檢測配置

### **功能測試檢查**
- [ ] 控件創建測試通過
- [ ] 值收集測試通過
- [ ] 註冊系統整合測試通過
- [ ] UI啟動無錯誤或警告

### **代碼品質檢查**
- [ ] 語法檢查通過
- [ ] 遵循現有代碼風格
- [ ] 錯誤處理機制完整
- [ ] 文檔註釋清楚完整

---

## 🔍 **架構重點說明**

### **ConfigUIFactory 架構**
```python
class ConfigUIFactory:
    def create_widget_from_schema(schema) -> QWidget:
        """根據schema自動生成UI控件"""

    def _create_field_widget(field_name, config) -> QWidget:
        """為單一配置項創建控件"""

    def _create_select_widget(config) -> QComboBox:
        """創建下拉選擇控件"""

    def _create_checkbox_widget(config) -> QCheckBox:
        """創建勾選框控件"""

    def _create_percentage_group_widget(config) -> QPushButton:
        """創建百分比分配控件"""

    def _create_number_input_widget(config) -> QSpinBox:
        """創建數字輸入控件"""
```

### **ConfigValueCollector 架構**
```python
class ConfigValueCollector:
    def collect_values(config_widget, schema) -> Dict[str, Any]:
        """從UI控件收集配置值"""

    def _extract_field_value(container, field_name, config) -> Any:
        """提取單一欄位的值"""
```

### **生成器註冊流程**
```
1. 生成器實現 get_config_schema()
2. 基類的 has_config() 檢查是否有配置
3. 註冊系統的 get_generator_with_config_info() 獲取配置資訊
4. CategoryWidget 使用 ConfigUIFactory 創建UI
5. 用戶配置後使用 ConfigValueCollector 收集值
6. 配置值傳遞給生成器的 __init__(options)
```

---

## 📝 **最佳實踐建議**

### **控件設計原則**
1. **簡單優先**: 能用 select 就不用複雜控件
2. **用戶友善**: label 要讓教師一看就懂
3. **合理預設**: default 應該是最常用的選項
4. **適當說明**: description 解釋選項的實際影響

### **參數驗證原則**
1. **嚴格驗證**: 所有必需參數都要檢查
2. **清楚錯誤**: 錯誤訊息要指出具體問題
3. **邏輯檢查**: 參數間的邏輯關係要驗證
4. **類型安全**: 使用 isinstance 確保類型正確

### **代碼維護原則**
1. **模式一致**: 遵循現有控件的實現模式
2. **文檔完整**: 每個方法都要有清楚的docstring
3. **測試覆蓋**: 每個新控件都要有對應測試
4. **向後兼容**: 新功能不能影響現有功能

---

**狀態**: ✅ **已完成** - 基於 number_input 實際實現經驗編寫
**適用範圍**: 所有需要在 ConfigUIFactory 中新增控件類型的開發工作
**更新日期**: 2025-09-29
**實戰驗證**: number_input 控件完整實施流程已驗證通過