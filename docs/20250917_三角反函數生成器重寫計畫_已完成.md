# 三角反函數生成器典範重寫工作計畫

> **目標**: 建立三角函數生成器開發典範，供其他開發者參考
> **制定日期**: 2025-09-17
> **基於生成器**: InverseTrigonometricFunctionGenerator
> **預期效果**: 從535行 → 180行，建立三角函數生成器標準模板

## 🎯 **重寫目標與原則**

### **核心目標**
1. **建立三角函數典範**: 為三角函數類生成器重寫提供標準模板
2. **修復過度工程化**: 移除535行中的Pydantic過度抽象，但保持教學正確性
3. **角度單位統一**: 移除弧度支援，專注角度運算
4. **教師友善**: 降低學習和維護成本，清晰的數學邏輯
5. **專業輸出**: 確保LaTeX格式正確編譯
6. **教學正確性**: 保持「特殊角→函數值→反函數題目」的正確教學邏輯

### **設計原則** (基於雙重根號成功經驗 + 註解標準理念)
1. **LaTeX模版化**: 正確格式，易於維護
2. **簡潔參數處理**: 移除Pydantic過度工程，使用options.get()
3. **清晰邏輯分離**: 數學邏輯與系統框架分開
4. **穩定異常處理**: 保留新版優勢，確保不崩潰
5. **Sphinx文檔友善**: 提供完整API文檔
6. **有效註解策略**: 防止「代碼說bug話」，自然語言與機器語言互相配合

## 📋 **具體改進項目**

### **A. 新增功能需求**

#### **A1. 年級分類系統** (仿照雙重根號成功實施)
- **需求**: 新增 `grade` 鍵，標註題目適用年級
- **年級定位**: 高一下學期 (G10S2) - 三角反函數適用年級
- **編碼格式**: `G10S2` (簡潔格式，適合系統處理)
- **實施方式**: 在 `_get_standard_metadata()` 中添加
- **參考**: 雙重根號生成器的成功實施經驗

#### **A2. 教學邏輯修正** (重要發現)
- **問題**: 當前實現邏輯錯誤，直接選擇函數值而非從特殊角開始
- **正確邏輯**: 舊版本的教學邏輯是正確的
  1. 先選擇特殊角度 (30°, 45°, 60°等)
  2. 計算對應的三角函數值 (如sin(30°) = 0.5)
  3. 生成反函數題目 (sin⁻¹(0.5) = ?)
  4. 調整角度到反函數值域內
- **保留要素**: `special_angles`列表、`_adjust_angle_to_range()`方法

#### **A3. 台灣教育習慣的函數表示法** (重要)
- **問題**: 使用arcsin表示法不符合台灣高中教育習慣
- **修正**: 採用sin⁻¹表示法
  ```python
  # ✅ 台灣高中教育習慣
  self.func_name_map = {
      "sin": "\\sin^{-1}",
      "cos": "\\cos^{-1}",
      "tan": "\\tan^{-1}"
  }
  # 題目範例: $\sin^{-1}(0.5) = $
  ```

#### **A4. Sphinx友善文檔** (完全仿照雙重根號格式)
- **當前問題**: docstring 不符合Sphinx標準
- **改進方向**: 完全仿照雙重根號生成器的文檔格式
  ```python
  """三角反函數題目生成器

  生成特殊角的三角反函數計算練習題目，採用台灣高中教育習慣的sin⁻¹表示法。

  Args:
      options (Dict[str, Any], optional): 生成器配置選項
          functions (List[str]): 允許的函數類型，預設["sin", "cos", "tan"]
          difficulty (str): 題目難度等級，預設"MEDIUM"

  Returns:
      Dict[str, Any]: 包含題目、答案、解釋等完整資訊

  Example:
      >>> generator = InverseTrigonometricFunctionGenerator()
      >>> question = generator.generate_question()
      >>> print(question['question'])
      $\\sin^{-1}(\\frac{1}{2}) = $
  """
  ```

### **B. 問題修復項目**

#### **B1. 角度單位簡化** (新增重點)
- **問題**: 角度/弧度雙支援增加不必要複雜性
- **用戶需求**: "先不要支援弧度，以角度為主好了"
- **解決方案**: 移除 `AngleUnit` 枚舉，統一使用角度
- **效益**: 降低邏輯複雜度15行，提升維護性

#### **B2. 保留核心教學邏輯** (最重要修正)
- **問題**: 不能為了減少行數而破壞教學正確性
- **保留要素**:
  - `special_angles` 列表: 特殊角度定義
  - `_adjust_angle_to_range()` 方法: 值域調整邏輯
  - `func_name_map`: 台灣教育習慣的函數表示法
  - 角度→函數值→反函數的正確流程
- **移除的部分**:
  - `InverseTrigParams` 類別 (~100行)
  - `TrigFunction` 枚舉 (~20行)
  - 所有 `@validator` 裝飾器 (~80行)

#### **B3. Pydantic過度工程移除** (在保持教學正確性前提下)
- **膨脹比例**: 過度工程化，2.8倍代碼膨脹 (190→535行)
- **解決方案**: 改用簡單的 `options.get()` 方式 (仿照雙重根號成功經驗)
- **修正目標**: 約200-220行 (不強求180行，教學正確性優先)

#### **B4. 邏輯分散重新整合**
- **問題**: 原本清晰的數學邏輯被分解到多個類別中
- **影響**: 維護困難，理解成本高
- **解決方案**: 恢復舊版本190行的直接數學邏輯
- **參考**: 雙重根號生成器的邏輯清晰性，但保持教學正確性

### **C. LaTeX模版優化**

#### **C1. 現代Python + LaTeX最佳實踐** (基於場景適配原則)
- **核心原則**: 基礎招式處理簡單場景，複雜場景才用高級技術
- **實施策略**: 基於舊版本正確做法 + 現代f字串語法

  ```python
  # ✅ 正確的教學邏輯流程
  def generate_question(self):
      # 1. 先選擇函數類型
      func_name = random.choice(self.functions)

      # 2. 選擇特殊角度 (教學重點)
      if func_name == "tan":
          # 排除tan不存在的角度
          valid_angles = [a for a in self.special_angles if a % 180 != 90]
          angle_deg = random.choice(valid_angles)
      else:
          angle_deg = random.choice(self.special_angles)

      # 3. 計算對應的三角函數值
      angle_rad = sympy.rad(angle_deg)
      trig_func = getattr(sympy, func_name)
      value = trig_func(angle_rad)

      # 4. 調整到反函數值域內
      adjusted_angle = self._adjust_angle_to_range(angle_deg, func_name)

      # 5. 使用台灣教育習慣的表示法
      question = f"${self.func_name_map[func_name]}({latex(value)}) = $"
      answer = f"${adjusted_angle}^\\circ$"
  ```

#### **C2. LaTeX符號標準化** (實用導向)
- **標準化原則**: 防範Unicode誤用，確保正確性
  ```python
  # 在需要的地方定義常數 (不過度抽象)
  def _format_inverse_function(self, func_name):
      return f"\\{func_name}^{{-1}}"  # 直接返回LaTeX字串

  def _format_angle(self, degrees):
      return f"${degrees}^\\circ$"   # 現代f字串 + 雙反斜線
  ```

#### **C3. 技術選擇指南** (場景適配)
- **基礎招式適用場景**:
  - 字串內容固定，只替換數值
  - 變化點少於3個
  - 邏輯簡單直接

- **高級技術適用場景**:
  - 多種格式變化 (>5種)
  - 複雜的條件邏輯
  - 需要被非程式人員編輯的內容

- **實施原則**: **該用基礎招式的時候用基礎招式，該用華麗大招的時候用華麗大招**

## 📅 **實施階段劃分** (基於典範4-Phase結構)

### **Phase 1: 分析與設計** (預估15分鐘)
1. **詳細分析現有問題** (5分鐘)
   - 統計535行中各部分行數分布
   - 分析Pydantic過度抽象的具體位置
   - 確定角度/弧度雙支援的冗餘程度

2. **設計簡化架構** (7分鐘)
   - 設計options.get()參數處理方式 (參考雙重根號)
   - 確定三角函數專用LaTeX符號標準
   - 規劃年級分類系統 (G10S2)

3. **確定API設計** (3分鐘)
   - 設計Sphinx友善的docstring (完全仿照雙重根號格式)
   - 確定方法簽名和返回值
   - 添加詳盡註解計畫

### **Phase 2: 核心重寫** (預估30分鐘)
1. **建立基礎架構** (10分鐘)
   - 類定義和Sphinx友善docstring (完全仿照雙重根號)
   - `__init__` 方法簡化 (移除Pydantic，添加技術選擇說明)
   - 基本方法架構 (重點註解數學邏輯和邊界條件)

2. **實施數學邏輯簡化** (15分鐘)
   - 恢復舊版本190行的直接邏輯 (註解確保定義域/值域正確)
   - 移除所有Pydantic相關代碼 (註解說明工具選擇原因)
   - 實現角度單位統一處理 (註解防止弧度/角度混淆錯誤)

3. **LaTeX模版整合** (5分鐘)
   - 建立三角函數專用LaTeX標準 (註解防範Unicode誤用)
   - 實現模版填充邏輯 (註解說明f字串vs模板的選擇標準)

### **Phase 3: 功能完善** (預估20分鐘)
1. **年級系統整合** (7分鐘)
   - 實現年級分類邏輯 (G10S2)
   - 添加到元數據中
   - 測試分類正確性

2. **異常處理優化** (8分鐘)
   - 保留新版異常處理優勢 (註解說明新版本的價值)
   - 添加預設題目機制
   - 完善日誌系統

3. **典範化完善** (5分鐘)
   - 添加有效註解 (防止「代碼說bug話」，確保數學邏輯正確)
   - 確保代碼可作為其他三角函數生成器的參考
   - 檢查API完整性

### **Phase 4: 測試與驗證** (預估15分鐘)
1. **功能測試** (8分鐘)
   - 測試三種反函數類型正確性
   - 驗證LaTeX格式無誤
   - 檢查角度計算邏輯

2. **典範價值驗證** (4分鐘)
   - 確認代碼可讀性和可複製性
   - 檢查註解有效性 (是否防止「代碼說bug話」)
   - 驗證與雙重根號生成器風格一致性

3. **對比驗證** (3分鐘)
   - 與原版功能對比
   - 確認代碼行數減少 (535→180行, 66%減少)
   - 驗證性能無退化

## ✅ **成功標準定義**

### **量化指標** (修正後)
- [ ] **代碼行數**: 從535行減少到200-220行 (約60%減少，教學正確性優先)
- [ ] **類別簡化**: 從6個類別減少到1個核心類別
- [ ] **參數處理**: 從230行Pydantic代碼減少到10行以內
- [ ] **測試通過率**: 100%通過功能和格式測試
- [ ] **教學正確性**: 確保特殊角→函數值→反函數的邏輯正確

### **質性檢查**
- [ ] **LaTeX格式**: 無HTML標籤，正確LaTeX語法
- [ ] **角度統一**: 移除弧度支援，統一角度處理
- [ ] **文檔品質**: Sphinx能正確生成API文檔
- [ ] **教師友善**: 代碼易讀，參數易改
- [ ] **年級分類**: 正確標註適用年級 (G10S2)
- [ ] **台灣教育習慣**: 使用sin⁻¹表示法而非arcsin
- [ ] **特殊角練習**: 確保所有題目都基於特殊角度生成

### **典範價值**
- [ ] **架構清晰**: 其他三角函數開發者可輕鬆理解
- [ ] **可複製性**: 可作為其他三角函數生成器重寫模板
- [ ] **最佳實踐**: 展示三角函數LaTeX處理正確做法
- [ ] **維護性**: 後續修改和擴展容易
- [ ] **註解有效**: 防止「代碼說bug話」，確保數學邏輯正確性

## 🔍 **風險評估與控制**

### **主要風險** (修正後)
1. **教學邏輯破壞**: 為了減少行數而破壞正確的數學教學邏輯
2. **特殊角映射**: 確保特殊角的輸入值和輸出角度映射正確
3. **值域調整**: `_adjust_angle_to_range()`邏輯的正確保留
4. **LaTeX格式**: 避免Unicode符號誤用，確保正確的數學符號顯示

### **風險控制措施**
1. **參考舊版本**: 舊版本190行已證實可行，直接參考其邏輯
2. **分步驗證**: 每個Phase完成後立即測試
3. **與雙重根號對比**: 持續參考已成功的雙重根號生成器經驗

## 📚 **參考資料**

### **最佳實踐參考**
- `DoubleRadicalSimplificationGenerator`: LaTeX模版化和Sphinx文檔標準
- `archived/InverseTrigonometricFunctionGenerator`: 190行簡潔邏輯參考
- 雙重根號典範重寫工作計畫: 成功的重寫方法論
- `docs/20250916_代碼註解標準與規範_已完成.md`: 防止「代碼說bug話」註解標準

### **技術標準**
- Sphinx文檔格式標準 (完全仿照雙重根號)
- LaTeX三角函數符號最佳實踐 (參考防範Unicode誤用機制)
- 有效註解策略: 自然語言與機器語言互相配合
- Python代碼風格指南

### **相關計畫**
- 本計畫將整合 `20250917_防範Unicode誤用機制實施計畫_研擬中.md`
- 在Phase 2實施過程中示範正確的LaTeX符號使用
- 作為防範Unicode誤用的典範實作案例
- 實踐代碼註解標準的有效註解原則

---

## 📝 **計畫更新記錄**

**2025-09-17 重大修正**:
- **教學邏輯修正**: 發現並修正設計初心理解錯誤
- **保留核心要素**: special_angles、_adjust_angle_to_range()、func_name_map
- **台灣教育習慣**: 採用sin⁻¹表示法而非arcsin
- **目標調整**: 200-220行 (教學正確性優先，不強求180行)
- **風險控制**: 教學邏輯破壞列為主要風險

**2025-09-17 初始更新**:
- **註解策略修正**: 整合「代碼會說bug話」理念
- **註解標準**: 採用自然語言與機器語言互相配合原則
- **重點調整**: 從「詳盡註解」改為「有效註解」
- **新增參考**: 代碼註解標準與規範文檔

## 🏆 **實施完成總結**

**重構狀態**: ✅ 基本實施完成 (2025-09-18)
**代碼行數**: 534行 → 247行 (減少54%)
**功能驗證**: ✅ 教學邏輯正確，符合台灣教育習慣

### **✅ 成功達成的目標**
1. **教學邏輯正確性**: 保留特殊角→函數值→反函數的正確流程
2. **台灣教育習慣**: 採用sin⁻¹表示法，修正主類別為"三角函數"
3. **移除過度工程化**: 移除Pydantic類別和複雜枚舉
4. **新架構整合**: get_logger()、年級分類G10S2
5. **難度簡化**: 固定"MEDIUM"，作為備用鍵值

### **✅ 已修復的問題**
1. **LaTeX轉義**: ✅ 已完成系統性修復，所有度數符號正確顯示
2. **解釋格式**: ✅ explanation的LaTeX格式已調整完成

### **🔧 剩餘待處理項目**
1. **分類一致性**: 主類別從"三角比"改為"三角函數"需要驗證一致性
2. **邊界情況**: 特殊角度範圍的邊界處理驗證
3. **文檔完善**: 部分註解可以更精確

### **📈 典範價值確立**
- **教學優先原則**: 不為行數優化而破壞教學正確性
- **適度簡化**: 移除過度工程化但保留核心邏輯
- **文化適應**: 符合台灣高中教育習慣
- **架構整合**: 新舊架構優勢結合的成功範例

**當前狀態**: ✅ 核心功能完成，LaTeX格式問題已解決
**下一步**: 處理剩餘的分類一致性和邊界情況驗證

---

## 🔧 **LaTeX格式標準化修復計畫**

> **附屬計畫**: LaTeX轉義問題系統性修復
> **優先級**: 高 - 影響PDF輸出品質
> **預估修復時間**: 15分鐘
> **風險級別**: 低 - 僅影響格式顯示

### **問題總覽**

經用戶指出，當前實施中存在嚴重的LaTeX轉義過度問題：

**核心問題**: 雙反斜線使用錯誤，如 `"sin": "$[-90^\\\\circ, 90^\\\\circ]$"` 會在PDF中產生可怕的顯示效果

### **修復範圍識別**

#### **Priority 1: 過度轉義修復**
```python
# 修復位置1: value_ranges字典 (73-76行)
"sin": "$[-90^\\\\circ, 90^\\\\circ]$"  # ❌ 雙反斜線
→ "sin": "$[-90^\\circ, 90^\\circ]$"    # ✅ 單反斜線

# 修復位置2: 答案生成 (119行)
f"${adjusted_angle}^\\\\circ$"          # ❌ 雙反斜線
→ f"${adjusted_angle}^\\circ$"          # ✅ 單反斜線

# 修復位置3: 解釋步驟 (205-207行)
f"$\\\\{func_name}({adjusted_angle}^\\\\circ) = ..."  # ❌ 雙反斜線
→ f"$\\{func_name}({adjusted_angle}^\\circ) = ..."   # ✅ 單反斜線

# 修復位置4: 預設題目 (223-229行)
"$30^\\\\circ$"                        # ❌ 雙反斜線
→ "$30^\\circ$"                        # ✅ 單反斜線
```

#### **Priority 2: 換行格式保持**
```python
# 保持正確: LaTeX換行使用雙反斜線
"\\\\[0.3em]"                          # ✅ 正確的換行格式
```

### **修復原則確立**

1. **度數符號**: `^\\circ` (單反斜線)
2. **數學函數**: `\\sin`, `\\cos`, `\\tan` (單反斜線)
3. **分數格式**: `\\frac{分子}{分母}` (單反斜線)
4. **LaTeX換行**: `\\\\[0.3em]` (雙反斜線，這是正確的)

### **驗證方法**

修復完成後進行：
1. **生成測試**: 產生範例題目檢查LaTeX格式
2. **PDF編譯測試**: 確認度數符號正確顯示
3. **解釋格式驗證**: 確認換行和符號格式無誤

### **修復步驟摘要**

1. **Step 1**: 修復 `value_ranges` 字典的度數符號轉義
2. **Step 2**: 修復答案生成的度數符號轉義
3. **Step 3**: 修復解釋步驟的函數名和度數符號轉義
4. **Step 4**: 修復預設題目的所有LaTeX轉義
5. **Step 5**: 功能測試驗證修復效果

### **預期成果**

- **視覺改善**: PDF中度數符號正確顯示為 °
- **一致性**: 所有LaTeX符號使用統一的轉義標準
- **維護性**: 建立清楚的LaTeX轉義規範供未來參考
- **典範價值**: 為其他生成器提供正確的LaTeX格式化範例

**✅ 修復已完成** (2025-09-18):

### **修復成果摘要**

| 修復項目 | 位置 | 修復狀態 |
|---------|------|---------|
| value_ranges字典 | 73-76行 | ✅ 已修復 |
| 答案生成 | 119行 | ✅ 已修復 |
| 解釋步驟 | 205,207行 | ✅ 已修復 |
| 預設題目 | 223-229行 | ✅ 已修復 |

### **修復驗證**
- **功能測試**: ✅ 通過
- **LaTeX格式**: ✅ 度數符號正確顯示為 `°`
- **生成範例**: ✅ `$\tan^{-1}(- \sqrt{3}) = -60°$`
- **解釋格式**: ✅ 換行和符號格式正確

### **建立的標準**
- **度數符號**: 使用 `^\\circ` (單反斜線)
- **數學函數**: 使用 `\\sin`, `\\cos`, `\\tan` (單反斜線)
- **LaTeX換行**: 保持 `\\\\[0.3em]` (雙反斜線，正確)
- **函數上標**: 保持 `^{-1}` (括號正確)

**典範價值**: 為其他生成器建立了正確的LaTeX轉義標準