# 二次函數生成器配圖修正計畫

- **計畫編號**: 20251020-Fix-QuadExtremum-Figure
- **建立日期**: 2025-10-20
- **審核**: Gemini (初版) → Claude (精簡版)
- **狀態**: 研擬中

## 1. 目標

對 `generators/algebra/quadratic_extremum.py` 生成器進行精準修正，解決配圖顯示問題並統一文檔規範。主要目標包括：
1. 修正詳解配圖未能正確顯示的架構問題（P0）
2. 統一題目尺寸文檔與實作的一致性（P3）

**設計原則**：
- 聚焦實際功能問題，避免過度工程化
- 遵循「基礎招式 vs 華麗大招」適配原則
- 保持代碼簡潔和教師友善性

## 2. 問題分析與改善項目

經檢視並驗證，確認以下需要修正的問題：

### P0 (最高優先級) - 配圖顯示不符合架構規範
- **問題描述**:
  - 圖形資料透過**直接注入** `figure_data_explanation` 鍵到回傳字典（247行、306行）
  - 未按框架設計覆寫 `get_figure_data_explanation()` 標準方法
- **實際影響**: 違反框架設計，導致圖形無法被系統正確處理和顯示
- **修正必要性**: ✅ 必須修正（核心功能失效）

### P3 (文檔一致性) - 題目尺寸文檔不一致
- **問題描述**:
  - Docstring 94行註記題目尺寸為 `SQUARE`
  - `get_question_size()` 方法 835行實際回傳 `MEDIUM`
- **實際影響**: 對維護者造成困惑
- **修正必要性**: ✅ 應該修正（保持文檔準確性）

---

### 不執行的建議項目（經評估後排除）

**~~P1 - 引入 Sympy 進行 LaTeX 格式化~~** ❌ 不執行
- **原因**:
  - 邊界情況已驗證無問題，現有手動拼接代碼穩健
  - 引入 Sympy 違反「基礎招式 vs 華麗大招」適配原則（簡單格式化不需重量級數學庫）
  - 保持教師友善性：現有代碼邏輯直觀易懂
- **結論**: 保持現狀，無需重構

**~~P2 - 模板組織方式優化~~** ⏸️ 暫緩
- **原因**:
  - 模組級別常數對靜態模板是標準做法
  - 改進收益不明確，無明顯功能性問題
  - 遵循「不確定就不改」原則
- **結論**: 維持現狀，避免不必要的修改風險

## 3. 修正步驟

### 步驟 1: 修正配圖架構問題 (P0)

**目標**: 符合框架設計，讓配圖正確顯示

**具體動作**:

1. **在 `__init__` 方法中添加實例變數**（約138行附近）
   ```python
   def __init__(self, options: Dict[str, Any] = None):
       super().__init__(options)
       self.logger = get_logger(self.__class__.__name__)
       self._figure_params = None  # ← 新增：用於暫存繪圖參數
   ```

2. **覆寫 `get_figure_data_explanation()` 方法**（約869行附近，`_generate_schematic_figure` 方法之後）
   ```python
   def get_figure_data_explanation(self) -> dict:
       """取得詳解配圖資料

       Returns:
           dict: 圖形配置字典，若無配圖則返回 None
       """
       if self._figure_params is None:
           return None

       return self._generate_schematic_figure(**self._figure_params)
   ```

3. **修改 `_generate_global_extremum` 方法**（約242-248行）
   - 保存繪圖參數到 `self._figure_params`
   - 移除 `figure_data_explanation` 的直接注入
   ```python
   # 保存繪圖參數供 get_figure_data_explanation() 使用
   self._figure_params = {
       'question_type': 'global',
       'a': a,
       'h': h,
       'k': k
   }

   return {
       **self._get_core_content(question, answer, explanation),
       **self._get_standard_metadata()
       # 移除: 'figure_data_explanation': figure_data_explanation
   }
   ```

4. **修改 `_generate_interval_extremum` 方法**（約292-307行）
   - 同樣保存繪圖參數並移除直接注入
   ```python
   # 保存繪圖參數
   self._figure_params = {
       'question_type': question_type,
       'a': a,
       'h': h,
       'k': k,
       'x1': x1,
       'x2': x2
   }

   return {
       **self._get_core_content(question, answer, explanation),
       **self._get_standard_metadata()
       # 移除: 'figure_data_explanation': figure_data_explanation
   }
   ```

**驗證方法**:
- 執行應用程式生成二次函數極值題目
- 檢查詳解頁面是否正確顯示配圖
- 驗證全域極值和區間極值題型的配圖都能正常渲染

---

### 步驟 2: 修正文檔一致性 (P3)

**目標**: 統一題目尺寸為 `MEDIUM`

**具體動作**:

1. **修改 Docstring**（94行）
   ```python
   # 修改前:
   size (int): 題目顯示大小（SQUARE: 1x2）

   # 修改後:
   size (int): 題目顯示大小（MEDIUM）
   ```

**驗證方法**:
- 檢查文檔是否與實際返回值一致
- 確認 UI 顯示效果符合預期

## 4. 預期成果

### 修正後的改善

1. **配圖正常顯示** ✅
   - 詳解頁面能正確渲染二次函數拋物線示意圖
   - 全域極值、頂點在區間內、頂點在區間外三種情況的配圖都能正確顯示

2. **架構符合規範** ✅
   - 使用標準的 `get_figure_data_explanation()` 方法
   - 符合框架設計模式，便於系統統一處理

3. **文檔準確一致** ✅
   - Docstring 與實際實作一致
   - 避免維護者困惑

### 保持的優點

1. **代碼簡潔穩健**
   - 保持手動格式化的清晰邏輯（已驗證無邊界問題）
   - 無不必要的依賴（不引入 Sympy）
   - 教師友善、易於理解和維護

2. **修改風險最小化**
   - 僅修正實際問題，不做不確定收益的重構
   - 遵循「不確定就不改」原則

---

## 5. 修正清單總結

| 項目 | 優先級 | 狀態 | 理由 |
|------|--------|------|------|
| P0: 配圖架構修正 | 最高 | ✅ 執行 | 核心功能失效，必須修復 |
| P3: 文檔統一為 MEDIUM | 中 | ✅ 執行 | 保持文檔準確性 |
| ~~P1: 引入 Sympy~~ | - | ❌ 不執行 | 現有代碼已驗證穩健，避免過度工程化 |
| ~~P2: 模板重組~~ | - | ⏸️ 暫緩 | 收益不明確，維持現狀 |

**修正原則**: 精準解決實際問題，避免不必要的重構，保持代碼的簡潔性和可維護性。