# 生成器配置UI整合工作計畫 (修正版)

> **專案**: 數學測驗生成器UI配置系統
> **制定日期**: 2025-09-20
> **狀態**: ✅ **已實施完成** (2025-09-23) - 固定配置策略成功實作
> **核心理念**: 最小風險 + 最大實用性

## 🎯 **核心發現與決策**

### **關鍵洞察**
1. **CategoryWidget是579行怪物檔案** - 複雜信號處理、父子關係邏輯
2. **Registry格式已經一致** - `(category, subcategory)` 對應 `"類別/子類別"`
3. **生成器數量還很少** - 只有4-5個，向後兼容成本低
4. **PyQt5確實很痛苦** - 但重寫整個UI成本更高

### **風險評估結果**
- **修改CategoryWidget**: 高風險 (上次重構失敗)
- **最小修改方案**: 低風險 (只改數據收集邏輯)
- **格式統一**: 無風險 (registry格式已配套)

## 🚀 **務實實施方案** (基於可行性分析優化)

### **✅ 階段1: 純後端配置支援** (已完成) - 配置傳遞流程建立成功

#### **1.1 題目分配器配置支援** (主要修改點)
```python
# utils/orchestration/question_distributor.py
# 修改 QuestionGenerator.generate_questions() 方法 (第80行開始)

for item in selected_data:
    topic = item.get('topic')
    count = item.get('count', 0)
    config = item.get('config', {})  # 新增：提取配置

    # 解析topic格式: "三角函數/三角函數值計算"
    category, subcategory = topic.split('/')
    generator = registry.get_generator(category, subcategory)

    for i in range(count):
        # 🎯 關鍵修改：第127行
        # 當前: generator_instance = generator()
        # 改為: generator_instance = generator(config)  # 傳遞配置
        generator_instance = generator(config)
        question_result = generator_instance.generate_question()
        # ... 其餘邏輯不變
```

#### **1.2 PDF協調器支援** (無需修改)
```python
# utils/orchestration/pdf_orchestrator.py
# 透過 question_distributor.generate_questions() 間接支援
# 只需確認 selected_data 格式正確傳遞
```

#### **1.2 生成器自描述基礎**
```python
# generators/base.py 添加配置描述
class QuestionGenerator:
    @classmethod
    def get_config_schema(cls):
        """生成器配置描述 - 預設無配置"""
        return {}

    @classmethod
    def has_config(cls):
        """檢查是否需要配置"""
        return bool(cls.get_config_schema())
```

#### **1.3 後端獨立測試** (新增 - 10分鐘)
```python
# 直接測試後端配置傳遞，繞過UI
def test_backend_config():
    """測試配置傳遞流程 - 無UI依賴"""
    from utils.orchestration.question_distributor import QuestionDistributor

    # 模擬UI傳遞的數據
    test_selected_data = [
        {
            "topic": "三角函數/三角函數值計算",
            "count": 2,
            "config": {"function_scope": "extended", "angle_mode": "radian"}
        }
    ]

    distributor = QuestionDistributor()
    questions = distributor.generate_questions(test_selected_data)

    # 驗證配置效果
    assert len(questions) == 2
    # 驗證extended模式和radian模式
```

### **✅ 階段2: 三角函數生成器更新** (已完成) - 配置接收與處理機制完善

#### **2.1 添加配置描述**
```python
# generators/trigonometry/TrigonometricFunctionGenerator.py
@classmethod
def get_config_schema(cls):
    return {
        "function_scope": {
            "type": "select",
            "options": ["basic", "extended"],
            "default": "basic",
            "label": "函數範圍",
            "description": "basic(3函數) vs extended(6函數)"
        },
        "angle_mode": {
            "type": "select",
            "options": ["degree", "radian", "mixed"],
            "default": "degree",
            "label": "角度模式",
            "description": "度數/弧度/混合顯示"
        }
    }
```

#### **2.2 實務參數重新命名** (核心修改)
```python
# 核心修改: difficulty → function_scope (解決概念混淆)
function_scope = options.get("function_scope", "basic")  # 替換原 difficulty 參數

# 簡單配置驗證
if function_scope not in ["basic", "extended"]:
    self.logger.warning(f"無效的function_scope: {function_scope}，使用預設值basic")
    function_scope = "basic"

# 直接應用 (邏輯不變，只改參數名)
self.functions = [sin, cos, tan, cot, sec, csc] if function_scope == "extended" else [sin, cos, tan]
```

#### **2.3 角度模式配置** (現有功能保持)
```python
# 角度模式邏輯保持不變
angle_mode = options.get("angle_mode", "degree")
if angle_mode not in ["degree", "radian", "mixed"]:
    self.logger.warning(f"無效的angle_mode: {angle_mode}，使用預設值degree")
    angle_mode = "degree"

self.angle_mode = angle_mode
```

#### **2.4 配置日誌追蹤** (新增)
```python
# 添加配置日誌追蹤
def __init__(self, options=None):
    super().__init__()
    self.logger = get_logger(self.__class__.__name__)

    # 記錄接收到的配置
    self.logger.info(f"三角函數生成器初始化，配置: {options}")

    # 處理配置...
    self.logger.info(f"最終配置 - function_scope: {function_scope}, angle_mode: {angle_mode}")
```

### **✅ 階段3: UI最小修改** (已完成) - 固定配置策略實作

#### **3.1 CategoryWidget配置收集**
```python
# ui/category_widget.py - 只修改 get_selected_data()
def get_selected_data(self):
    """獲取選擇數據，包含配置資訊"""
    selected_count = 0
    total_questions = 0
    selected_data = []

    for _, sub_cb, sub_spin, parent_cb in self.subcategory_widgets:
        if sub_cb.isChecked() and sub_spin.value() > 0:
            selected_count += 1
            total_questions += sub_spin.value()

            topic_name = f"{parent_cb.text()}/{sub_cb.text()}"
            count = sub_spin.value()

            topic_data = {"topic": topic_name, "count": count}

            # 新增：配置收集 (最小修改)
            config = self._get_topic_config(topic_name)
            if config:
                topic_data["config"] = config

            selected_data.append(topic_data)

    return selected_count, total_questions, selected_data

def _get_topic_config(self, topic_name: str) -> Dict[str, Any]:
    """獲取主題配置 - 固定配置驗證流程"""
    # 實務實現：固定配置確保穩定性
    if "三角函數值計算" in topic_name:
        return {"function_scope": "basic", "angle_mode": "degree"}
    return {}
```

#### **3.2 配置UI (此次不實施)**
```python
# 預留：未來可實施動態配置UI
# 本次使用固定配置，確保流程穩定性
# def show_config_dialog(self, topic_name):
#     # 簡單配置對話框實現...
```

### **✅ 階段4: 簡單驗證** (已完成) - 端對端測試通過

#### **4.1 實用驗證策略**
```python
def quick_validation():
    """快速驗證配置傳遞 - 能跑就是成功"""

    # 測試1: 有配置生成 (5分鐘)
    test_data_with_config = [{
        "topic": "三角函數/三角函數值計算",
        "count": 1,
        "config": {"function_scope": "extended", "angle_mode": "degree"}
    }]

    generator = QuestionGenerator()
    questions = generator.generate_questions(test_data_with_config)
    print(f"有配置生成: {len(questions)} 題")
    print(f"題目內容: {questions[0]['question']}")

    # 測試2: 無配置生成 - 確保向後兼容 (5分鐘)
    test_data_no_config = [{
        "topic": "三角函數/三角函數值計算",
        "count": 1
    }]

    questions_no_config = generator.generate_questions(test_data_no_config)
    print(f"無配置模式: {len(questions_no_config)} 題")

    # 測試3: 檢查日誌確認配置傳遞 (5分鐘)
    # 查看日誌輸出是否顯示配置被正確接收
```

#### **4.2 錯誤處理驗證**
```python
# 簡單錯誤處理測試
try:
    # 故意傳入錯誤配置
    bad_config = {"function_scope": "invalid"}
    gen = TrigonometricFunctionGenerator(bad_config)
    question = gen.generate_question()
    print("錯誤處理正常 - 自動回落到預設值")
except Exception as e:
    print(f"需要修正錯誤處理: {e}")
```

## ⚠️ **風險控制**

### **最小風險策略**
1. **不觸碰CategoryWidget核心邏輯** - 只修改數據收集
2. **向後兼容保證** - config字段可選，無配置時正常工作
3. **階段性實施** - 先固定配置，再考慮動態UI

### **已解決的偽風險**
- ❌ **格式不一致**: registry格式本來就配套
- ❌ **測試困難**: 直接堆參數測試即可
- ❌ **向後兼容**: 目前生成器少，統一修改成本低

## ✅ **實施成果** (2025-09-23 完成)

### **核心目標達成**
- ✅ 三角函數生成器支援function_scope和angle_mode配置
- ✅ 配置正確從UI傳遞到生成器 (固定配置策略)
- ✅ PDF生成包含配置後的題目效果
- ✅ 系統向後兼容，無配置的生成器正常工作

### **技術驗證完成**
- ✅ basic模式只生成sin/cos/tan題目 (固定配置預設值)
- ✅ 配置傳遞流程驗證成功
- ✅ 無配置生成器不受影響
- ⏳ extended模式和radian模式 (待動態UI實施後測試)

## 🔄 **完整參數傳遞流程**

### **確認的傳遞鏈**
1. **UI起點**: `CategoryWidget.get_selected_data()` → 包含config字段的selected_data
2. **PDF協調器**: `generate_pdf_with_progress()` → 透明傳遞selected_data
3. **題目分配器**: `QuestionGenerator.generate_questions()` → 提取config並傳遞給生成器
4. **生成器實例**: `TrigonometricFunctionGenerator(config)` → 接收並使用配置

### **關鍵修改點**
- **question_distributor.py**: 主要修改，提取config並傳遞給生成器
- **category_widget.py**: 最小修改，get_selected_data()加入config收集
- **生成器**: 添加get_config_schema()和參數重新命名

## 💡 **關鍵設計決策**

### **採用的方案**
- **生成器自描述**: 避免靜態配置檔案膨脹
- **透明傳遞**: PDF協調器無需修改，保持現有流程
- **最小UI修改**: 只改數據收集，不碰核心邏輯
- **固定配置開始**: 先驗證流程，再考慮動態UI

### **拒絕的方案**
- **分割CategoryWidget**: 風險太高，上次失敗
- **重寫UI框架**: 成本太高，收益不確定
- **複雜配置UI**: 過度設計，先簡單後複雜

---

**實施狀態**: ✅ **階段1-4已完成** (2025-09-23)
**實施策略**: 固定配置策略 + 最小風險修改 + 完整向後兼容
**實際時間**: 約90分鐘 (包含問題排查和測試驗證)
**風險等級**: 低 (成功避開CategoryWidget核心邏輯修改)

## 🔄 **下一階段: 動態配置UI** (待實施)

### **當前狀況**
- ✅ 後端配置支援完整建立
- ✅ 固定配置策略運作正常
- ⏳ 動態配置UI待開發 (原計畫階段3.2)

### **動態UI實施選項**
1. **簡單對話框方案**: 點擊題型時彈出配置對話框
2. **側邊欄配置面板**: 在右側新增配置區域
3. **內嵌配置控件**: 直接在題型選項下方加入配置選項

### **建議下一步**
- 評估用戶對配置UI的具體需求
- 選擇適合的UI實施方案
- 基於已建立的配置傳遞流程實作動態介面